{
  "phase": "before",
  "timestamp": "2026-01-16T17:51:09.554Z",
  "git_ref": "100f7496db17ec4918f74c0b2e7d05d3f519affe",
  "results": [
    {
      "id": "greenfield-game-engine",
      "name": "Greenfield: Game Engine",
      "timestamp": "2026-01-16T17:28:41.070Z",
      "duration_ms": 300169,
      "success": false,
      "spec_created": true,
      "task_count": 86,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# 2D Game Engine\n\nA TypeScript-based 2D game engine featuring sprite rendering, physics simulation, and input handling for browser-based games.\n\n## Goal\n\nCreate a modular, performant 2D game engine that provides:\n- Sprite rendering with animation support via Canvas2D\n- Physics simulation with collision detection and rigid body dynamics\n- Input handling for keyboard, mouse, and gamepad\n\n## Non-Goals\n\n- 3D rendering or WebGL (Canvas2D only)\n- Networked multiplayer\n- Audio system (can be added later)\n- Tile map editor or level editor\n- Asset pipeline or build-time processing\n\n## Architecture Overview\n\n```\nsrc/\n├── core/\n│   ├── Engine.ts          # Main game loop, system orchestration\n│   ├── Scene.ts           # Scene container and lifecycle\n│   ├── Entity.ts          # Entity with component storage\n│   └── EventBus.ts        # Pub/sub event system\n├── components/\n│   ├── Transform.ts       # Position, rotation, scale\n│   ├── Sprite.ts          # Static sprite rendering\n│   ├── Animator.ts        # Sprite animation\n│   ├── Collider.ts        # AABB and Circle colliders\n│   └── RigidBody.ts       # Physics body\n├── systems/\n│   ├── RenderSystem.ts    # Sprite rendering pipeline\n│   ├── PhysicsSystem.ts   # Physics simulation\n│   └── InputSystem.ts     # Input state management\n├── rendering/\n│   ├── Renderer.ts        # Canvas2D wrapper\n│   ├── Camera.ts          # Viewport and transforms\n│   └── SpriteSheet.ts     # Sprite atlas support\n└── index.ts               # Public API exports\n```\n\n## Tasks\n\n### Phase 1: Project Setup & Core Architecture\n\n**Task 1.1: Initialize TypeScript project**\n\nSet up the project with modern TypeScript tooling.\n\nFiles to create:\n- `package.json` - dependencies and scripts\n- `tsconfig.json` - strict TypeScript config\n- `vite.config.ts` - Vite bundler config\n- `vitest.config.ts` - test runner config\n- `src/index.ts` - entry point\n\nDependencies:\n- TypeScript 5.x\n- Vite 5.x (bundler + dev server)\n- Vitest (testing)\n\nAcceptance criteria:\n- [ ] `npm install` completes without errors\n- [ ] `npm run build` produces `dist/game-engine.js` (ES module)\n- [ ] `npm run build` produces `dist/game-engine.d.ts` (type definitions)\n- [ ] `npm run dev` starts dev server at http://localhost:5173\n- [ ] `npm test` runs Vitest and exits with code 0\n\n---\n\n**Task 1.2: Implement Engine class with game loop**\n\nCreate the core Engine class that manages the game loop using fixed timestep.\n\nFiles to create:\n- `src/core/Engine.ts`\n- `src/core/Engine.test.ts`\n\nImplementation details:\n```typescript\nclass Engine {\n  constructor(config: EngineConfig)\n  start(): void           // Begin game loop\n  stop(): void            // Pause game loop\n  addSystem(system: System): void\n  getTime(): { elapsed: number; delta: number }\n}\n\ninterface EngineConfig {\n  canvas: HTMLCanvasElement\n  fixedTimestep?: number  // Default: 1/60 (60 FPS physics)\n  maxFrameTime?: number   // Default: 0.25 (prevent spiral of death)\n}\n```\n\nGame loop requirements:\n- Use `requestAnimationFrame` for rendering\n- Fixed timestep for physics (accumulator pattern)\n- Interpolation value passed to render for smooth visuals\n- Cap accumulated time to prevent spiral of death\n\nAcceptance criteria:\n- [ ] Engine starts and calls update at ~60Hz\n- [ ] Engine stops cleanly without memory leaks\n- [ ] Fixed timestep maintains consistent physics rate\n- [ ] Unit tests verify loop timing behavior\n\n---\n\n**Task 1.3: Implement Entity-Component foundation**\n\nCreate the Entity class and component storage system.\n\nFiles to create:\n- `src/core/Entity.ts`\n- `src/core/Entity.test.ts`\n- `src/core/Component.ts`\n\nImplementation details:\n```typescript\nclass Entity {\n  readonly id: number\n  addComponent<T extends Component>(component: T): T\n  getComponent<T extends Component>(type: ComponentType<T>): T | undefined\n  hasComponent<T extends Component>(type: ComponentType<T>): boolean\n  removeComponent<T extends Component>(type: ComponentType<T>): void\n}\n\nabstract class Component {\n  entity: Entity | null\n  onAttach?(entity: Entity): void\n  onDetach?(): void\n}\n```\n\nAcceptance criteria:\n- [ ] Entity IDs are unique (auto-incrementing)\n- [ ] Components can be added, retrieved, and removed\n- [ ] Type-safe component access via generics\n- [ ] Unit tests for all component operations\n\n---\n\n**Task 1.4: Implement Scene management**\n\nCreate Scene class for organizing entities and managing lifecycle.\n\nFiles to create:\n- `src/core/Scene.ts`\n- `src/core/Scene.test.ts`\n\nImplementation details:\n```typescript\nclass Scene {\n  createEntity(): Entity\n  destroyEntity(entity: Entity): void\n  getEntities(): Entity[]\n  getEntitiesWithComponents(...types: ComponentType[]): Entity[]\n\n  onEnter?(): void   // Called when scene becomes active\n  onExit?(): void    // Called when scene is switched away\n  onUpdate?(dt: number): void\n}\n```\n\nEngine integration:\n```typescript\nengine.loadScene(scene: Scene): void\nengine.getCurrentScene(): Scene | null\n```\n\nAcceptance criteria:\n- [ ] Entities can be created and destroyed within scene\n- [ ] Scene lifecycle hooks fire correctly\n- [ ] Entity queries return correct results\n- [ ] Destroyed entities are fully cleaned up\n\n---\n\n**Task 1.5: Implement EventBus**\n\nCreate a simple pub/sub event system for decoupled communication.\n\nFiles to create:\n- `src/core/EventBus.ts`\n- `src/core/EventBus.test.ts`\n\nImplementation details:\n```typescript\nclass EventBus {\n  on<T>(event: string, handler: (data: T) => void): () => void  // Returns unsubscribe\n  off<T>(event: string, handler: (data: T) => void): void\n  emit<T>(event: string, data: T): void\n  once<T>(event: string, handler: (data: T) => void): void\n}\n```\n\nAcceptance criteria:\n- [ ] Handlers receive emitted events\n- [ ] Unsubscribe function works correctly\n- [ ] `once` handlers fire only once\n- [ ] Multiple handlers for same event all fire\n\n---\n\n### Phase 2: Rendering System\n\n**Task 2.1: Implement Renderer and Camera**\n\nCreate the Canvas2D rendering wrapper and camera system.\n\nFiles to create:\n- `src/rendering/Renderer.ts`\n- `src/rendering/Camera.ts`\n- `src/rendering/Renderer.test.ts`\n\nImplementation details:\n```typescript\nclass Renderer {\n  constructor(canvas: HTMLCanvasElement)\n  clear(color?: string): void\n  setCamera(camera: Camera): void\n  drawSprite(sprite: Sprite, transform: Transform, alpha?: number): void\n  drawRect(x: number, y: number, w: number, h: number, color: string): void\n  getCanvas(): HTMLCanvasElement\n  getContext(): CanvasRenderingContext2D\n}\n\nclass Camera {\n  position: Vector2\n  zoom: number\n  rotation: number\n\n  worldToScreen(point: Vector2): Vector2\n  screenToWorld(point: Vector2): Vector2\n  getViewBounds(): Rectangle\n}\n```\n\nAcceptance criteria:\n- [ ] Renderer clears canvas with specified color\n- [ ] Camera transforms applied to all draw calls\n- [ ] Zoom in/out works correctly (centered on camera position)\n- [ ] World-to-screen coordinate conversion is accurate\n\n---\n\n**Task 2.2: Implement Transform component**\n\nCreate the Transform component for position, rotation, and scale.\n\nFiles to create:\n- `src/components/Transform.ts`\n- `src/math/Vector2.ts`\n- `src/math/Vector2.test.ts`\n\nImplementation details:\n```typescript\nclass Vector2 {\n  constructor(public x: number, public y: number)\n  add(v: Vector2): Vector2\n  sub(v: Vector2): Vector2\n  mul(scalar: number): Vector2\n  dot(v: Vector2): number\n  length(): number\n  normalize(): Vector2\n  static distance(a: Vector2, b: Vector2): number\n}\n\nclass Transform extends Component {\n  position: Vector2\n  rotation: number      // Radians\n  scale: Vector2\n  anchor: Vector2       // 0-1, default (0.5, 0.5) = center\n}\n```\n\nAcceptance criteria:\n- [ ] Vector2 math operations are correct\n- [ ] Transform defaults are sensible (position 0,0, rotation 0, scale 1,1)\n- [ ] Anchor point affects rotation center\n\n---\n\n**Task 2.3: Implement Sprite and SpriteSheet**\n\nCreate sprite rendering components and sprite sheet support.\n\nFiles to create:\n- `src/components/Sprite.ts`\n- `src/rendering/SpriteSheet.ts`\n- `src/rendering/SpriteSheet.test.ts`\n\nImplementation details:\n```typescript\nclass Sprite extends Component {\n  image: HTMLImageElement | null\n  sourceRect?: Rectangle    // For sprite sheets\n  tint?: string\n  alpha: number            // 0-1\n}\n\nclass SpriteSheet {\n  constructor(image: HTMLImageElement, frameWidth: number, frameHeight: number)\n  getFrame(index: number): Rectangle\n  getFrameByName(name: string): Rectangle  // If named frames defined\n  defineAnimation(name: string, frames: number[], frameDuration: number): void\n}\n```\n\nAcceptance criteria:\n- [ ] Sprite renders image at entity position\n- [ ] Source rectangle crops sprite sheet correctly\n- [ ] Alpha/opacity works correctly\n- [ ] SpriteSheet frame indexing is row-major\n\n---\n\n**Task 2.4: Implement Animator component**\n\nCreate sprite animation support.\n\nFiles to create:\n- `src/components/Animator.ts`\n- `src/components/Animator.test.ts`\n\nImplementation details:\n```typescript\ninterface AnimationClip {\n  frames: number[]        // Frame indices in sprite sheet\n  frameDuration: number   // Seconds per frame\n  loop: boolean\n}\n\nclass Animator extends Component {\n  spriteSheet: SpriteSheet\n  currentAnimation: string | null\n\n  addAnimation(name: string, clip: AnimationClip): void\n  play(name: string): void\n  stop(): void\n  pause(): void\n\n  update(dt: number): void  // Called by animation system\n  getCurrentFrame(): number\n}\n```\n\nAcceptance criteria:\n- [ ] Animation plays through frames at correct speed\n- [ ] Looping animations restart after last frame\n- [ ] Non-looping animations stop on last frame\n- [ ] Animation can be switched mid-play\n\n---\n\n**Task 2.5: Implement RenderSystem**\n\nCreate the system that renders all sprites each frame.\n\nFiles to create:\n- `src/systems/RenderSystem.ts`\n- `src/systems/System.ts` (base interface)\n\nImplementation details:\n```typescript\ninterface System {\n  update(dt: number, scene: Scene): void\n  render?(interpolation: number, scene: Scene): void\n}\n\nclass RenderSystem implements System {\n  constructor(renderer: Renderer)\n\n  render(interpolation: number, scene: Scene): void\n  // Queries entities with Transform + Sprite\n  // Sorts by layer, then y-position (optional)\n  // Renders each sprite\n}\n```\n\nLayer support:\n- Entities can have optional `layer: number` property\n- Lower layers render first (background = 0, entities = 10, UI = 100)\n\nAcceptance criteria:\n- [ ] All entities with Sprite + Transform render\n- [ ] Entities render in correct layer order\n- [ ] Animated sprites show current frame\n- [ ] Camera transform applies to all sprites\n\n---\n\n### Phase 3: Physics System\n\n**Task 3.1: Implement Collider components**\n\nCreate AABB and Circle collider components.\n\nFiles to create:\n- `src/components/Collider.ts`\n- `src/physics/CollisionTests.ts`\n- `src/physics/CollisionTests.test.ts`\n\nImplementation details:\n```typescript\nabstract class Collider extends Component {\n  offset: Vector2          // Offset from entity position\n  isTrigger: boolean       // Triggers don't cause physics response\n  layer: number            // Collision layer (bitmask)\n  mask: number             // Which layers to collide with\n}\n\nclass BoxCollider extends Collider {\n  width: number\n  height: number\n  getBounds(transform: Transform): Rectangle\n}\n\nclass CircleCollider extends Collider {\n  radius: number\n  getCenter(transform: Transform): Vector2\n}\n```\n\nCollision tests (all return `CollisionResult | null`):\n```typescript\ninterface CollisionResult {\n  normal: Vector2      // Direction to separate\n  depth: number        // Penetration depth\n  point: Vector2       // Contact point\n}\n\nfunction testAABBvsAABB(a: Rectangle, b: Rectangle): CollisionResult | null\nfunction testCirclevsCircle(a: Circle, b: Circle): CollisionResult | null\nfunction testAABBvsCircle(box: Rectangle, circle: Circle): CollisionResult | null\n```\n\nAcceptance criteria:\n- [ ] AABB vs AABB collision detection works\n- [ ] Circle vs Circle collision detection works\n- [ ] AABB vs Circle collision detection works\n- [ ] Collision normal points from A to B\n- [ ] Penetration depth is accurate\n\n---\n\n**Task 3.2: Implement spatial partitioning**\n\nCreate spatial hash grid for broad-phase collision detection.\n\nFiles to create:\n- `src/physics/SpatialHash.ts`\n- `src/physics/SpatialHash.test.ts`\n\nImplementation details:\n```typescript\nclass SpatialHash {\n  constructor(cellSize: number)\n\n  clear(): void\n  insert(entity: Entity, bounds: Rectangle): void\n  query(bounds: Rectangle): Entity[]\n  queryPoint(point: Vector2): Entity[]\n}\n```\n\nAcceptance criteria:\n- [ ] Entities are correctly bucketed by position\n- [ ] Query returns only potentially colliding entities\n- [ ] Performance: 1000 entities query in <1ms\n- [ ] Handles entities spanning multiple cells\n\n---\n\n**Task 3.3: Implement RigidBody component**\n\nCreate the physics body component.\n\nFiles to create:\n- `src/components/RigidBody.ts`\n\nImplementation details:\n```typescript\nenum BodyType {\n  Static,     // Never moves (walls, platforms)\n  Dynamic,    // Affected by forces and collisions\n  Kinematic   // Moves but not affected by forces (moving platforms)\n}\n\nclass RigidBody extends Component {\n  type: BodyType\n  mass: number              // kg (static = infinite)\n  velocity: Vector2         // m/s\n  angularVelocity: number   // rad/s\n  drag: number              // Linear drag coefficient\n  restitution: number       // Bounciness 0-1\n  friction: number          // Surface friction 0-1\n  gravityScale: number      // Multiplier for gravity\n\n  applyForce(force: Vector2): void\n  applyImpulse(impulse: Vector2): void\n}\n```\n\nAcceptance criteria:\n- [ ] Static bodies have infinite mass\n- [ ] Force application respects mass (F = ma)\n- [ ] Velocity is integrated correctly\n- [ ] Drag reduces velocity over time\n\n---\n\n**Task 3.4: Implement PhysicsSystem**\n\nCreate the physics simulation system.\n\nFiles to create:\n- `src/systems/PhysicsSystem.ts`\n- `src/systems/PhysicsSystem.test.ts`\n\nImplementation details:\n```typescript\nclass PhysicsSystem implements System {\n  gravity: Vector2          // Default: (0, 980) for downward\n\n  update(dt: number, scene: Scene): void\n  // 1. Apply gravity to dynamic bodies\n  // 2. Integrate velocities\n  // 3. Broad phase: spatial hash query\n  // 4. Narrow phase: collision tests\n  // 5. Resolve collisions (separate + apply impulse)\n  // 6. Emit collision events\n}\n```\n\nCollision events:\n```typescript\ninterface CollisionEvent {\n  entityA: Entity\n  entityB: Entity\n  result: CollisionResult\n}\n\n// Events emitted via EventBus:\n// 'collision:enter' - First frame of collision\n// 'collision:stay'  - Ongoing collision\n// 'collision:exit'  - Collision ended\n```\n\nAcceptance criteria:\n- [ ] Objects fall with gravity\n- [ ] Dynamic objects collide and separate\n- [ ] Bounce works based on restitution\n- [ ] Collision events fire correctly\n- [ ] Static vs static doesn't waste cycles\n\n---\n\n### Phase 4: Input System\n\n**Task 4.1: Implement keyboard input**\n\nCreate keyboard input handling.\n\nFiles to create:\n- `src/systems/InputSystem.ts`\n- `src/input/Keyboard.ts`\n\nImplementation details:\n```typescript\nclass Keyboard {\n  isKeyDown(key: string): boolean      // Currently held\n  isKeyPressed(key: string): boolean   // Just pressed this frame\n  isKeyReleased(key: string): boolean  // Just released this frame\n\n  // Internal\n  update(): void  // Called end of frame to reset pressed/released\n}\n```\n\nKey names use `KeyboardEvent.code` (e.g., \"KeyW\", \"Space\", \"ArrowUp\").\n\nAcceptance criteria:\n- [ ] `isKeyDown` returns true while key held\n- [ ] `isKeyPressed` returns true only first frame\n- [ ] `isKeyReleased` returns true only frame of release\n- [ ] Multiple simultaneous keys work\n\n---\n\n**Task 4.2: Implement mouse input**\n\nCreate mouse input handling.\n\nFiles to create:\n- `src/input/Mouse.ts`\n\nImplementation details:\n```typescript\nclass Mouse {\n  position: Vector2           // Screen coordinates\n  worldPosition: Vector2      // World coordinates (needs camera)\n\n  isButtonDown(button: number): boolean    // 0=left, 1=middle, 2=right\n  isButtonPressed(button: number): boolean\n  isButtonReleased(button: number): boolean\n\n  getScrollDelta(): number    // Wheel delta this frame\n\n  setCamera(camera: Camera): void  // For world coordinate conversion\n}\n```\n\nAcceptance criteria:\n- [ ] Mouse position updates on move\n- [ ] Button states work like keyboard\n- [ ] World position accounts for camera transform\n- [ ] Scroll wheel delta captured\n\n---\n\n**Task 4.3: Implement input mapping**\n\nCreate action-based input mapping system.\n\nFiles to create:\n- `src/input/InputMap.ts`\n\nImplementation details:\n```typescript\ninterface InputBinding {\n  keys?: string[]           // Keyboard keys\n  mouseButtons?: number[]   // Mouse buttons\n  gamepadButtons?: number[] // Gamepad buttons\n  gamepadAxes?: { axis: number; threshold: number }[]\n}\n\nclass InputMap {\n  define(action: string, binding: InputBinding): void\n\n  isActionDown(action: string): boolean\n  isActionPressed(action: string): boolean\n  isActionReleased(action: string): boolean\n  getActionValue(action: string): number  // For analog (0-1)\n}\n\n// Example usage:\ninputMap.define('jump', { keys: ['Space', 'KeyW'], gamepadButtons: [0] })\ninputMap.define('move_right', { keys: ['KeyD', 'ArrowRight'], gamepadAxes: [{ axis: 0, threshold: 0.2 }] })\n```\n\nAcceptance criteria:\n- [ ] Multiple keys can map to one action\n- [ ] Any bound key triggers the action\n- [ ] Analog values work for gamepad axes\n- [ ] Input map can be changed at runtime\n\n---\n\n**Task 4.4: Implement gamepad support**\n\nAdd gamepad input handling.\n\nFiles to create:\n- `src/input/Gamepad.ts`\n\nImplementation details:\n```typescript\nclass GamepadInput {\n  isConnected(): boolean\n\n  isButtonDown(button: number): boolean\n  isButtonPressed(button: number): boolean\n  getAxis(axis: number): number  // -1 to 1\n\n  // Standard mapping (if gamepad.mapping === 'standard'):\n  // Buttons: 0=A, 1=B, 2=X, 3=Y, 4=LB, 5=RB, etc.\n  // Axes: 0=LeftX, 1=LeftY, 2=RightX, 3=RightY\n}\n```\n\nAcceptance criteria:\n- [ ] Detects gamepad connection/disconnection\n- [ ] Button states work correctly\n- [ ] Axis values in correct range\n- [ ] Handles no gamepad gracefully\n\n---\n\n**Task 4.5: Integrate InputSystem**\n\nCreate unified InputSystem that combines all input sources.\n\nImplementation details:\n```typescript\nclass InputSystem implements System {\n  readonly keyboard: Keyboard\n  readonly mouse: Mouse\n  readonly gamepad: GamepadInput\n  readonly map: InputMap\n\n  update(dt: number): void  // Updates all input states\n}\n```\n\nAcceptance criteria:\n- [ ] All input sources accessible via InputSystem\n- [ ] Input states reset correctly each frame\n- [ ] Input mapping queries all sources\n- [ ] Works when gamepad not connected\n\n---\n\n### Phase 5: Integration & Demo\n\n**Task 5.1: Create example game**\n\nBuild a simple game demonstrating all engine features.\n\nFiles to create:\n- `examples/demo/index.html`\n- `examples/demo/main.ts`\n- `examples/demo/assets/` (sprites)\n\nDemo requirements:\n- Player entity with sprite and animation\n- WASD/arrow key movement + gamepad support\n- Collectible coins with collision triggers\n- Solid walls with physics collision\n- Score counter displayed on screen\n- Camera follows player\n\nAcceptance criteria:\n- [ ] Demo loads and runs without errors\n- [ ] Player moves smoothly with input\n- [ ] Coins disappear when collected\n- [ ] Player cannot walk through walls\n- [ ] Score increments on coin collection\n\n---\n\n**Task 5.2: Write API documentation**\n\nCreate comprehensive documentation.\n\nFiles to create/update:\n- `README.md` - Quick start and overview\n- `docs/api.md` - Full API reference\n- `docs/architecture.md` - System design overview\n\nREADME must include:\n- Installation instructions\n- Basic usage example (complete, runnable)\n- Links to full documentation\n\nAcceptance criteria:\n- [ ] README example can be copy-pasted and works\n- [ ] All public classes documented\n- [ ] Common use cases have examples\n\n---\n\n## Performance Targets\n\n| Metric | Target |\n|--------|--------|\n| Entities rendered | 1000 @ 60 FPS |\n| Physics bodies | 500 @ 60 FPS |\n| Collision checks | <2ms for 500 entities |\n| Memory per entity | <1KB base |\n| Bundle size | <50KB minified |\n\n## Testing Strategy\n\n- Unit tests for all math utilities (Vector2, collision tests)\n- Unit tests for component lifecycle\n- Integration tests for physics scenarios\n- Manual testing via demo game\n\nTarget: >80% code coverage for core modules.\n",
      "score": {
        "structure": 30,
        "content": 30,
        "quality": 0,
        "total": 60,
        "violations": [
          "Tasks missing Verify sections",
          "Found 22 code blocks outside Verify sections",
          "Task count 86 outside expected range 3-8",
          "Contains forbidden term: npm install",
          "Contains forbidden term: ```typescript"
        ]
      },
      "violations": [
        "Tasks missing Verify sections",
        "Found 22 code blocks outside Verify sections",
        "Task count 86 outside expected range 3-8",
        "Contains forbidden term: npm install",
        "Contains forbidden term: ```typescript"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/game-engine",
        "Error: spawnSync /bin/sh ETIMEDOUT",
        "SPEC.md exists despite error: 20338 bytes"
      ]
    },
    {
      "id": "greenfield-frontend",
      "name": "Greenfield: React Dashboard",
      "timestamp": "2026-01-16T17:33:36.261Z",
      "duration_ms": 295187,
      "success": false,
      "spec_created": true,
      "task_count": 57,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# React Dashboard\n\nA real-time dashboard application featuring interactive charts, data tables, and live updates via WebSocket.\n\n## Goal\n\nBuild a production-ready React dashboard that displays business metrics through charts and tables, with real-time data synchronization via WebSocket connections.\n\n## Success Criteria\n\nThe project is complete when:\n1. Dashboard renders 4 KPI cards, a live-updating line chart, and an activity feed\n2. Data table displays events with working sort, filter, and pagination\n3. WebSocket connects, receives data, and auto-reconnects on disconnect\n4. All tests pass with >70% coverage on hooks and stores\n5. `npm run build` produces a working production bundle\n6. Lighthouse scores: Performance >90, Accessibility >90\n\n## Technical Decisions\n\n| Decision | Choice | Rationale |\n|----------|--------|-----------|\n| Build tool | Vite | Fast HMR, ESM-native, excellent React support |\n| Language | TypeScript (strict mode) | Type safety for complex data flows |\n| Styling | Tailwind CSS v3 | Rapid UI development, consistent design tokens |\n| Charting | Recharts 2.x | React-native, composable, good TypeScript support |\n| State management | Zustand 4.x | Minimal boilerplate, works well with real-time updates |\n| Data table | TanStack Table v8 | Headless, full sorting/filtering/pagination |\n| Routing | React Router v6 | Industry standard, type-safe routes |\n| Testing | Vitest + React Testing Library | Fast, Vite-native, good DX |\n| WebSocket | Native WebSocket + custom hook | No heavy dependencies needed |\n\n## WebSocket Protocol\n\n### Message Format\n\nAll messages are JSON with a `type` field:\n\n```typescript\n// Server -> Client messages\ntype ServerMessage =\n  | { type: 'kpis'; data: KPI[] }\n  | { type: 'event'; data: RealtimeEvent }\n  | { type: 'metrics'; data: MetricSnapshot[] }\n  | { type: 'error'; message: string };\n\n// Client -> Server messages (future use)\ntype ClientMessage =\n  | { type: 'subscribe'; channels: string[] }\n  | { type: 'ping' };\n```\n\n### Connection Lifecycle\n\n1. Client connects to `ws://localhost:8080`\n2. Server sends `kpis` message with initial KPI data\n3. Server sends `metrics` message with historical data (last 24 hours)\n4. Server sends `event` messages every 1-5 seconds\n5. Client sends `ping` every 30 seconds to keep connection alive\n6. On disconnect, client retries with exponential backoff: 1s, 2s, 4s, 8s, max 30s\n\n## Data Schema\n\n```typescript\n// Real-time event from WebSocket\ninterface RealtimeEvent {\n  id: string;\n  timestamp: string; // ISO 8601\n  type: 'sale' | 'signup' | 'pageview' | 'error';\n  value: number;\n  metadata?: Record<string, string>;\n}\n\n// Aggregated metrics for charts\ninterface MetricSnapshot {\n  timestamp: string;\n  sales: number;\n  signups: number;\n  pageviews: number;\n  errors: number;\n}\n\n// KPI card data\ninterface KPI {\n  label: string;\n  value: number;\n  previousValue: number;\n  unit: '$' | '%' | '';\n}\n\n// WebSocket connection status\ntype ConnectionStatus = 'connecting' | 'connected' | 'disconnected' | 'reconnecting';\n```\n\n## Project Structure\n\n```\ndashboard/\n├── scripts/\n│   └── mock-server.mjs      # WebSocket mock server\n├── src/\n│   ├── components/\n│   │   ├── charts/          # LineChart, BarChart, PieChart\n│   │   ├── table/           # DataTable, columns, filters\n│   │   ├── widgets/         # MetricCard, ActivityFeed\n│   │   ├── layout/          # Header, Sidebar, Shell\n│   │   └── ui/              # Button, Input, Loading, Error\n│   ├── hooks/\n│   │   ├── useWebSocket.ts  # Connection management\n│   │   ├── useRealtimeData.ts\n│   │   └── useMetrics.ts\n│   ├── pages/\n│   │   ├── Overview.tsx\n│   │   ├── Analytics.tsx\n│   │   └── Events.tsx\n│   ├── services/\n│   │   └── websocket.ts     # WebSocket client class\n│   ├── stores/\n│   │   └── dashboard.ts     # Zustand store\n│   ├── types/\n│   │   └── index.ts         # Shared TypeScript types\n│   ├── lib/\n│   │   ├── utils.ts         # Formatting, helpers\n│   │   └── sampleData.ts    # Mock data generators\n│   ├── App.tsx\n│   ├── main.tsx\n│   └── index.css            # Tailwind imports\n├── .env                     # VITE_WS_URL=ws://localhost:8080\n├── package.json\n├── tailwind.config.js\n├── tsconfig.json\n├── vite.config.ts\n└── vitest.config.ts\n```\n\n## Development Workflow\n\n### Starting Development\n\n```bash\n# Terminal 1: Start mock WebSocket server\nnode scripts/mock-server.mjs\n\n# Terminal 2: Start Vite dev server\nnpm run dev\n```\n\n### Available Scripts\n\n```bash\nnpm run dev        # Start dev server (http://localhost:5173)\nnpm run build      # Production build\nnpm run preview    # Preview production build\nnpm run test       # Run tests\nnpm run test:watch # Run tests in watch mode\nnpm run coverage   # Run tests with coverage\nnpm run lint       # ESLint + TypeScript check\nnpm run lint:fix   # Auto-fix lint issues\n```\n\n## Tasks\n\n### Phase 1: Project Scaffolding\n\n**Dependencies:** None\n\n- [ ] Initialize Vite + React + TypeScript project\n  ```bash\n  npm create vite@latest . -- --template react-ts\n  ```\n- [ ] Install production dependencies\n  ```bash\n  npm install react-router-dom recharts zustand @tanstack/react-table\n  ```\n- [ ] Install dev dependencies\n  ```bash\n  npm install -D tailwindcss postcss autoprefixer @types/node\n  npm install -D vitest @testing-library/react @testing-library/jest-dom jsdom\n  npm install -D @typescript-eslint/eslint-plugin @typescript-eslint/parser eslint-plugin-react-hooks\n  ```\n- [ ] Initialize Tailwind CSS\n  ```bash\n  npx tailwindcss init -p\n  ```\n- [ ] Configure `tailwind.config.js`:\n  ```javascript\n  export default {\n    content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'],\n    theme: { extend: {} },\n    plugins: [],\n  }\n  ```\n- [ ] Configure TypeScript `strict: true` in tsconfig.json\n- [ ] Create `vitest.config.ts` with jsdom environment\n- [ ] Create directory structure per Project Structure above\n- [ ] Add `.env` file with `VITE_WS_URL=ws://localhost:8080`\n- [ ] Add `.env.example` with same variable (no value)\n\n**Verify:**\n```bash\nnpm run dev        # Starts on http://localhost:5173\nnpm run build      # Produces dist/ with no errors\nnpm run lint       # Zero errors\nnpm test           # Test runner starts (no tests yet)\n```\n\n---\n\n### Phase 2: Type Definitions & Store\n\n**Dependencies:** Phase 1\n\n- [ ] Create `src/types/index.ts` with all type definitions from Data Schema\n- [ ] Create `src/stores/dashboard.ts` with Zustand store:\n  ```typescript\n  interface DashboardState {\n    events: RealtimeEvent[];        // Last 100 events, newest first\n    metrics: MetricSnapshot[];       // Time-series, last 24h\n    kpis: KPI[];                     // Current 4 KPIs\n    connectionStatus: ConnectionStatus;\n\n    // Actions\n    addEvent: (event: RealtimeEvent) => void;\n    setMetrics: (metrics: MetricSnapshot[]) => void;\n    setKPIs: (kpis: KPI[]) => void;\n    setConnectionStatus: (status: ConnectionStatus) => void;\n    clearEvents: () => void;\n  }\n  ```\n- [ ] Implement `addEvent` to prepend event and cap array at 100 items\n- [ ] Create `src/lib/sampleData.ts` with generators:\n  - `generateSampleEvents(count: number): RealtimeEvent[]`\n  - `generateSampleMetrics(hours: number): MetricSnapshot[]`\n  - `generateSampleKPIs(): KPI[]`\n- [ ] Create `src/stores/dashboard.test.ts` with tests for all actions\n\n**Verify:**\n```bash\nnpm test -- dashboard.test  # Store tests pass\n```\n\n---\n\n### Phase 3: Layout Shell\n\n**Dependencies:** Phase 1\n\n- [ ] Install React Router: already in Phase 1 deps\n- [ ] Create `src/components/layout/Shell.tsx`:\n  - CSS Grid layout: `sidebar (240px) | content (1fr)`\n  - Mobile: sidebar hidden, toggle button in header\n- [ ] Create `src/components/layout/Sidebar.tsx`:\n  - Nav items: Overview (`/`), Analytics (`/analytics`), Events (`/events`)\n  - Active state styling (highlight current route)\n  - Collapse to hamburger at `< 768px`\n- [ ] Create `src/components/layout/Header.tsx`:\n  - Dashboard title on left\n  - Connection status badge on right (placeholder for now)\n  - Mobile menu toggle button\n- [ ] Set up React Router in `App.tsx`:\n  ```tsx\n  <BrowserRouter>\n    <Shell>\n      <Routes>\n        <Route path=\"/\" element={<Overview />} />\n        <Route path=\"/analytics\" element={<Analytics />} />\n        <Route path=\"/events\" element={<Events />} />\n      </Routes>\n    </Shell>\n  </BrowserRouter>\n  ```\n- [ ] Create placeholder page components that just render their name\n\n**Verify:**\n- Open http://localhost:5173 - See header, sidebar, \"Overview\" text\n- Click \"Analytics\" in sidebar - URL changes to `/analytics`, content changes\n- Resize to 600px wide - Sidebar collapses, hamburger menu appears\n- Click hamburger - Sidebar slides in as overlay\n\n---\n\n### Phase 4: UI Components\n\n**Dependencies:** Phase 1\n\n- [ ] Create `src/components/ui/Loading.tsx`:\n  - Animated spinner (CSS animation, not gif)\n  - Optional `message?: string` prop\n  - Centered in container\n- [ ] Create `src/components/ui/ErrorBoundary.tsx`:\n  - Class component implementing `componentDidCatch`\n  - Shows error message with \"Reload\" button\n  - Props: `fallback?: ReactNode`\n- [ ] Create `src/components/ui/ErrorDisplay.tsx`:\n  - Props: `message: string`, `onRetry?: () => void`\n  - Red alert styling\n  - Retry button visible only when `onRetry` provided\n- [ ] Create `src/components/ui/Badge.tsx`:\n  - Props: `variant: 'success' | 'warning' | 'error' | 'info'`, `children: ReactNode`\n  - Colored pill/chip styling\n- [ ] Create `src/components/ui/Card.tsx`:\n  - Props: `title?: string`, `children: ReactNode`, `className?: string`\n  - White background, subtle shadow, rounded corners\n- [ ] Create `src/components/ui/EmptyState.tsx`:\n  - Props: `icon?: ReactNode`, `title: string`, `description?: string`\n  - Centered, muted styling for \"no data\" states\n- [ ] All components accept `className` prop for customization\n\n**Verify:**\n- Render each component in isolation with various props\n- Loading spinner animates smoothly\n- ErrorDisplay retry button calls handler\n- Badge variants have distinct colors\n\n---\n\n### Phase 5: Chart Components\n\n**Dependencies:** Phase 1, Phase 4\n\n- [ ] Create `src/components/charts/LineChart.tsx`:\n  ```typescript\n  interface LineChartProps {\n    data: Array<{ timestamp: string; [key: string]: number | string }>;\n    dataKeys: string[];              // Which fields to plot\n    colors?: string[];               // Color per line\n    height?: number;                 // Default 300\n    showGrid?: boolean;              // Default true\n    showLegend?: boolean;            // Default false\n  }\n  ```\n  - Use `ResponsiveContainer` for auto-sizing\n  - Format X-axis timestamps as \"HH:mm\" for today, \"MM/DD\" otherwise\n  - Tooltip shows all values at that timestamp\n  - Handle empty data with EmptyState\n- [ ] Create `src/components/charts/BarChart.tsx`:\n  ```typescript\n  interface BarChartProps {\n    data: Array<{ label: string; value: number }>;\n    color?: string;\n    orientation?: 'horizontal' | 'vertical'; // Default vertical\n    height?: number;\n  }\n  ```\n- [ ] Create `src/components/charts/PieChart.tsx`:\n  ```typescript\n  interface PieChartProps {\n    data: Array<{ name: string; value: number }>;\n    colors?: string[];\n    showLegend?: boolean;            // Default true\n    showLabels?: boolean;            // Default true (percentages)\n  }\n  ```\n- [ ] Create `src/lib/utils.ts` with formatters:\n  - `formatCurrency(value: number): string` - \"$1,234.56\"\n  - `formatNumber(value: number): string` - \"1,234\"\n  - `formatPercent(value: number): string` - \"12.3%\"\n  - `formatTimestamp(iso: string): string` - Smart date/time format\n\n**Verify:**\n```tsx\n// In a test page:\n<LineChart\n  data={generateSampleMetrics(24)}\n  dataKeys={['sales', 'signups']}\n/>\n// Renders chart, hover shows tooltip, resizes with window\n```\n\n---\n\n### Phase 6: Data Table\n\n**Dependencies:** Phase 1, Phase 4\n\n- [ ] Create `src/components/table/DataTable.tsx`:\n  ```typescript\n  interface DataTableProps<T> {\n    columns: ColumnDef<T>[];\n    data: T[];\n    pageSize?: number;               // Default 10\n    pageSizeOptions?: number[];      // Default [10, 25, 50]\n    searchPlaceholder?: string;\n    emptyMessage?: string;\n  }\n  ```\n  - Global filter input above table\n  - Sortable headers (click to toggle asc/desc/none)\n  - Sort indicator arrows\n  - Pagination below table: \"Showing 1-10 of 100\" + prev/next + page size dropdown\n- [ ] Create `src/components/table/columns/eventColumns.tsx`:\n  ```typescript\n  export const eventColumns: ColumnDef<RealtimeEvent>[] = [\n    { accessorKey: 'timestamp', header: 'Time', cell: formatCell },\n    { accessorKey: 'type', header: 'Type', cell: BadgeCell },\n    { accessorKey: 'value', header: 'Value', cell: numberCell },\n    { accessorKey: 'id', header: 'ID' },\n  ];\n  ```\n  - Type column shows colored badge (sale=green, signup=blue, pageview=gray, error=red)\n  - Timestamp formatted relative (\"2m ago\") with full date in tooltip\n- [ ] Create `src/components/table/DataTable.test.tsx`:\n  - Test sorting changes row order\n  - Test filtering reduces visible rows\n  - Test pagination shows correct rows\n\n**Verify:**\n```tsx\n<DataTable columns={eventColumns} data={generateSampleEvents(50)} />\n// Click \"Time\" header -> rows reorder by timestamp\n// Type \"sale\" in search -> only sale events visible\n// Click next page -> rows 11-20 shown\n```\n\n---\n\n### Phase 7: WebSocket Integration\n\n**Dependencies:** Phase 2\n\n- [ ] Create `scripts/mock-server.mjs` (see Mock Server section below)\n- [ ] Create `src/services/websocket.ts`:\n  ```typescript\n  type MessageHandler = (message: ServerMessage) => void;\n  type StatusHandler = (status: ConnectionStatus) => void;\n\n  class WebSocketService {\n    constructor(url: string);\n    connect(): void;\n    disconnect(): void;\n    send(message: ClientMessage): void;\n    onMessage(handler: MessageHandler): () => void;  // Returns unsubscribe\n    onStatusChange(handler: StatusHandler): () => void;\n  }\n  ```\n  - Auto-reconnect with exponential backoff\n  - Parse incoming JSON, ignore malformed messages\n  - Log connection events to console in dev mode\n- [ ] Create `src/hooks/useWebSocket.ts`:\n  ```typescript\n  function useWebSocket(): {\n    status: ConnectionStatus;\n    lastMessage: ServerMessage | null;\n    send: (message: ClientMessage) => void;\n  }\n  ```\n  - Creates/reuses singleton WebSocketService\n  - Updates Zustand store connection status\n  - Cleans up on unmount\n- [ ] Create `src/hooks/useRealtimeData.ts`:\n  - Subscribes to WebSocket messages\n  - Routes messages to appropriate store actions:\n    - `kpis` -> `setKPIs`\n    - `event` -> `addEvent`\n    - `metrics` -> `setMetrics`\n- [ ] Create `src/hooks/useWebSocket.test.ts`:\n  - Mock WebSocket class\n  - Test reconnect logic triggers after disconnect\n  - Test message parsing handles valid/invalid JSON\n\n**Verify:**\n```bash\n# Terminal 1:\nnode scripts/mock-server.mjs\n# \"WebSocket server running on ws://localhost:8080\"\n\n# Terminal 2:\nnpm run dev\n# Open http://localhost:5173\n# Check React DevTools -> Zustand store has KPIs and events\n# Stop mock server -> status changes to \"reconnecting\"\n# Restart mock server -> status changes to \"connected\"\n```\n\n---\n\n### Phase 8: Dashboard Widgets\n\n**Dependencies:** Phase 2, Phase 5\n\n- [ ] Create `src/components/widgets/MetricCard.tsx`:\n  ```typescript\n  interface MetricCardProps {\n    kpi: KPI;\n  }\n  ```\n  - Large value display with unit prefix/suffix\n  - Label below value\n  - Trend indicator: up arrow (green) if value > previousValue, down arrow (red) otherwise\n  - Percent change shown: \"+12.3%\" or \"-5.2%\"\n  - Handle edge cases: previousValue=0, negative values\n- [ ] Create `src/components/widgets/ActivityFeed.tsx`:\n  - Shows last 10 events from store\n  - Each event shows: type badge, value, relative time\n  - New events animate in from top (CSS transition)\n  - Empty state when no events\n- [ ] Create `src/components/widgets/LiveChart.tsx`:\n  - LineChart connected to store `metrics`\n  - Auto-updates when new metrics arrive\n  - Shows last 2 hours of data\n  - Loading state while waiting for initial data\n\n**Verify:**\n- MetricCard with `{value: 12345, previousValue: 11000, unit: '$', label: 'Revenue'}` shows \"$12,345\" with green up arrow and \"+12.2%\"\n- ActivityFeed shows events, new ones slide in at top\n- LiveChart updates when mock server sends new data\n\n---\n\n### Phase 9: Page Assembly\n\n**Dependencies:** Phases 3, 6, 7, 8\n\n- [ ] Create `src/pages/Overview.tsx`:\n  - Top row: 4 MetricCards in grid (2x2 on mobile, 4x1 on desktop)\n  - Middle: LiveChart (full width)\n  - Right sidebar or bottom: ActivityFeed\n  - Loading state while WebSocket connecting\n  - Error boundary wrapping entire page\n- [ ] Create `src/pages/Analytics.tsx`:\n  - Full-width LineChart with all metric types\n  - BarChart showing event type distribution\n  - PieChart showing event type breakdown\n  - Time range selector (future enhancement - just show \"Last 24 Hours\" label)\n- [ ] Create `src/pages/Events.tsx`:\n  - Full DataTable of all events from store\n  - Real-time: new events appear at top of first page\n  - Clear events button\n- [ ] Update `src/components/layout/Header.tsx`:\n  - Connection status badge using `useWebSocket` hook\n  - Badge: \"Connected\" (green), \"Connecting...\" (yellow), \"Disconnected\" (red)\n- [ ] Wire up `useRealtimeData` hook in `App.tsx` (runs once, manages WebSocket)\n\n**Verify:**\n- Navigate to Overview -> See KPI cards, chart, activity feed\n- Events arrive via WebSocket -> KPIs update, chart extends, feed shows new events\n- Navigate to Events -> See table of all events\n- Navigate to Analytics -> See multiple chart views\n- Disconnect network -> Header badge shows \"Disconnected\"\n\n---\n\n### Phase 10: Testing\n\n**Dependencies:** All previous phases\n\n- [ ] Ensure all unit tests pass:\n  - `src/stores/dashboard.test.ts` - Store actions\n  - `src/hooks/useWebSocket.test.ts` - Connection logic\n  - `src/components/table/DataTable.test.tsx` - Table features\n- [ ] Add integration tests:\n  - `src/pages/Overview.test.tsx` - Page renders with mock data\n  - `src/App.test.tsx` - Navigation works\n- [ ] Add chart tests:\n  - `src/components/charts/LineChart.test.tsx` - Renders with data, handles empty\n  - `src/components/charts/BarChart.test.tsx`\n  - `src/components/charts/PieChart.test.tsx`\n- [ ] Configure coverage thresholds in `vitest.config.ts`:\n  ```typescript\n  coverage: {\n    thresholds: {\n      statements: 70,\n      branches: 70,\n      functions: 70,\n      lines: 70,\n    }\n  }\n  ```\n\n**Verify:**\n```bash\nnpm test             # All tests pass\nnpm run coverage     # Coverage meets thresholds\n```\n\n---\n\n### Phase 11: Polish & Accessibility\n\n**Dependencies:** Phase 10\n\n- [ ] Add ARIA labels:\n  - Charts: `aria-label` describing the data\n  - Table: proper `role` attributes\n  - Status badge: `aria-live=\"polite\"` for status changes\n- [ ] Keyboard navigation:\n  - Table: Tab through rows, Enter to select (if selection needed)\n  - Sidebar: Tab through nav items\n  - Focus visible indicators on all interactive elements\n- [ ] Screen reader support:\n  - Add `<title>` and `<desc>` to chart SVGs\n  - Table headers announced when sorting\n- [ ] Performance optimization:\n  - Virtualize event list if >100 items (use `@tanstack/react-virtual`)\n  - Memoize expensive chart computations\n  - Debounce table filter input (300ms)\n- [ ] Add `robots.txt` and basic `index.html` meta tags\n\n**Verify:**\n- Tab through entire app - all interactive elements focusable with visible indicators\n- Use screen reader (VoiceOver/NVDA) - content is announced sensibly\n- Load 1000 events - table scrolls smoothly at 60fps\n- Run Lighthouse - Performance >90, Accessibility >90\n\n---\n\n## Mock WebSocket Server\n\nCreate `scripts/mock-server.mjs`:\n\n```javascript\nimport { WebSocketServer } from 'ws';\nimport { randomUUID } from 'crypto';\n\nconst wss = new WebSocketServer({ port: 8080 });\n\nconst eventTypes = ['sale', 'signup', 'pageview', 'error'];\n\nfunction generateMetrics(hours) {\n  const metrics = [];\n  const now = Date.now();\n  for (let i = hours * 60; i >= 0; i -= 5) {\n    metrics.push({\n      timestamp: new Date(now - i * 60000).toISOString(),\n      sales: Math.floor(Math.random() * 1000) + 500,\n      signups: Math.floor(Math.random() * 100) + 20,\n      pageviews: Math.floor(Math.random() * 5000) + 1000,\n      errors: Math.floor(Math.random() * 10),\n    });\n  }\n  return metrics;\n}\n\nwss.on('connection', (ws) => {\n  console.log('Client connected');\n\n  // Send initial KPIs\n  ws.send(JSON.stringify({\n    type: 'kpis',\n    data: [\n      { label: 'Revenue', value: 12345, previousValue: 11000, unit: '$' },\n      { label: 'Signups', value: 234, previousValue: 200, unit: '' },\n      { label: 'Page Views', value: 45678, previousValue: 42000, unit: '' },\n      { label: 'Error Rate', value: 0.5, previousValue: 0.8, unit: '%' },\n    ]\n  }));\n\n  // Send historical metrics\n  ws.send(JSON.stringify({\n    type: 'metrics',\n    data: generateMetrics(24)\n  }));\n\n  // Send random events every 1-3 seconds\n  const sendEvent = () => {\n    if (ws.readyState !== 1) return;\n\n    const event = {\n      type: 'event',\n      data: {\n        id: randomUUID(),\n        timestamp: new Date().toISOString(),\n        type: eventTypes[Math.floor(Math.random() * eventTypes.length)],\n        value: Math.floor(Math.random() * 1000),\n      }\n    };\n    ws.send(JSON.stringify(event));\n\n    // Schedule next event\n    setTimeout(sendEvent, 1000 + Math.random() * 2000);\n  };\n\n  setTimeout(sendEvent, 1000);\n\n  // Handle pings\n  ws.on('message', (data) => {\n    try {\n      const msg = JSON.parse(data.toString());\n      if (msg.type === 'ping') {\n        ws.send(JSON.stringify({ type: 'pong' }));\n      }\n    } catch (e) {\n      // Ignore malformed messages\n    }\n  });\n\n  ws.on('close', () => {\n    console.log('Client disconnected');\n  });\n});\n\nconsole.log('WebSocket server running on ws://localhost:8080');\n```\n\n**To run:**\n```bash\n# Install ws package (dev dependency in project)\nnpm install -D ws\n\n# Run server\nnode scripts/mock-server.mjs\n```\n\n## Non-Functional Requirements\n\n| Requirement | Target | How to Verify |\n|-------------|--------|---------------|\n| Bundle size (gzipped) | < 150 KB | `npm run build && du -h dist/assets/*.js` |\n| First Contentful Paint | < 1.5s | Lighthouse audit |\n| Time to Interactive | < 3s | Lighthouse audit |\n| Lighthouse Performance | > 90 | Chrome DevTools Lighthouse |\n| Lighthouse Accessibility | > 90 | Chrome DevTools Lighthouse |\n| Browser support | Chrome 90+, Firefox 90+, Safari 14+, Edge 90+ | Manual testing or BrowserStack |\n| Test coverage | > 70% | `npm run coverage` |\n\n## Out of Scope\n\n- User authentication/authorization\n- Backend API for historical data (use mock data)\n- Data persistence (in-memory only)\n- Multiple dashboard configurations\n- Export functionality (CSV, PDF)\n- Dark mode (can be added later via Tailwind dark: variants)\n- Internationalization (i18n)\n- Mobile app / PWA features\n",
      "score": {
        "structure": 45,
        "content": 30,
        "quality": 0,
        "total": 75,
        "violations": [
          "Found 21 code blocks outside Verify sections",
          "Task count 57 outside expected range 3-10",
          "Contains forbidden term: npm install",
          "Contains forbidden term: ```tsx"
        ]
      },
      "violations": [
        "Found 21 code blocks outside Verify sections",
        "Task count 57 outside expected range 3-10",
        "Contains forbidden term: npm install",
        "Contains forbidden term: ```tsx"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/dashboard",
        "Error: Command failed: ralphie spec --headless --auto --cwd \"/tmp/ralphie-test/dashboard\" \"Build a React dashboard with charts, data tables, and real-time updates using WebSocket\"",
        "SPEC.md exists despite error: 22788 bytes"
      ]
    },
    {
      "id": "greenfield-trading",
      "name": "Greenfield: Trading Simulator",
      "timestamp": "2026-01-16T17:38:33.592Z",
      "duration_ms": 297330,
      "success": false,
      "spec_created": true,
      "task_count": 12,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# Stock Trading Simulator\n\nA stock trading simulator with portfolio tracking, order execution, and P&L (Profit & Loss) reporting.\n\n## Goal\n\nBuild a functional trading simulator that allows users to manage a virtual portfolio, execute buy/sell orders against simulated market data, and track performance through P&L reports.\n\n## Success Criteria\n\nThe project is complete when:\n1. Users can buy/sell stocks via CLI with immediate feedback\n2. Portfolio tracks positions with accurate cost basis\n3. P&L reports show both realized and unrealized gains\n4. All state persists across restarts\n5. Test coverage exceeds 80%\n\n## Architecture\n\n```\nsrc/\n├── types/\n│   └── index.ts          # All type definitions\n├── errors/\n│   └── index.ts          # Custom error classes\n├── services/\n│   ├── market-data.ts    # Price fetching and simulation\n│   ├── portfolio.ts      # Portfolio state management\n│   ├── order.ts          # Order creation and execution\n│   ├── pnl.ts            # P&L calculations\n│   └── persistence.ts    # File-based storage\n├── cli/\n│   └── index.ts          # Command-line interface\n└── index.ts              # Main entry point\n\ntests/\n├── services/\n│   ├── market-data.test.ts\n│   ├── portfolio.test.ts\n│   ├── order.test.ts\n│   ├── pnl.test.ts\n│   └── persistence.test.ts\n└── integration/\n    └── trading-flow.test.ts\n\ndata/                     # Runtime data (gitignored)\n├── portfolio.json\n├── transactions.json\n└── orders.json\n```\n\n## Constraints\n\n- **No short selling**: Users cannot sell shares they don't own\n- **No fractional shares**: All quantities are whole numbers\n- **No margin**: Users cannot spend more than their cash balance\n- **Market orders only execute at current price**: No slippage simulation\n- **Single currency (USD)**: All prices in USD\n- **Single portfolio**: No multi-account support\n\n## Data Types\n\nAll core types are defined in `src/types/index.ts`:\n\n```typescript\n// Stock information\ninterface Stock {\n  symbol: string;        // e.g., \"AAPL\" (1-5 uppercase letters)\n  name: string;          // e.g., \"Apple Inc.\"\n  price: number;         // Current price in USD (> 0)\n}\n\n// Order lifecycle\ninterface Order {\n  id: string;            // UUID v4\n  symbol: string;\n  side: 'buy' | 'sell';\n  type: 'market' | 'limit';\n  quantity: number;      // Whole shares only (> 0)\n  limitPrice?: number;   // Required for limit orders (> 0)\n  status: OrderStatus;\n  createdAt: Date;\n  filledAt?: Date;\n  rejectedReason?: string;\n}\n\ntype OrderStatus = 'pending' | 'filled' | 'cancelled' | 'rejected';\n\n// Portfolio holdings\ninterface Position {\n  symbol: string;\n  quantity: number;      // Shares held (> 0)\n  averageCost: number;   // Cost basis per share\n}\n\ninterface Portfolio {\n  cash: number;          // Available USD (>= 0)\n  positions: Position[];\n}\n\n// Trade execution record\ninterface Transaction {\n  id: string;            // UUID v4\n  orderId: string;\n  symbol: string;\n  side: 'buy' | 'sell';\n  quantity: number;\n  price: number;         // Execution price\n  total: number;         // quantity * price\n  timestamp: Date;\n}\n\n// P&L reporting\ninterface PositionSummary {\n  symbol: string;\n  quantity: number;\n  averageCost: number;\n  currentPrice: number;\n  marketValue: number;   // quantity * currentPrice\n  costBasis: number;     // quantity * averageCost\n  unrealizedPnL: number;\n  unrealizedPnLPercent: number;\n}\n\ninterface PortfolioSummary {\n  cash: number;\n  positions: PositionSummary[];\n  totalValue: number;\n  totalCost: number;\n  totalPnL: number;\n  totalPnLPercent: number;\n}\n\n// Persistence format (includes version for future migrations)\ninterface PersistedData<T> {\n  version: number;\n  updatedAt: string;     // ISO 8601\n  data: T;\n}\n```\n\n## Error Handling\n\nCustom error classes in `src/errors/index.ts`:\n\n```typescript\nclass TradingError extends Error {\n  constructor(message: string, public code: ErrorCode) {\n    super(message);\n    this.name = 'TradingError';\n  }\n}\n\nenum ErrorCode {\n  INSUFFICIENT_FUNDS = 'INSUFFICIENT_FUNDS',\n  INSUFFICIENT_SHARES = 'INSUFFICIENT_SHARES',\n  INVALID_SYMBOL = 'INVALID_SYMBOL',\n  INVALID_QUANTITY = 'INVALID_QUANTITY',\n  INVALID_PRICE = 'INVALID_PRICE',\n  ORDER_NOT_FOUND = 'ORDER_NOT_FOUND',\n  ORDER_NOT_CANCELLABLE = 'ORDER_NOT_CANCELLABLE',\n  PERSISTENCE_ERROR = 'PERSISTENCE_ERROR',\n  CORRUPTED_DATA = 'CORRUPTED_DATA',\n}\n```\n\nAll services throw `TradingError` with appropriate codes. CLI catches these and displays user-friendly messages.\n\n## Order Status Transitions\n\n```\n                    ┌─────────────┐\n                    │   pending   │\n                    └──────┬──────┘\n                           │\n          ┌────────────────┼────────────────┐\n          │                │                │\n          ▼                ▼                ▼\n    ┌──────────┐    ┌──────────┐    ┌──────────┐\n    │  filled  │    │ cancelled│    │ rejected │\n    └──────────┘    └──────────┘    └──────────┘\n```\n\n- `pending` → `filled`: Order executed successfully\n- `pending` → `cancelled`: User cancelled before execution\n- `pending` → `rejected`: Validation failed (insufficient funds/shares)\n\nOnce in a terminal state (filled, cancelled, rejected), status cannot change.\n\n## Validation Rules\n\n| Field | Rule | Error Code |\n|-------|------|------------|\n| symbol | 1-5 uppercase letters, must exist in market data | INVALID_SYMBOL |\n| quantity | Integer > 0 | INVALID_QUANTITY |\n| price | Number > 0 | INVALID_PRICE |\n| limitPrice | Number > 0 (required for limit orders) | INVALID_PRICE |\n| cash for buy | cash >= quantity * price | INSUFFICIENT_FUNDS |\n| shares for sell | position.quantity >= quantity | INSUFFICIENT_SHARES |\n\n## Tasks\n\n### Phase 1: Foundation\n\n- [ ] Initialize TypeScript project with testing infrastructure\n  - TypeScript 5.x with strict mode enabled\n  - Jest with ts-jest for unit testing\n  - ESLint flat config with TypeScript rules\n  - Prettier for formatting\n  - npm scripts: build, test, lint, format\n\n  **Verify:**\n  ```bash\n  npm run build      # Exits 0, creates dist/\n  npm test           # Jest runs, shows 0 tests\n  npm run lint       # ESLint exits 0\n  ```\n\n- [ ] Create core data models, types, and error classes\n\n  Implement all types from the Data Types section above, plus error classes from Error Handling section.\n\n  **Verify:**\n  ```bash\n  npm run build    # Compiles without errors\n  ```\n\n### Phase 2: Persistence Layer\n\nPersistence must be implemented early since other services depend on saving/loading state.\n\n- [ ] Implement persistence service\n\n  ```typescript\n  interface PersistenceService {\n    // Portfolio\n    savePortfolio(portfolio: Portfolio): void;\n    loadPortfolio(): Portfolio;  // Returns default if not found\n\n    // Transactions\n    saveTransaction(transaction: Transaction): void;\n    loadTransactions(): Transaction[];\n\n    // Orders (for limit order persistence)\n    saveOrder(order: Order): void;\n    updateOrder(order: Order): void;\n    loadOrders(): Order[];\n    loadPendingOrders(): Order[];\n  }\n  ```\n\n  Requirements:\n  - Store in `data/` directory (create if not exists)\n  - Use JSON with 2-space indentation for readability\n  - Wrap data in `PersistedData<T>` envelope with version number\n  - Handle missing files gracefully (return defaults)\n  - Handle corrupted JSON: log warning, backup corrupted file, return defaults\n  - Atomic writes: write to temp file, then rename\n\n  File formats:\n  ```json\n  // data/portfolio.json\n  {\n    \"version\": 1,\n    \"updatedAt\": \"2024-01-15T10:30:00Z\",\n    \"data\": {\n      \"cash\": 100000,\n      \"positions\": []\n    }\n  }\n  ```\n\n  **Verify:**\n  ```bash\n  npm test -- persistence\n  # Tests pass for:\n  # - Save and load portfolio round-trip\n  # - Save and load transactions\n  # - Missing file returns default portfolio ($100,000 cash)\n  # - Corrupted file logs warning and returns default\n  # - Data directory created if missing\n  ```\n\n### Phase 3: Market Data\n\n- [ ] Implement market data service\n\n  ```typescript\n  interface MarketDataService {\n    getPrice(symbol: string): number | null;\n    setPrice(symbol: string, price: number): void;\n    getStock(symbol: string): Stock | null;\n    getAllStocks(): Stock[];\n    isValidSymbol(symbol: string): boolean;\n  }\n  ```\n\n  Requirements:\n  - Pre-seed with 10 common stocks:\n    | Symbol | Name | Initial Price |\n    |--------|------|---------------|\n    | AAPL | Apple Inc. | $175.00 |\n    | GOOGL | Alphabet Inc. | $140.00 |\n    | MSFT | Microsoft Corp. | $375.00 |\n    | AMZN | Amazon.com Inc. | $155.00 |\n    | TSLA | Tesla Inc. | $250.00 |\n    | META | Meta Platforms Inc. | $360.00 |\n    | NVDA | NVIDIA Corp. | $480.00 |\n    | JPM | JPMorgan Chase | $170.00 |\n    | V | Visa Inc. | $265.00 |\n    | WMT | Walmart Inc. | $160.00 |\n  - Return null for unknown symbols (not throw)\n  - Prices must be positive numbers\n  - Symbol validation: 1-5 uppercase letters\n\n  **Verify:**\n  ```bash\n  npm test -- market-data\n  # Tests pass for:\n  # - getPrice returns number for known symbol\n  # - getPrice returns null for unknown symbol\n  # - setPrice updates price correctly\n  # - setPrice throws for price <= 0\n  # - getAllStocks returns all 10 seeded stocks\n  # - isValidSymbol returns false for invalid formats\n  ```\n\n- [ ] Add price simulation engine\n\n  ```typescript\n  interface PriceSimulator {\n    tick(): void;  // Advance simulation one step\n    start(intervalMs: number): void;\n    stop(): void;\n    isRunning(): boolean;\n  }\n  ```\n\n  Requirements:\n  - Random walk: price changes by ±0-2% per tick\n  - Configurable volatility per stock (default 1%)\n  - Prices never go below $0.01\n  - Track last 100 price points per stock for history\n  - Use deterministic seed for reproducible tests\n\n  **Verify:**\n  ```bash\n  npm test -- price-simulation\n  # Tests pass for:\n  # - tick() changes prices within expected range\n  # - Prices remain positive after 1000 ticks\n  # - Price history is recorded up to 100 entries\n  # - start/stop controls simulation loop\n  ```\n\n### Phase 4: Portfolio Management\n\n- [ ] Implement portfolio service\n\n  ```typescript\n  interface PortfolioService {\n    getCash(): number;\n    getPositions(): Position[];\n    getPosition(symbol: string): Position | null;\n    getTotalValue(marketData: MarketDataService): number;\n\n    // Mutations (trigger auto-save)\n    addCash(amount: number): void;\n    withdrawCash(amount: number): void;\n    addShares(symbol: string, quantity: number, price: number): void;\n    removeShares(symbol: string, quantity: number): number; // returns avg cost\n  }\n  ```\n\n  Requirements:\n  - Default starting cash: $100,000\n  - Total value = cash + sum(position.quantity * currentPrice)\n  - Return null for positions not held (not throw)\n  - Average cost = weighted average of all purchases\n  - removeShares throws INSUFFICIENT_SHARES if quantity > held\n  - Removing all shares deletes the position from list\n  - All mutations auto-save via persistence service\n\n  **Verify:**\n  ```bash\n  npm test -- portfolio\n  # Tests pass for:\n  # - New portfolio has $100,000 cash\n  # - getTotalValue calculates correctly with positions\n  # - getPosition returns null for unheld stock\n  # - Buy 10 @ $100, buy 10 @ $120 -> avgCost = $110\n  # - Sell 5 shares reduces quantity to 15\n  # - Sell all shares removes position from list\n  # - Cannot sell more shares than held (throws)\n  # - Mutations trigger save\n  ```\n\n### Phase 5: Order Execution\n\n- [ ] Implement order service\n\n  ```typescript\n  interface OrderService {\n    createMarketOrder(symbol: string, side: 'buy' | 'sell', quantity: number): Order;\n    createLimitOrder(symbol: string, side: 'buy' | 'sell', quantity: number, limitPrice: number): Order;\n    cancelOrder(orderId: string): boolean;\n    getOrder(orderId: string): Order | null;\n    getOrders(): Order[];\n    getPendingOrders(): Order[];\n  }\n  ```\n\n  Requirements:\n  - Generate UUID v4 for order IDs\n  - Validate symbol exists in market data\n  - Validate quantity > 0 (integer)\n  - Validate limit price > 0 for limit orders\n  - Store all orders for history (persisted)\n  - Load pending orders on startup for limit order processing\n\n  **Verify:**\n  ```bash\n  npm test -- order-service\n  # Tests pass for:\n  # - createMarketOrder returns order with status 'pending'\n  # - createLimitOrder requires positive limitPrice\n  # - Invalid symbol throws INVALID_SYMBOL\n  # - Invalid quantity throws INVALID_QUANTITY\n  # - cancelOrder sets status to 'cancelled'\n  # - Cannot cancel already-filled order (throws ORDER_NOT_CANCELLABLE)\n  # - Orders persist across service restarts\n  ```\n\n- [ ] Add order execution engine\n\n  ```typescript\n  interface ExecutionEngine {\n    executeMarketOrder(order: Order): Transaction;\n    checkLimitOrders(): Transaction[];\n\n    // Called by price simulator on each tick\n    onPriceUpdate(symbol: string, price: number): void;\n  }\n  ```\n\n  Requirements:\n  - Buy order: reject if cash < quantity * price\n  - Sell order: reject if quantity > held shares\n  - On fill: update portfolio, record transaction, set order status\n  - Limit buy: execute when price <= limitPrice\n  - Limit sell: execute when price >= limitPrice\n  - Rejected orders have `rejectedReason` set\n\n  **Verify:**\n  ```bash\n  npm test -- execution\n  # Tests pass for:\n  # - Market buy deducts cash, adds position\n  # - Market sell adds cash, reduces position\n  # - Reject buy when insufficient cash (status='rejected')\n  # - Reject sell when insufficient shares (status='rejected')\n  # - Limit buy fills when price <= limitPrice\n  # - Limit sell fills when price >= limitPrice\n  # - Limit order stays pending when condition not met\n  # - Transaction created with correct values on fill\n  ```\n\n### Phase 6: P&L Reporting\n\n- [ ] Implement P&L calculation service\n\n  ```typescript\n  interface PnLService {\n    getUnrealizedPnL(): { symbol: string; pnl: number; percentage: number }[];\n    getRealizedPnL(): number;\n    getTotalPnL(): number;\n    getPnLBySymbol(symbol: string): { realized: number; unrealized: number };\n  }\n  ```\n\n  Requirements:\n  - Unrealized = (currentPrice - avgCost) * quantity\n  - Realized = sum of (sellPrice - avgCost) * quantity for all sells\n  - Percentage = (currentPrice - avgCost) / avgCost * 100\n  - Track realized P&L per symbol from transaction history\n  - Handle division by zero (0 cost basis) gracefully\n\n  **Verify:**\n  ```bash\n  npm test -- pnl\n  # Tests pass for:\n  # - Buy 10 @ $100, price now $110 -> unrealized = $100, 10%\n  # - Sell 5 @ $110 from $100 cost -> realized = $50\n  # - Total P&L = realized + unrealized\n  # - getPnLBySymbol returns both realized and unrealized\n  # - Empty portfolio returns $0 for all P&L\n  ```\n\n- [ ] Add reporting service\n\n  ```typescript\n  interface ReportService {\n    getPortfolioSummary(): PortfolioSummary;\n    getTransactionHistory(limit?: number): Transaction[];\n    exportToJSON(): string;\n  }\n  ```\n\n  **Verify:**\n  ```bash\n  npm test -- reporting\n  # Tests pass for:\n  # - Summary includes all positions with current values\n  # - Summary calculates totals correctly\n  # - Transaction history returns most recent first\n  # - Transaction history respects limit parameter\n  # - exportToJSON produces valid, parseable JSON\n  ```\n\n### Phase 7: CLI Interface\n\n- [ ] Create command-line interface\n\n  Commands:\n  ```\n  trading portfolio              Show portfolio summary\n  trading buy <symbol> <qty>     Buy shares at market price\n  trading sell <symbol> <qty>    Sell shares at market price\n  trading limit-buy <symbol> <qty> <price>   Place limit buy order\n  trading limit-sell <symbol> <qty> <price>  Place limit sell order\n  trading quote <symbol>         Get current price\n  trading orders                 Show all orders\n  trading cancel <orderId>       Cancel a pending order\n  trading pnl                    Show P&L report\n  trading history [limit]        Show transaction history\n  trading help                   Show available commands\n  ```\n\n  Requirements:\n  - Use commander.js for argument parsing\n  - Show confirmation before executing market orders (--yes to skip)\n  - Display errors clearly with error codes\n  - Format currency with 2 decimal places and $ prefix\n  - Format percentages with 2 decimal places and % suffix\n  - Color output: green for gains, red for losses (optional, via chalk)\n  - Exit codes: 0 for success, 1 for user error, 2 for system error\n\n  Output formats:\n  ```\n  # portfolio command\n  Portfolio Summary\n  =================\n  Cash: $95,000.00\n\n  Positions:\n  Symbol  Qty    Avg Cost    Current    Value        P&L\n  AAPL    100    $150.00     $175.00    $17,500.00   +$2,500.00 (+16.67%)\n  MSFT    50     $350.00     $375.00    $18,750.00   +$1,250.00 (+7.14%)\n\n  Total Value: $131,250.00\n  Total P&L: +$3,750.00 (+2.94%)\n\n  # quote command\n  AAPL (Apple Inc.): $175.00\n\n  # pnl command\n  P&L Report\n  ==========\n  Unrealized P&L:\n    AAPL: +$2,500.00 (+16.67%)\n    MSFT: +$1,250.00 (+7.14%)\n\n  Realized P&L: $500.00\n\n  Total P&L: +$4,250.00\n  ```\n\n  **Verify:**\n  ```bash\n  npm run cli -- portfolio      # Shows cash and positions\n  npm run cli -- quote AAPL     # Shows current price\n  npm run cli -- buy AAPL 10    # Prompts for confirmation\n  npm run cli -- buy AAPL 10 --yes  # Skips confirmation\n  npm run cli -- sell AAPL 5    # Prompts, then executes\n  npm run cli -- limit-buy AAPL 10 150  # Places limit order\n  npm run cli -- orders         # Shows all orders with status\n  npm run cli -- cancel <id>    # Cancels pending order\n  npm run cli -- pnl            # Shows P&L breakdown\n  npm run cli -- history 5      # Shows last 5 transactions\n  npm run cli -- history        # Shows all transactions\n  npm run cli -- buy INVALID 10 # Shows \"Unknown symbol: INVALID\"\n  npm run cli -- buy AAPL -5    # Shows \"Quantity must be positive\"\n  ```\n\n### Phase 8: Integration Testing\n\n- [ ] Create integration tests for complete trading workflows\n\n  Test scenarios:\n  1. **Fresh start**: New portfolio with $100,000, execute buy, verify position\n  2. **Round trip**: Buy 100 shares, sell 50, verify P&L calculation\n  3. **Limit order flow**: Place limit buy, simulate price drop, verify fill\n  4. **Persistence**: Execute trades, restart service, verify state preserved\n  5. **Error handling**: Attempt invalid operations, verify proper rejection\n\n  **Verify:**\n  ```bash\n  npm test -- integration\n  # All integration tests pass\n  npm run coverage\n  # Coverage report shows >= 80%\n  ```\n\n## Edge Cases to Handle\n\n| Scenario | Expected Behavior |\n|----------|-------------------|\n| Buy with exact cash | Allow, leave $0.00 cash |\n| Sell entire position | Remove position from list |\n| Unknown stock symbol | Throw INVALID_SYMBOL, don't crash |\n| Negative quantity | Throw INVALID_QUANTITY |\n| Zero quantity | Throw INVALID_QUANTITY |\n| Non-integer quantity | Throw INVALID_QUANTITY |\n| Corrupted data file | Log warning, backup file, use defaults |\n| Very large numbers | Use standard JS number limits (Number.MAX_SAFE_INTEGER) |\n| Concurrent limit orders | Process in order received (FIFO) |\n| Cancel filled order | Throw ORDER_NOT_CANCELLABLE |\n| Buy when no cash | Throw INSUFFICIENT_FUNDS with details |\n| Sell when no position | Throw INSUFFICIENT_SHARES |\n| Price drops to $0.01 | Allow, minimum price floor |\n\n## Testing Strategy\n\n- **Unit tests**: Each service tested in isolation with mocks\n- **Integration tests**: Full trading flow from order to P&L\n- **Edge case tests**: All scenarios from table above\n- **Persistence tests**: Save/load round-trips, corruption handling\n- **Target**: 80%+ code coverage\n\nTest file naming: `*.test.ts` co-located or in `tests/` directory.\n\n## Dependencies\n\n```json\n{\n  \"dependencies\": {\n    \"commander\": \"^12.0.0\",\n    \"uuid\": \"^9.0.0\"\n  },\n  \"devDependencies\": {\n    \"typescript\": \"^5.3.0\",\n    \"jest\": \"^29.7.0\",\n    \"ts-jest\": \"^29.1.0\",\n    \"@types/jest\": \"^29.5.0\",\n    \"@types/node\": \"^20.0.0\",\n    \"@types/uuid\": \"^9.0.0\",\n    \"eslint\": \"^9.0.0\",\n    \"@typescript-eslint/eslint-plugin\": \"^7.0.0\",\n    \"@typescript-eslint/parser\": \"^7.0.0\",\n    \"prettier\": \"^3.2.0\"\n  }\n}\n```\n\nOptional (for colored output):\n```json\n{\n  \"dependencies\": {\n    \"chalk\": \"^5.3.0\"\n  }\n}\n```\n\n## Non-Functional Requirements\n\n- **Startup time**: < 500ms to load portfolio and be ready for commands\n- **Command response**: < 100ms for local operations (quote, portfolio, pnl)\n- **Data integrity**: No data loss on crash (atomic writes)\n- **Memory**: < 50MB for typical usage (100 positions, 10,000 transactions)\n",
      "score": {
        "structure": 45,
        "content": 20,
        "quality": 1,
        "total": 66,
        "violations": [
          "Found 15 code blocks outside Verify sections",
          "Shell commands found in task deliverables",
          "Task count 12 outside expected range 4-10",
          "Contains forbidden term: ```"
        ]
      },
      "violations": [
        "Found 15 code blocks outside Verify sections",
        "Shell commands found in task deliverables",
        "Task count 12 outside expected range 4-10",
        "Contains forbidden term: ```"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/trading",
        "Error: Command failed: ralphie spec --headless --auto --cwd \"/tmp/ralphie-test/trading\" \"Build a stock trading simulator with portfolio tracking, order execution, and P&L reporting\"",
        "SPEC.md exists despite error: 20335 bytes"
      ]
    },
    {
      "id": "brownfield-feature",
      "name": "Brownfield: Add Auth to Existing API",
      "timestamp": "2026-01-16T17:42:46.450Z",
      "duration_ms": 252857,
      "success": false,
      "spec_created": true,
      "task_count": 33,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# JWT Authentication API\n\nAdd JWT-based authentication to the existing REST API with login, logout, and protected route middleware.\n\n## Goal\n\nExtend the existing Express API with a secure authentication system where users can register, login to receive JWT tokens, logout to invalidate tokens, and access protected routes with valid tokens.\n\n## Existing Codebase\n\n- `src/routes/users.ts` - Existing user routes (exports empty object)\n- No package.json exists - will need to initialize project\n\n## Requirements\n\n### Functional Requirements\n\n1. **User Registration** - Create account with email and password\n2. **User Login** - Authenticate and receive JWT access token\n3. **User Logout** - Invalidate current token\n4. **Auth Middleware** - Protect routes requiring authentication\n5. **Current User Endpoint** - Retrieve authenticated user's info\n\n### Non-Functional Requirements\n\n1. Passwords hashed with bcrypt (cost factor 10)\n2. JWT tokens expire after 1 hour (configurable via `JWT_EXPIRES_IN`)\n3. Invalidated tokens rejected on all subsequent requests\n4. All errors return consistent JSON format\n\n## Type Definitions\n\n```typescript\n// src/types/user.ts\ninterface User {\n  id: string;\n  email: string;\n  passwordHash: string;\n  createdAt: Date;\n}\n\n// Public user (no password)\ntype PublicUser = Omit<User, 'passwordHash'>;\n\n// src/types/auth.ts\ninterface RegisterRequest {\n  email: string;\n  password: string;\n}\n\ninterface LoginRequest {\n  email: string;\n  password: string;\n}\n\ninterface AuthResponse {\n  token: string;\n  user: PublicUser;\n}\n\ninterface JwtPayload {\n  userId: string;\n  email: string;\n  iat: number;\n  exp: number;\n}\n\n// Express request extension\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: PublicUser;\n    }\n  }\n}\n```\n\n## API Specification\n\n### POST /auth/register\n\nCreate a new user account.\n\n**Request:**\n```json\n{\n  \"email\": \"user@example.com\",\n  \"password\": \"securepassword123\"\n}\n```\n\n**Responses:**\n\n| Status | Condition | Body |\n|--------|-----------|------|\n| 201 | Success | `{ \"user\": { \"id\": \"...\", \"email\": \"...\", \"createdAt\": \"...\" } }` |\n| 400 | Invalid email format | `{ \"error\": \"Invalid email format\" }` |\n| 400 | Password < 8 chars | `{ \"error\": \"Password must be at least 8 characters\" }` |\n| 400 | Missing fields | `{ \"error\": \"Email and password are required\" }` |\n| 409 | Email exists | `{ \"error\": \"Email already registered\" }` |\n\n### POST /auth/login\n\nAuthenticate user and return JWT token.\n\n**Request:**\n```json\n{\n  \"email\": \"user@example.com\",\n  \"password\": \"securepassword123\"\n}\n```\n\n**Responses:**\n\n| Status | Condition | Body |\n|--------|-----------|------|\n| 200 | Success | `{ \"token\": \"eyJ...\", \"user\": { \"id\": \"...\", \"email\": \"...\", \"createdAt\": \"...\" } }` |\n| 400 | Missing fields | `{ \"error\": \"Email and password are required\" }` |\n| 401 | Invalid credentials | `{ \"error\": \"Invalid email or password\" }` |\n\n### POST /auth/logout\n\nInvalidate the current token.\n\n**Headers:**\n```\nAuthorization: Bearer <token>\n```\n\n**Responses:**\n\n| Status | Condition | Body |\n|--------|-----------|------|\n| 200 | Success | `{ \"message\": \"Logged out successfully\" }` |\n| 401 | Missing token | `{ \"error\": \"Authorization token required\" }` |\n| 401 | Invalid token | `{ \"error\": \"Invalid or expired token\" }` |\n\n### GET /auth/me\n\nGet current authenticated user's information.\n\n**Headers:**\n```\nAuthorization: Bearer <token>\n```\n\n**Responses:**\n\n| Status | Condition | Body |\n|--------|-----------|------|\n| 200 | Success | `{ \"user\": { \"id\": \"...\", \"email\": \"...\", \"createdAt\": \"...\" } }` |\n| 401 | Missing token | `{ \"error\": \"Authorization token required\" }` |\n| 401 | Invalid/expired token | `{ \"error\": \"Invalid or expired token\" }` |\n| 401 | Blacklisted token | `{ \"error\": \"Token has been invalidated\" }` |\n\n## Implementation Tasks\n\n### Task 1: Project Setup\n\nInitialize the Node.js project with required dependencies.\n\n**Actions:**\n1. Create `package.json` with:\n   - name: \"jwt-auth-api\"\n   - scripts: `start`, `dev`, `build`, `test`\n   - dependencies: express, jsonwebtoken, bcrypt, uuid, dotenv\n   - devDependencies: typescript, @types/express, @types/jsonwebtoken, @types/bcrypt, @types/node, @types/uuid, ts-node, jest, @types/jest, ts-jest, supertest, @types/supertest\n\n2. Create `tsconfig.json` with strict mode enabled\n\n3. Create `.env.example`:\n   ```\n   PORT=3000\n   JWT_SECRET=your-secret-key-min-32-chars-long\n   JWT_EXPIRES_IN=1h\n   ```\n\n4. Create `src/config.ts` to load and validate environment variables\n\n**Acceptance Criteria:**\n- [ ] `npm install` completes without errors\n- [ ] `npm run build` compiles TypeScript without errors\n- [ ] Environment variables load correctly with defaults\n\n### Task 2: Core Utilities\n\nCreate authentication utility functions.\n\n**Files:**\n- `src/utils/auth.ts`\n\n**Functions:**\n\n```typescript\n// Hash password using bcrypt with cost factor 10\nasync function hashPassword(password: string): Promise<string>\n\n// Compare plaintext password against hash\nasync function comparePassword(password: string, hash: string): Promise<boolean>\n\n// Generate JWT token with userId and email in payload\nfunction generateToken(userId: string, email: string): string\n\n// Verify and decode JWT token, returns payload or null if invalid\nfunction verifyToken(token: string): JwtPayload | null\n```\n\n**Acceptance Criteria:**\n- [ ] `hashPassword(\"test\")` returns a string starting with `$2b$10$`\n- [ ] `comparePassword(\"test\", hash)` returns true for matching password\n- [ ] `comparePassword(\"wrong\", hash)` returns false\n- [ ] `generateToken` returns a valid JWT string\n- [ ] `verifyToken` decodes a valid token correctly\n- [ ] `verifyToken` returns null for invalid/expired tokens\n\n### Task 3: Data Storage\n\nCreate in-memory storage for users and token blacklist.\n\n**Files:**\n- `src/store/users.ts`\n- `src/store/tokenBlacklist.ts`\n\n**User Store Functions:**\n```typescript\nfunction createUser(email: string, passwordHash: string): User\nfunction findUserById(id: string): User | undefined\nfunction findUserByEmail(email: string): User | undefined\nfunction getAllUsers(): User[]  // For testing only\nfunction clearUsers(): void     // For testing only\n```\n\n**Token Blacklist Functions:**\n```typescript\nfunction addToBlacklist(token: string): void\nfunction isBlacklisted(token: string): boolean\nfunction clearBlacklist(): void  // For testing only\n```\n\n**Acceptance Criteria:**\n- [ ] `createUser` generates unique UUID and stores user\n- [ ] `findUserByEmail` returns user or undefined\n- [ ] `findUserById` returns user or undefined\n- [ ] `addToBlacklist` prevents token from passing `isBlacklisted`\n- [ ] `clearUsers` and `clearBlacklist` reset state for tests\n\n### Task 4: Auth Middleware\n\nCreate middleware to protect routes.\n\n**Files:**\n- `src/middleware/auth.ts`\n\n**Behavior:**\n1. Extract token from `Authorization` header (format: `Bearer <token>`)\n2. If no header or wrong format, return 401 with `{ \"error\": \"Authorization token required\" }`\n3. Verify token using `verifyToken`\n4. If invalid/expired, return 401 with `{ \"error\": \"Invalid or expired token\" }`\n5. Check if token is blacklisted\n6. If blacklisted, return 401 with `{ \"error\": \"Token has been invalidated\" }`\n7. Look up user by ID from token payload\n8. If user not found, return 401 with `{ \"error\": \"User not found\" }`\n9. Attach user (without passwordHash) to `req.user`\n10. Call `next()`\n\n**Acceptance Criteria:**\n- [ ] Rejects requests without Authorization header\n- [ ] Rejects requests with malformed header\n- [ ] Rejects requests with invalid token\n- [ ] Rejects requests with blacklisted token\n- [ ] Attaches user to request for valid token\n- [ ] Does not expose passwordHash on req.user\n\n### Task 5: Auth Routes\n\nImplement authentication endpoints.\n\n**Files:**\n- `src/routes/auth.ts`\n\n**Validation Rules:**\n- Email: Must match basic email regex `/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/`\n- Password: Minimum 8 characters\n\n**Route Implementations:**\n\n1. `POST /register`\n   - Validate email format\n   - Validate password length >= 8\n   - Check email not already registered\n   - Hash password and create user\n   - Return 201 with user (no password)\n\n2. `POST /login`\n   - Validate required fields present\n   - Find user by email\n   - Compare password\n   - Generate and return token with user\n\n3. `POST /logout` (protected)\n   - Add current token to blacklist\n   - Return success message\n\n4. `GET /me` (protected)\n   - Return req.user (already attached by middleware)\n\n**Acceptance Criteria:**\n- [ ] Registration validates email format\n- [ ] Registration validates password length\n- [ ] Registration rejects duplicate emails\n- [ ] Login returns token for valid credentials\n- [ ] Login rejects invalid credentials\n- [ ] Logout invalidates token\n- [ ] `/me` returns user data\n\n### Task 6: Application Entry Point\n\nWire everything together.\n\n**Files:**\n- `src/index.ts`\n\n**Setup:**\n1. Load environment variables with dotenv\n2. Create Express app\n3. Add JSON body parser middleware\n4. Mount auth routes at `/auth`\n5. Add 404 handler\n6. Add error handler\n7. Start server on configured port\n\n**Acceptance Criteria:**\n- [ ] `npm run dev` starts server\n- [ ] Server responds to health check\n- [ ] Auth routes are accessible at `/auth/*`\n\n### Task 7: Tests\n\nWrite comprehensive tests for the auth system.\n\n**Files:**\n- `src/__tests__/utils/auth.test.ts`\n- `src/__tests__/routes/auth.test.ts`\n\n**Unit Tests (auth utilities):**\n- hashPassword produces bcrypt hash\n- comparePassword validates correctly\n- generateToken creates valid JWT\n- verifyToken decodes valid token\n- verifyToken rejects invalid token\n- verifyToken rejects expired token\n\n**Integration Tests (auth routes):**\n- Register: success creates user\n- Register: fails with invalid email\n- Register: fails with short password\n- Register: fails with duplicate email\n- Login: success returns token\n- Login: fails with wrong password\n- Login: fails with unknown email\n- Logout: invalidates token\n- Me: returns user with valid token\n- Me: rejects without token\n- Me: rejects blacklisted token\n\n**Acceptance Criteria:**\n- [ ] `npm test` runs without errors\n- [ ] All tests pass\n- [ ] Coverage includes happy paths and error cases\n\n## File Structure\n\n```\nexisting-api/\n├── .env.example\n├── package.json\n├── tsconfig.json\n├── jest.config.js\n├── src/\n│   ├── index.ts\n│   ├── config.ts\n│   ├── types/\n│   │   ├── user.ts\n│   │   └── auth.ts\n│   ├── utils/\n│   │   └── auth.ts\n│   ├── store/\n│   │   ├── users.ts\n│   │   └── tokenBlacklist.ts\n│   ├── middleware/\n│   │   └── auth.ts\n│   ├── routes/\n│   │   ├── auth.ts\n│   │   └── users.ts (existing)\n│   └── __tests__/\n│       ├── utils/\n│       │   └── auth.test.ts\n│       └── routes/\n│           └── auth.test.ts\n```\n\n## Security Considerations\n\n1. **JWT Secret**: Must be at least 32 characters, loaded from environment\n2. **Password Storage**: bcrypt with cost factor 10 (never store plaintext)\n3. **Token Blacklist**: Prevents use of logged-out tokens\n4. **No Password Exposure**: Never include passwordHash in API responses\n5. **Generic Error Messages**: Login failures use \"Invalid email or password\" (don't reveal which is wrong)\n6. **Token Expiration**: Default 1 hour, configurable via environment\n\n## Testing Commands\n\n```bash\n# Install dependencies\nnpm install\n\n# Run in development mode\nnpm run dev\n\n# Build TypeScript\nnpm run build\n\n# Run production build\nnpm start\n\n# Run tests\nnpm test\n\n# Manual testing\ncurl -X POST http://localhost:3000/auth/register \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"test@example.com\",\"password\":\"password123\"}'\n\ncurl -X POST http://localhost:3000/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"test@example.com\",\"password\":\"password123\"}'\n```\n",
      "score": {
        "structure": 20,
        "content": 30,
        "quality": 0,
        "total": 50,
        "violations": [
          "Missing phase organization",
          "Tasks missing Verify sections",
          "Found 11 code blocks outside Verify sections",
          "Task count 33 outside expected range 2-6",
          "Contains forbidden term: npm install",
          "Contains forbidden term: ```typescript"
        ]
      },
      "violations": [
        "Missing phase organization",
        "Tasks missing Verify sections",
        "Found 11 code blocks outside Verify sections",
        "Task count 33 outside expected range 2-6",
        "Contains forbidden term: npm install",
        "Contains forbidden term: ```typescript"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/existing-api",
        "Error: Command failed: ralphie spec --headless --auto --cwd \"/tmp/ralphie-test/existing-api\" \"Add JWT authentication to the existing REST API with login, logout, and protected routes\"",
        "SPEC.md exists despite error: 11680 bytes"
      ]
    },
    {
      "id": "brownfield-refactor",
      "name": "Brownfield: Refactor to TypeScript",
      "timestamp": "2026-01-16T17:46:09.249Z",
      "duration_ms": 202798,
      "success": false,
      "spec_created": true,
      "task_count": 0,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# JavaScript to TypeScript Refactoring\n\n## Overview\n\nMigrate the existing JavaScript codebase to TypeScript with proper types and architectural separation of concerns (data layer, business logic, API handlers).\n\n## Goals\n\n1. **Type Safety**: Strict TypeScript compilation with no `any` types\n2. **Separation of Concerns**: Clear boundaries between data access, business logic, and HTTP handling\n3. **Testability**: Dependency injection via interfaces for easy mocking\n4. **Behavior Preservation**: Refactored code must produce identical output for identical input\n\n## Current State Analysis\n\n**Files:**\n```\nsrc/\n  db.js   → exports { getUser: (id) => ({id, name: \"test\"}) }\n  api.js  → exports { handler: (req, res) => res.json(db.getUser(req.params.id)) }\n```\n\n**Current Behavior:**\n- `db.getUser(id)` returns `{id, name: \"test\"}` for any input\n- `api.handler(req, res)` calls `db.getUser` with `req.params.id` and sends JSON response\n- No input validation on `id` parameter\n- Tight coupling between handler and data layer\n\n## Target Architecture\n\n```\nsrc/\n  data/\n    types.ts           → Domain interfaces (User)\n    user.repository.ts → Data access (implements interface)\n  services/\n    user.service.ts    → Business logic layer\n  handlers/\n    user.handler.ts    → HTTP layer (framework-agnostic)\n  index.ts             → Composition root, public exports\n```\n\n**Layer Dependencies:**\n```\nhandlers → services → data/repository → data/types\n                ↓\n            data/types\n```\n\n## Implementation Tasks\n\n### Task 1: Initialize TypeScript Configuration\n\n**Create `package.json`:**\n```json\n{\n  \"name\": \"js-project\",\n  \"version\": \"1.0.0\",\n  \"main\": \"dist/index.js\",\n  \"types\": \"dist/index.d.ts\",\n  \"scripts\": {\n    \"build\": \"tsc\",\n    \"build:check\": \"tsc --noEmit\",\n    \"start\": \"node dist/index.js\"\n  },\n  \"devDependencies\": {\n    \"typescript\": \"^5.0.0\"\n  }\n}\n```\n\n**Create `tsconfig.json`:**\n```json\n{\n  \"compilerOptions\": {\n    \"target\": \"ES2020\",\n    \"module\": \"commonjs\",\n    \"lib\": [\"ES2020\"],\n    \"strict\": true,\n    \"esModuleInterop\": true,\n    \"skipLibCheck\": true,\n    \"forceConsistentCasingInFileNames\": true,\n    \"outDir\": \"./dist\",\n    \"rootDir\": \"./src\",\n    \"declaration\": true,\n    \"declarationMap\": true,\n    \"sourceMap\": true,\n    \"noImplicitReturns\": true,\n    \"noFallthroughCasesInSwitch\": true,\n    \"noUncheckedIndexedAccess\": true\n  },\n  \"include\": [\"src/**/*\"],\n  \"exclude\": [\"node_modules\", \"dist\"]\n}\n```\n\n**Verification:**\n```bash\nnpm install\nnpx tsc --version  # Should output TypeScript version 5.x\n```\n\n### Task 2: Create Data Layer\n\n**Create `src/data/types.ts`:**\n```typescript\n/**\n * Core domain types for the application.\n */\n\nexport interface User {\n  readonly id: number;\n  readonly name: string;\n}\n\n/**\n * Repository interface for user data access.\n * Implementations can be swapped for testing or different data sources.\n */\nexport interface IUserRepository {\n  getUser(id: number): User;\n}\n```\n\n**Create `src/data/user.repository.ts`:**\n```typescript\nimport { User, IUserRepository } from './types';\n\n/**\n * In-memory user repository implementation.\n * Returns stub data matching original db.js behavior.\n */\nexport class UserRepository implements IUserRepository {\n  getUser(id: number): User {\n    // Preserves original behavior: returns {id, name: \"test\"} for any id\n    return { id, name: 'test' };\n  }\n}\n```\n\n**Verification:**\n```bash\nnpx tsc --noEmit  # Should complete with no errors\n```\n\n### Task 3: Create Service Layer\n\n**Create `src/services/user.service.ts`:**\n```typescript\nimport { User, IUserRepository } from '../data/types';\n\n/**\n * Service interface for dependency injection.\n */\nexport interface IUserService {\n  getUserById(id: number): User | null;\n}\n\n/**\n * User business logic service.\n * Adds validation and business rules on top of raw data access.\n */\nexport class UserService implements IUserService {\n  constructor(private readonly userRepository: IUserRepository) {}\n\n  /**\n   * Retrieves a user by ID with validation.\n   * @param id - User ID (must be positive integer)\n   * @returns User object or null if invalid ID\n   */\n  getUserById(id: number): User | null {\n    // Business rule: reject non-positive IDs\n    if (!Number.isInteger(id) || id <= 0) {\n      return null;\n    }\n    return this.userRepository.getUser(id);\n  }\n}\n```\n\n**Verification:**\n```bash\nnpx tsc --noEmit  # Should complete with no errors\n```\n\n### Task 4: Create Handler Layer\n\n**Create `src/handlers/user.handler.ts`:**\n```typescript\nimport { IUserService } from '../services/user.service';\n\n/**\n * Framework-agnostic request interface.\n * Compatible with Express, Koa, Fastify, etc.\n */\nexport interface Request {\n  readonly params: { readonly id?: string };\n}\n\n/**\n * Framework-agnostic response interface.\n */\nexport interface Response {\n  json(data: unknown): void;\n  status(code: number): Response;\n}\n\n/**\n * HTTP handler for user endpoints.\n */\nexport class UserHandler {\n  constructor(private readonly userService: IUserService) {}\n\n  /**\n   * GET /users/:id handler\n   * Parses ID from params, validates, and returns user or error.\n   */\n  getUser(req: Request, res: Response): void {\n    const rawId = req.params.id;\n\n    if (rawId === undefined) {\n      res.status(400).json({ error: 'Missing user ID' });\n      return;\n    }\n\n    const id = parseInt(rawId, 10);\n\n    if (isNaN(id)) {\n      res.status(400).json({ error: 'Invalid user ID format' });\n      return;\n    }\n\n    const user = this.userService.getUserById(id);\n\n    if (user === null) {\n      res.status(404).json({ error: 'User not found' });\n      return;\n    }\n\n    res.json(user);\n  }\n}\n```\n\n**Verification:**\n```bash\nnpx tsc --noEmit  # Should complete with no errors\n```\n\n### Task 5: Create Entry Point\n\n**Create `src/index.ts`:**\n```typescript\n// Re-export public types\nexport type { User, IUserRepository } from './data/types';\nexport type { IUserService } from './services/user.service';\nexport type { Request, Response } from './handlers/user.handler';\n\n// Re-export implementations\nexport { UserRepository } from './data/user.repository';\nexport { UserService } from './services/user.service';\nexport { UserHandler } from './handlers/user.handler';\n\n// Composition root - wires dependencies together\nimport { UserRepository } from './data/user.repository';\nimport { UserService } from './services/user.service';\nimport { UserHandler } from './handlers/user.handler';\n\n/**\n * Factory function that creates a fully-wired UserHandler.\n * This is the main entry point for consumers.\n */\nexport function createUserHandler(): UserHandler {\n  const repository = new UserRepository();\n  const service = new UserService(repository);\n  return new UserHandler(service);\n}\n```\n\n**Verification:**\n```bash\nnpx tsc --noEmit  # Should complete with no errors\n```\n\n### Task 6: Build, Test, and Clean Up\n\n**Build the project:**\n```bash\nnpm run build\n```\n\n**Verify build output:**\n```bash\nls -la dist/\n# Should contain: index.js, index.d.ts, and subdirectories for data/, services/, handlers/\n```\n\n**Test the module loads correctly:**\n```bash\nnode -e \"\n  const m = require('./dist');\n  console.log('createUserHandler:', typeof m.createUserHandler);\n  console.log('UserHandler:', typeof m.UserHandler);\n  console.log('UserService:', typeof m.UserService);\n  console.log('UserRepository:', typeof m.UserRepository);\n\n  // Functional test\n  const handler = m.createUserHandler();\n  let result = null;\n  const mockRes = {\n    json: (data) => { result = data; },\n    status: () => mockRes\n  };\n  handler.getUser({ params: { id: '42' } }, mockRes);\n  console.log('Result:', JSON.stringify(result));\n  console.log('Expected: {\\\"id\\\":42,\\\"name\\\":\\\"test\\\"}');\n\"\n```\n\n**Remove old JavaScript files:**\n```bash\nrm src/db.js src/api.js\n```\n\n**Final verification:**\n```bash\n# Confirm no JS files in src/\nls src/**/*.js 2>/dev/null && echo \"ERROR: JS files found\" || echo \"OK: No JS files in src/\"\n\n# Confirm build still works\nnpm run build\n```\n\n## Acceptance Criteria\n\n| Criterion | Verification |\n|-----------|--------------|\n| `npm run build` succeeds | Exit code 0, no errors |\n| Strict TypeScript | `tsconfig.json` has `\"strict\": true` |\n| No `any` types | `grep -r \": any\" src/` returns nothing |\n| Layer separation | Each layer in separate directory |\n| Interfaces for DI | `IUserRepository`, `IUserService` exist |\n| No JS in src/ | `ls src/**/*.js` finds nothing |\n| Types exported | `dist/index.d.ts` contains type exports |\n| Behavior preserved | `createUserHandler` returns handler that responds with `{id, name}` |\n\n## Notes\n\n- The original `api.js` did not validate the `id` parameter. The new implementation adds validation (returns 400 for non-numeric, 404 for invalid IDs). This is an intentional improvement.\n- Interfaces (`IUserRepository`, `IUserService`) enable unit testing with mocks without requiring a DI framework.\n- The `Request` and `Response` interfaces are framework-agnostic and can work with Express, Fastify, or any similar HTTP framework.\n",
      "score": {
        "structure": 10,
        "content": 30,
        "quality": 1,
        "total": 41,
        "violations": [
          "Missing phase organization",
          "Tasks missing checkboxes",
          "Tasks missing Verify sections",
          "Found 20 code blocks outside Verify sections",
          "Task count 0 outside expected range 2-6",
          "Contains forbidden term: ```typescript"
        ]
      },
      "violations": [
        "Missing phase organization",
        "Tasks missing checkboxes",
        "Tasks missing Verify sections",
        "Found 20 code blocks outside Verify sections",
        "Task count 0 outside expected range 2-6",
        "Contains forbidden term: ```typescript"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/js-project",
        "Error: Command failed: ralphie spec --headless --auto --cwd \"/tmp/ralphie-test/js-project\" \"Refactor the existing JavaScript codebase to TypeScript with proper types and separation of concerns between data layer, business logic, and API handlers\"",
        "SPEC.md exists despite error: 8971 bytes"
      ]
    },
    {
      "id": "cli-tool",
      "name": "Greenfield: CLI File Organizer",
      "timestamp": "2026-01-16T17:51:09.553Z",
      "duration_ms": 300303,
      "success": false,
      "spec_created": true,
      "task_count": 19,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# File Organizer CLI (`forg`)\n\nA command-line tool that organizes files by type, date, or custom rules with full undo support.\n\n## Overview\n\n### Problem\nDirectories accumulate disorganized files over time. Manual organization is tedious and error-prone. Existing tools lack undo capability, making mistakes costly.\n\n### Solution\n`forg` provides automated file organization with:\n- Built-in strategies (by type, date, size)\n- Custom rule engine for complex patterns\n- Full undo support for any operation\n- Dry-run preview before execution\n\n## Requirements\n\n### Functional Requirements\n\n1. **File Scanning**: Recursively scan directories, extract metadata (size, dates, extension, MIME type)\n2. **Organization Strategies**: Organize by file type, date, or size with configurable options\n3. **Custom Rules**: YAML-based rule files with glob/regex patterns, date/size filters\n4. **Undo System**: Log all operations, support undo by operation ID or most recent\n5. **Safety**: Dry-run mode, conflict resolution, exclude patterns, backup option\n\n### Non-Functional Requirements\n\n1. **Performance**: Handle 10,000+ files without blocking; show progress for operations >1s\n2. **Reliability**: Atomic operations where possible; graceful handling of permission errors\n3. **Usability**: Clear error messages; colored output; JSON mode for scripting\n\n## Architecture\n\n```\nsrc/\n├── cli.ts              # Entry point, argument parsing\n├── commands/\n│   ├── scan.ts         # File scanning command\n│   ├── organize.ts     # Organization command\n│   ├── undo.ts         # Undo command\n│   └── history.ts      # History listing command\n├── core/\n│   ├── scanner.ts      # Directory scanning logic\n│   ├── organizer.ts    # File organization engine\n│   ├── rules.ts        # Rule parsing and matching\n│   └── history.ts      # Operation logging\n├── strategies/\n│   ├── by-type.ts      # Type-based organization\n│   ├── by-date.ts      # Date-based organization\n│   └── by-size.ts      # Size-based organization\n└── utils/\n    ├── fs.ts           # File system utilities\n    ├── output.ts       # Terminal output formatting\n    └── config.ts       # Configuration loading\n```\n\n## Tasks\n\n### Phase 1: Project Setup\n\n- [ ] **Initialize TypeScript project**\n  - Create package.json with `\"bin\": { \"forg\": \"./dist/cli.js\" }`\n  - Configure tsconfig.json with strict mode, ES2022 target\n  - Add build script using tsc\n  - Add dev dependencies: typescript, @types/node\n\n  **Verify:**\n  ```bash\n  npm run build  # Completes without errors\n  ls dist/cli.js  # File exists\n  ```\n\n- [ ] **Set up CLI framework**\n  - Install commander.js for argument parsing\n  - Create src/cli.ts with --help and --version flags\n  - Add shebang line for direct execution\n\n  **Verify:**\n  ```bash\n  ./dist/cli.js --help     # Shows \"Usage: forg [options] [command]\"\n  ./dist/cli.js --version  # Shows version from package.json\n  ```\n\n### Phase 2: File Scanning\n\n- [ ] **Implement directory scanner**\n  - Create src/core/scanner.ts\n  - Recursive directory traversal with configurable max depth (default: unlimited)\n  - Return array of FileInfo objects: `{ path, name, ext, size, created, modified, isSymlink }`\n  - Handle permission errors gracefully (skip with warning, continue scanning)\n\n  **Verify:**\n  ```bash\n  # Unit test: scanner returns correct file count for test directory\n  # Unit test: scanner respects depth limit\n  # Unit test: scanner handles permission denied without crashing\n  ```\n\n- [ ] **Implement scan command**\n  - Create src/commands/scan.ts\n  - Accept directory path as argument\n  - Options: --depth, --include-hidden, --follow-symlinks\n  - Output: list of files with metadata in table format\n\n  **Verify:**\n  ```bash\n  forg scan ./test-fixtures              # Lists files with size, date, type\n  forg scan ./test-fixtures --depth 1    # Only immediate children\n  forg scan /nonexistent                 # Error: \"Directory not found: /nonexistent\"\n  ```\n\n### Phase 3: Organization Strategies\n\n- [ ] **Implement type-based organization**\n  - Create src/strategies/by-type.ts\n  - Categories: images (jpg,png,gif,svg), documents (pdf,doc,txt,md), videos (mp4,mov,avi), audio (mp3,wav,flac), code (js,ts,py,go), archives (zip,tar,gz), other\n  - Return list of planned moves: `{ from: string, to: string }[]`\n\n  **Verify:**\n  ```bash\n  # Unit test: photo.jpg → images/photo.jpg\n  # Unit test: unknown.xyz → other/unknown.xyz\n  # Unit test: handles files without extension\n  ```\n\n- [ ] **Implement date-based organization**\n  - Create src/strategies/by-date.ts\n  - Options: --date-field (created|modified), --format (YYYY/MM | YYYY-MM-DD | YYYY)\n  - Parse date from file metadata\n\n  **Verify:**\n  ```bash\n  # Unit test: file from 2024-03-15 with format \"YYYY/MM\" → 2024/03/filename\n  # Unit test: file from 2024-03-15 with format \"YYYY-MM-DD\" → 2024-03-15/filename\n  ```\n\n- [ ] **Implement size-based organization**\n  - Create src/strategies/by-size.ts\n  - Default thresholds: small (<1MB), medium (1MB-100MB), large (>100MB)\n  - Option: --thresholds \"1MB,100MB\" to customize\n\n  **Verify:**\n  ```bash\n  # Unit test: 500KB file → small/filename\n  # Unit test: 50MB file → medium/filename\n  # Unit test: custom thresholds respected\n  ```\n\n- [ ] **Implement organize command**\n  - Create src/commands/organize.ts\n  - Accept directory and strategy: `forg organize <dir> --by <type|date|size>`\n  - Options: --dry-run, --output (table|json)\n  - Execute file moves when not in dry-run mode\n\n  **Verify:**\n  ```bash\n  forg organize ./messy --by type --dry-run  # Shows plan, no files moved\n  forg organize ./messy --by type            # Files actually moved\n  forg organize ./messy --by date --format \"YYYY/MM\"  # Date folders created\n  ```\n\n### Phase 4: Custom Rules Engine\n\n- [ ] **Implement rule parser**\n  - Create src/core/rules.ts\n  - Parse YAML rule files with schema validation\n  - Rule structure:\n    ```yaml\n    rules:\n      - name: \"Screenshots\"\n        match:\n          pattern: \"Screenshot*.png\"  # glob pattern\n        destination: \"screenshots/\"\n      - name: \"Old documents\"\n        match:\n          extension: [\".doc\", \".docx\"]\n          older_than: \"2023-01-01\"\n        destination: \"archive/old-docs/\"\n    ```\n  - Support: glob patterns, regex, extension lists, date ranges, size ranges\n\n  **Verify:**\n  ```bash\n  # Unit test: glob pattern \"*.jpg\" matches \"photo.jpg\"\n  # Unit test: date filter \"older_than: 2023-01-01\" works\n  # Unit test: invalid YAML returns clear error with line number\n  ```\n\n- [ ] **Implement rule-based organization**\n  - Apply rules in order (first match wins)\n  - Fallback destination for unmatched files (optional)\n  - Integrate with organize command: `forg organize <dir> --rules <file.yaml>`\n\n  **Verify:**\n  ```bash\n  forg organize ./dir --rules ./rules.yaml --dry-run  # Shows rule-based plan\n  forg validate-rules ./rules.yaml                     # Validates without executing\n  ```\n\n### Phase 5: Undo System\n\n- [ ] **Implement operation logger**\n  - Create src/core/history.ts\n  - Store operations in ~/.forg/history/<timestamp>-<id>.json\n  - Operation format:\n    ```json\n    {\n      \"id\": \"abc123\",\n      \"timestamp\": \"2024-03-15T10:30:00Z\",\n      \"command\": \"organize ./messy --by type\",\n      \"moves\": [\n        { \"from\": \"/path/to/file.jpg\", \"to\": \"/path/to/images/file.jpg\", \"checksum\": \"sha256...\" }\n      ]\n    }\n    ```\n  - Store file checksum for detecting post-operation modifications\n\n  **Verify:**\n  ```bash\n  # After organize: ~/.forg/history/ contains operation file\n  # Operation file has valid JSON with all required fields\n  ```\n\n- [ ] **Implement undo command**\n  - Create src/commands/undo.ts\n  - `forg undo` - undo most recent operation\n  - `forg undo <id>` - undo specific operation\n  - Before undo: verify files still exist, warn if checksums don't match\n  - Move files back to original locations\n\n  **Verify:**\n  ```bash\n  forg organize ./test --by type && forg undo  # Files return to original locations\n  # Modify a file after organize, then undo → warning about modified file\n  forg undo nonexistent-id  # Error: \"Operation not found: nonexistent-id\"\n  ```\n\n- [ ] **Implement history command**\n  - Create src/commands/history.ts\n  - List recent operations with: ID, timestamp, command, file count\n  - Options: --limit (default 10), --json\n\n  **Verify:**\n  ```bash\n  forg history           # Shows last 10 operations\n  forg history --limit 5 # Shows last 5 operations\n  forg history --json    # Valid JSON array output\n  ```\n\n### Phase 6: Safety Features\n\n- [ ] **Implement conflict resolution**\n  - Detect when destination file already exists\n  - Strategies: rename (file_1.txt), skip, overwrite, prompt\n  - Default: rename with incrementing suffix\n  - Option: --on-conflict <rename|skip|overwrite|prompt>\n\n  **Verify:**\n  ```bash\n  # Two files with same name → second becomes filename_1.ext\n  forg organize ./dir --on-conflict skip  # Skips conflicts with warning\n  forg organize ./dir --on-conflict prompt --dry-run  # Shows what would prompt\n  ```\n\n- [ ] **Implement exclude patterns**\n  - Option: --exclude \"pattern1,pattern2\"\n  - Default excludes: node_modules, .git, .DS_Store\n  - Support glob patterns in excludes\n\n  **Verify:**\n  ```bash\n  forg organize ./project --exclude \"node_modules,*.tmp\"  # Skips matching\n  forg organize ./project --no-default-excludes           # Includes node_modules\n  ```\n\n- [ ] **Implement backup option**\n  - Option: --backup\n  - Create timestamped copy of directory before organizing\n  - Location: <original>_backup_<timestamp>/\n\n  **Verify:**\n  ```bash\n  forg organize ./dir --backup  # Creates ./dir_backup_20240315_103000/\n  ```\n\n### Phase 7: Configuration and Polish\n\n- [ ] **Implement global configuration**\n  - Config file: ~/.forg/config.yaml\n  - Configurable: default excludes, conflict strategy, output format\n  - CLI flags override config file\n\n  **Verify:**\n  ```bash\n  # With config setting output=json: forg scan ./dir outputs JSON\n  # With --output table flag: overrides config, outputs table\n  ```\n\n- [ ] **Implement output formatting**\n  - Colored terminal output (green success, red error, yellow warning)\n  - Quiet mode (--quiet): only errors\n  - Verbose mode (--verbose): debug information\n  - JSON mode (--output json): machine-readable output\n\n  **Verify:**\n  ```bash\n  forg organize ./dir --quiet    # Only shows errors if any\n  forg organize ./dir --verbose  # Shows detailed progress\n  forg scan ./dir --output json | jq .  # Valid JSON, parseable\n  ```\n\n- [ ] **Add progress indicators**\n  - Show progress bar for operations with >100 files\n  - Display: files processed / total, elapsed time\n  - Disable progress in quiet mode or non-TTY output\n\n  **Verify:**\n  ```bash\n  forg organize ./large-dir  # Shows progress bar\n  forg organize ./large-dir --quiet  # No progress bar\n  forg organize ./large-dir | cat  # No progress bar (piped output)\n  ```\n\n## Example Rule File\n\n```yaml\n# ~/.forg/rules/photos.yaml\nrules:\n  - name: Screenshots\n    match:\n      pattern: \"Screenshot*.png\"\n    destination: screenshots/\n\n  - name: Camera photos\n    match:\n      pattern: \"IMG_*.{jpg,jpeg,heic}\"\n    destination: photos/camera/\n\n  - name: Old documents\n    match:\n      extension: [\".pdf\", \".doc\", \".docx\"]\n      older_than: \"2022-01-01\"\n    destination: archive/old-docs/\n\n  - name: Large videos\n    match:\n      extension: [\".mp4\", \".mov\"]\n      larger_than: \"500MB\"\n    destination: videos/large/\n\n  - name: Work files\n    match:\n      regex: \".*_(work|project)_.*\"\n    destination: work/\n\n# Files not matching any rule stay in place (or use fallback)\nfallback: unsorted/\n```\n\n## CLI Reference\n\n```\nforg - File Organizer CLI\n\nUsage:\n  forg <command> [options]\n\nCommands:\n  scan <dir>              Scan directory and show file metadata\n  organize <dir>          Organize files in directory\n  undo [id]               Undo an operation (most recent if no ID)\n  history                 Show operation history\n  validate-rules <file>   Validate a rules file\n\nGlobal Options:\n  -h, --help              Show help\n  -v, --version           Show version\n  -q, --quiet             Minimal output\n  --verbose               Detailed output\n  --output <format>       Output format: table, json\n\nScan Options:\n  --depth <n>             Max directory depth (default: unlimited)\n  --include-hidden        Include hidden files\n  --follow-symlinks       Follow symbolic links\n\nOrganize Options:\n  --by <strategy>         Strategy: type, date, size\n  --rules <file>          Custom rules file\n  --dry-run               Show plan without executing\n  --format <fmt>          Date format (for --by date): YYYY/MM, YYYY-MM-DD\n  --thresholds <sizes>    Size thresholds (for --by size): \"1MB,100MB\"\n  --on-conflict <mode>    Conflict handling: rename, skip, overwrite, prompt\n  --exclude <patterns>    Exclude patterns (comma-separated)\n  --backup                Create backup before organizing\n\nHistory Options:\n  --limit <n>             Number of operations to show (default: 10)\n```\n\n## Error Handling\n\n| Scenario | Behavior |\n|----------|----------|\n| Directory not found | Error: \"Directory not found: <path>\" |\n| Permission denied (read) | Warning, skip file, continue |\n| Permission denied (write) | Error: \"Cannot write to: <path>\" |\n| Invalid rules file | Error with line number: \"Invalid rule at line 5: ...\" |\n| Operation ID not found | Error: \"Operation not found: <id>\" |\n| File modified since operation | Warning: \"File modified since operation: <path>. Proceed? [y/N]\" |\n| Disk full during move | Error, attempt to rollback completed moves |\n\n## Testing Strategy\n\n1. **Unit tests**: Core logic (scanner, strategies, rule parser, history)\n2. **Integration tests**: Full command execution with temp directories\n3. **Test fixtures**: Directory with sample files for manual testing\n\n```bash\nnpm test           # Run all tests\nnpm run test:unit  # Unit tests only\nnpm run test:e2e   # Integration tests\n```\n",
      "score": {
        "structure": 35,
        "content": 30,
        "quality": 1,
        "total": 66,
        "violations": [
          "Missing ## Goal section",
          "Found 3 code blocks outside Verify sections",
          "Task count 19 outside expected range 3-7",
          "Contains forbidden term: ```"
        ]
      },
      "violations": [
        "Missing ## Goal section",
        "Found 3 code blocks outside Verify sections",
        "Task count 19 outside expected range 3-7",
        "Contains forbidden term: ```"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/file-organizer",
        "Error: spawnSync /bin/sh ETIMEDOUT",
        "SPEC.md exists despite error: 13890 bytes"
      ]
    }
  ],
  "summary": {
    "total": 6,
    "passed": 0,
    "failed": 6,
    "avg_score": 59.7,
    "avg_duration_ms": 274774
  }
}
{
  "phase": "after",
  "timestamp": "2026-01-16T18:18:22.306Z",
  "git_ref": "100f7496db17ec4918f74c0b2e7d05d3f519affe",
  "results": [
    {
      "id": "greenfield-game-engine",
      "name": "Greenfield: Game Engine",
      "timestamp": "2026-01-16T17:56:31.681Z",
      "duration_ms": 300177,
      "success": false,
      "spec_created": true,
      "task_count": 28,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# 2D Game Engine\n\nA TypeScript-based 2D game engine providing sprite rendering, physics simulation, and input handling for browser-based games.\n\n## Goal\n\nCreate a modular, performant 2D game engine that developers can use to build browser games with sprite-based graphics, basic physics (collision detection, velocity, gravity), and keyboard/mouse input handling.\n\n## Requirements\n\n### Functional Requirements\n\n- **Rendering**: Draw sprites, shapes, and text to a canvas with z-order layering and camera support\n- **Physics**: Simulate gravity, velocity, and detect/respond to collisions between objects\n- **Input**: Handle keyboard and mouse input with clean APIs for game logic\n- **Game Loop**: Provide a stable update/render loop with delta time handling\n\n### Non-Functional Requirements\n\n- **Performance**: Maintain 60fps with 100+ active sprites and physics bodies\n- **Bundle Size**: Production build under 50KB minified (no external runtime dependencies)\n- **Browser Support**: Chrome, Firefox, Safari, Edge (latest 2 versions)\n- **TypeScript**: Full type safety with strict mode, exported types for consumers\n\n## Project Structure\n\n```\ngame-engine/\n├── src/\n│   ├── index.ts              # Public API exports\n│   ├── core/\n│   │   ├── Vector2.ts        # 2D vector math utilities\n│   │   ├── Engine.ts         # Main engine class, game loop\n│   │   ├── Component.ts      # Base component class\n│   │   ├── Entity.ts         # Base entity with components\n│   │   ├── Scene.ts          # Scene container and management\n│   │   ├── EventEmitter.ts   # Event system for pub/sub\n│   │   └── AssetLoader.ts    # Asset loading with progress\n│   ├── rendering/\n│   │   ├── Renderer.ts       # Canvas2D wrapper\n│   │   ├── Camera.ts         # Viewport and transforms\n│   │   ├── Sprite.ts         # Sprite rendering component\n│   │   ├── Texture.ts        # Texture loading and caching\n│   │   └── Animation.ts      # Sprite animation\n│   ├── physics/\n│   │   ├── PhysicsWorld.ts   # Physics simulation\n│   │   ├── RigidBody.ts      # Physics body component\n│   │   └── Collision.ts      # Collision detection algorithms\n│   ├── input/\n│   │   ├── Keyboard.ts       # Keyboard input\n│   │   └── Mouse.ts          # Mouse/pointer input\n│   └── debug/\n│       └── DebugOverlay.ts   # Debug rendering overlay\n├── tests/\n│   ├── setup.ts              # Test setup and mocks\n│   ├── core/\n│   │   ├── Vector2.test.ts\n│   │   ├── Engine.test.ts\n│   │   ├── Entity.test.ts\n│   │   └── Scene.test.ts\n│   ├── rendering/\n│   │   ├── Camera.test.ts\n│   │   ├── Sprite.test.ts\n│   │   ├── Texture.test.ts\n│   │   └── Animation.test.ts\n│   ├── physics/\n│   │   ├── PhysicsWorld.test.ts\n│   │   ├── RigidBody.test.ts\n│   │   └── Collision.test.ts\n│   └── input/\n│       ├── Keyboard.test.ts\n│       └── Mouse.test.ts\n├── demo/\n│   ├── index.html            # Demo page\n│   ├── demo.ts               # Demo game code\n│   └── assets/               # Demo game assets\n│       └── sprites/\n├── package.json\n├── tsconfig.json\n├── vite.config.ts\n└── vitest.config.ts\n```\n\n## Public API\n\n### Type Definitions\n\n```typescript\n// Configuration options\ninterface EngineOptions {\n  width?: number              // Canvas width (default: 800)\n  height?: number             // Canvas height (default: 600)\n  backgroundColor?: string    // Clear color (default: '#000000')\n  pixelRatio?: number         // Device pixel ratio (default: window.devicePixelRatio)\n  debug?: boolean             // Enable debug overlay (default: false)\n}\n\ninterface AnimationOptions {\n  frameRate?: number          // Frames per second (default: 12)\n  loop?: boolean              // Loop animation (default: true)\n  pingPong?: boolean          // Reverse at end (default: false)\n}\n\ninterface AnimationFrame {\n  texture: Texture            // Frame texture\n  duration?: number           // Override frame duration in ms\n}\n\ninterface FollowOptions {\n  lerp?: number               // Smoothing factor 0-1 (default: 0.1)\n  offset?: Vector2            // Offset from target\n  deadzone?: { x: number; y: number }  // Area where camera doesn't move\n}\n\ninterface Contact {\n  point: Vector2              // Contact point in world space\n  normal: Vector2             // Contact normal (from A to B)\n  penetration: number         // Overlap depth\n}\n\ninterface RaycastHit {\n  body: RigidBody             // Hit body\n  point: Vector2              // Hit point in world space\n  normal: Vector2             // Surface normal at hit point\n  distance: number            // Distance from ray origin\n}\n\ninterface Texture {\n  width: number\n  height: number\n  image: HTMLImageElement\n}\n\ninterface SpriteSheet {\n  texture: Texture\n  frameWidth: number\n  frameHeight: number\n  frames: Texture[]           // Pre-sliced frame textures\n  getFrame(index: number): Texture\n  getFrameByRowCol(row: number, col: number): Texture\n}\n\ninterface ColliderShape {\n  type: 'aabb' | 'circle'\n  // For AABB: width, height\n  // For circle: radius\n}\n\ninterface AABB {\n  type: 'aabb'\n  width: number\n  height: number\n  offset?: Vector2            // Offset from entity center\n}\n\ninterface Circle {\n  type: 'circle'\n  radius: number\n  offset?: Vector2            // Offset from entity center\n}\n\ntype Collider = AABB | Circle\n\n// Component type helper for getComponent<T>()\ntype ComponentType<T extends Component> = new (...args: any[]) => T\n```\n\n### Core Classes\n\n```typescript\n// 2D Vector utility\nclass Vector2 {\n  x: number\n  y: number\n\n  constructor(x?: number, y?: number)\n\n  // Instance methods (return new Vector2, immutable)\n  add(v: Vector2): Vector2\n  subtract(v: Vector2): Vector2\n  multiply(scalar: number): Vector2\n  divide(scalar: number): Vector2\n  normalize(): Vector2\n  negate(): Vector2\n  perpendicular(): Vector2\n  clone(): Vector2\n\n  // Scalar results\n  magnitude(): number\n  magnitudeSquared(): number\n  dot(v: Vector2): number\n  cross(v: Vector2): number       // 2D cross product (scalar)\n  angle(): number                 // Angle in radians\n\n  // Comparison\n  equals(v: Vector2, epsilon?: number): boolean\n\n  // Static factory methods\n  static zero(): Vector2\n  static one(): Vector2\n  static up(): Vector2\n  static down(): Vector2\n  static left(): Vector2\n  static right(): Vector2\n\n  // Static utility methods\n  static distance(a: Vector2, b: Vector2): number\n  static distanceSquared(a: Vector2, b: Vector2): number\n  static lerp(a: Vector2, b: Vector2, t: number): Vector2\n  static fromAngle(radians: number): Vector2\n  static angleBetween(a: Vector2, b: Vector2): number\n}\n\n// Main engine\nclass Engine {\n  readonly renderer: Renderer\n  readonly keyboard: Keyboard\n  readonly mouse: Mouse\n  readonly physics: PhysicsWorld\n\n  constructor(canvas: HTMLCanvasElement, options?: EngineOptions)\n\n  start(): void\n  stop(): void\n  pause(): void\n  resume(): void\n\n  addScene(name: string, scene: Scene): void\n  setScene(name: string): void\n  getScene(): Scene | null\n  getCurrentSceneName(): string | null\n\n  // Event hooks\n  onUpdate: ((deltaTime: number) => void) | null\n  onRender: ((renderer: Renderer) => void) | null\n}\n\n// Base component\nabstract class Component {\n  readonly entity: Entity | null\n\n  // Lifecycle hooks (override in subclasses)\n  protected onAdd(): void\n  protected onRemove(): void\n  protected onUpdate(deltaTime: number): void\n  protected onRender(renderer: Renderer): void\n}\n\n// Game entity\nclass Entity {\n  position: Vector2\n  rotation: number              // Radians\n  scale: Vector2\n  tag: string\n  layer: number                 // Render order (higher = on top)\n  active: boolean               // If false, skips update\n\n  constructor()\n\n  addComponent<T extends Component>(component: T): T\n  removeComponent<T extends Component>(component: T): void\n  getComponent<T extends Component>(type: ComponentType<T>): T | null\n  hasComponent<T extends Component>(type: ComponentType<T>): boolean\n  getComponents(): Component[]\n\n  destroy(): void\n}\n\n// Scene container\nclass Scene extends EventEmitter {\n  readonly camera: Camera\n\n  constructor()\n\n  addEntity(entity: Entity): void\n  removeEntity(entity: Entity): void\n  getEntities(): Entity[]\n  findByTag(tag: string): Entity[]\n  findById(id: number): Entity | null\n\n  // Lifecycle\n  onEnter(): void               // Called when scene becomes active\n  onExit(): void                // Called when scene becomes inactive\n}\n\n// Event system\nclass EventEmitter {\n  on(event: string, callback: (...args: any[]) => void): void\n  off(event: string, callback: (...args: any[]) => void): void\n  once(event: string, callback: (...args: any[]) => void): void\n  emit(event: string, ...args: any[]): void\n  removeAllListeners(event?: string): void\n}\n```\n\n### Rendering Classes\n\n```typescript\n// Canvas renderer\nclass Renderer {\n  readonly width: number\n  readonly height: number\n  readonly canvas: HTMLCanvasElement\n  readonly context: CanvasRenderingContext2D\n\n  // Drawing primitives\n  clear(color?: string): void\n  drawRect(x: number, y: number, width: number, height: number, color: string): void\n  fillRect(x: number, y: number, width: number, height: number, color: string): void\n  drawCircle(x: number, y: number, radius: number, color: string): void\n  fillCircle(x: number, y: number, radius: number, color: string): void\n  drawLine(x1: number, y1: number, x2: number, y2: number, color: string, lineWidth?: number): void\n  drawText(text: string, x: number, y: number, options?: TextOptions): void\n\n  // Sprite drawing\n  drawTexture(texture: Texture, x: number, y: number, options?: DrawOptions): void\n  drawTextureRegion(\n    texture: Texture,\n    sx: number, sy: number, sw: number, sh: number,\n    dx: number, dy: number, dw: number, dh: number\n  ): void\n\n  // Transform stack\n  save(): void\n  restore(): void\n  translate(x: number, y: number): void\n  rotate(radians: number): void\n  scaleTransform(x: number, y: number): void\n}\n\ninterface TextOptions {\n  font?: string               // CSS font string (default: '16px sans-serif')\n  color?: string              // Fill color (default: '#ffffff')\n  align?: CanvasTextAlign     // Text alignment (default: 'left')\n  baseline?: CanvasTextBaseline\n}\n\ninterface DrawOptions {\n  width?: number              // Override texture width\n  height?: number             // Override texture height\n  anchorX?: number            // 0-1, default 0.5\n  anchorY?: number            // 0-1, default 0.5\n  rotation?: number           // Radians\n  alpha?: number              // 0-1, default 1\n  scaleX?: number             // Default 1\n  scaleY?: number             // Default 1\n}\n\n// Camera/viewport\nclass Camera {\n  position: Vector2\n  zoom: number\n  rotation: number\n\n  constructor(width: number, height: number)\n\n  // Coordinate conversion\n  worldToScreen(worldPos: Vector2): Vector2\n  screenToWorld(screenPos: Vector2): Vector2\n\n  // Viewport bounds\n  getBounds(): { left: number; right: number; top: number; bottom: number }\n  isInView(position: Vector2, margin?: number): boolean\n\n  // Following\n  follow(entity: Entity, options?: FollowOptions): void\n  stopFollowing(): void\n  update(deltaTime: number): void\n\n  // Apply transform to renderer\n  apply(renderer: Renderer): void\n}\n\n// Sprite component\nclass Sprite extends Component {\n  texture: Texture | null\n  width: number\n  height: number\n  anchorX: number             // 0-1, default 0.5\n  anchorY: number             // 0-1, default 0.5\n  alpha: number               // 0-1, default 1\n  visible: boolean\n  flipX: boolean\n  flipY: boolean\n  tint: string | null         // Color tint\n\n  constructor(texture?: Texture)\n}\n\n// Animation controller\nclass Animation {\n  readonly currentFrame: number\n  readonly isPlaying: boolean\n  readonly isComplete: boolean\n\n  constructor(frames: AnimationFrame[], options?: AnimationOptions)\n\n  play(): void\n  pause(): void\n  stop(): void                // Resets to frame 0\n  restart(): void\n\n  getCurrentTexture(): Texture | null\n  update(deltaTime: number): void\n\n  // Events\n  onComplete: (() => void) | null\n  onFrameChange: ((frame: number) => void) | null\n}\n```\n\n### Physics Classes\n\n```typescript\n// Physics simulation\nclass PhysicsWorld {\n  gravity: Vector2\n  iterations: number          // Solver iterations (default: 4)\n\n  constructor(gravity?: Vector2)\n\n  addBody(body: RigidBody): void\n  removeBody(body: RigidBody): void\n  getBodies(): RigidBody[]\n\n  update(deltaTime: number): void\n\n  // Queries\n  raycast(origin: Vector2, direction: Vector2, maxDistance: number, mask?: number): RaycastHit | null\n  queryPoint(point: Vector2, mask?: number): RigidBody[]\n  queryRect(x: number, y: number, width: number, height: number, mask?: number): RigidBody[]\n}\n\n// Physics body component\nclass RigidBody extends Component {\n  velocity: Vector2\n  acceleration: Vector2\n  angularVelocity: number\n  mass: number                // Default: 1\n  restitution: number         // Bounciness 0-1 (default: 0)\n  friction: number            // Surface friction (default: 0.1)\n  drag: number                // Linear drag (default: 0)\n  angularDrag: number         // Rotational drag (default: 0)\n\n  isKinematic: boolean        // If true, not affected by physics\n  isTrigger: boolean          // If true, detects collision but doesn't respond\n  isStatic: boolean           // If true, immovable (infinite mass)\n\n  collider: Collider\n  collisionLayer: number      // This body's layer (bitmask)\n  collisionMask: number       // Layers this body collides with (bitmask)\n\n  constructor(collider: Collider)\n\n  // Apply forces\n  applyForce(force: Vector2): void\n  applyImpulse(impulse: Vector2): void\n  applyForceAtPoint(force: Vector2, point: Vector2): void\n\n  // Collision callbacks\n  onCollisionEnter: ((other: RigidBody, contact: Contact) => void) | null\n  onCollisionStay: ((other: RigidBody, contact: Contact) => void) | null\n  onCollisionExit: ((other: RigidBody) => void) | null\n  onTriggerEnter: ((other: RigidBody) => void) | null\n  onTriggerExit: ((other: RigidBody) => void) | null\n}\n```\n\n### Input Classes\n\n```typescript\n// Keyboard input\nclass Keyboard {\n  // State queries\n  isPressed(key: string): boolean   // True only on frame key went down\n  isHeld(key: string): boolean      // True while key is down\n  isReleased(key: string): boolean  // True only on frame key went up\n\n  // Action bindings\n  bindAction(action: string, keys: string[]): void\n  unbindAction(action: string): void\n  isActionPressed(action: string): boolean\n  isActionHeld(action: string): boolean\n  isActionReleased(action: string): boolean\n\n  // Raw access\n  getHeldKeys(): string[]\n\n  // Lifecycle\n  update(): void              // Called by engine, clears per-frame states\n  dispose(): void             // Remove event listeners\n}\n\n// Mouse input\nclass Mouse {\n  readonly position: Vector2        // Screen coordinates\n  readonly worldPosition: Vector2   // World coordinates (needs camera)\n  readonly wheelDelta: number       // Scroll delta this frame\n\n  constructor(canvas: HTMLCanvasElement, camera: Camera)\n\n  // Button states (0=left, 1=middle, 2=right)\n  isButtonDown(button: number): boolean\n  isButtonPressed(button: number): boolean   // This frame only\n  isButtonReleased(button: number): boolean  // This frame only\n\n  // Utility\n  isInCanvas(): boolean\n\n  // Lifecycle\n  update(): void\n  dispose(): void\n}\n```\n\n### Utility Functions\n\n```typescript\n// Texture loading\nfunction loadTexture(url: string): Promise<Texture>\nfunction loadSpriteSheet(\n  url: string,\n  frameWidth: number,\n  frameHeight: number\n): Promise<SpriteSheet>\n\n// Asset loading\nclass AssetLoader {\n  constructor()\n\n  // Queue assets\n  addTexture(key: string, url: string): this\n  addSpriteSheet(key: string, url: string, frameWidth: number, frameHeight: number): this\n  addAudio(key: string, url: string): this\n\n  // Load all queued assets\n  load(onProgress?: (progress: number) => void): Promise<void>\n\n  // Retrieve loaded assets\n  getTexture(key: string): Texture\n  getSpriteSheet(key: string): SpriteSheet\n  getAudio(key: string): HTMLAudioElement\n}\n\n// Math utilities\nfunction clamp(value: number, min: number, max: number): number\nfunction lerp(a: number, b: number, t: number): number\nfunction inverseLerp(a: number, b: number, value: number): number\nfunction remap(value: number, inMin: number, inMax: number, outMin: number, outMax: number): number\nfunction randomRange(min: number, max: number): number\nfunction randomInt(min: number, max: number): number\nfunction degToRad(degrees: number): number\nfunction radToDeg(radians: number): number\n```\n\n## Tasks\n\n### Phase 1: Project Setup & Core Architecture\n\n- [ ] Initialize TypeScript project with Vite and Vitest\n  - Create package.json with build/dev/test scripts\n  - Configure TypeScript with strict mode and ES2020 target\n  - Set up Vite for dev server and library build output\n  - Configure Vitest for unit testing with jsdom environment\n  - Create index.html with canvas element\n\n  **Files:** `package.json`, `tsconfig.json`, `vite.config.ts`, `vitest.config.ts`, `index.html`, `tests/setup.ts`\n\n  **Verify:**\n  - `npm install` completes without errors\n  - `npm run dev` starts dev server on localhost:5173\n  - `npm run build` produces `dist/` with ES module and type declarations\n  - `npm test` runs Vitest and passes (empty test suite)\n  - Browser shows canvas element at specified dimensions\n\n- [ ] Implement Vector2 utility class\n  - Basic math operations (add, subtract, multiply, divide)\n  - Normalization, magnitude, dot product, cross product\n  - Static factory methods (zero, one, up, down, left, right)\n  - Static helper methods (distance, lerp, fromAngle, angleBetween)\n  - Immutability: all operations return new Vector2 instances\n\n  **Files:** `src/core/Vector2.ts`, `tests/core/Vector2.test.ts`\n\n  **Verify:**\n  - All unit tests pass\n  - Operations return new vectors (immutable)\n  - Edge cases: zero vectors, normalization of zero vector\n\n- [ ] Implement EventEmitter utility class\n  - on/off/once methods for event subscription\n  - emit method for triggering events\n  - removeAllListeners for cleanup\n  - Type-safe event handling\n\n  **Files:** `src/core/EventEmitter.ts`, `tests/core/EventEmitter.test.ts`\n\n  **Verify:**\n  - Events fire with correct arguments\n  - once() fires only once then auto-removes\n  - off() removes specific listener\n  - removeAllListeners cleans up properly\n\n- [ ] Create game loop and Engine class\n  - RequestAnimationFrame-based render loop\n  - Fixed timestep physics update (1/60 second)\n  - Accumulator pattern for frame-independent physics\n  - Delta time calculation for variable rendering\n  - Start/stop/pause/resume controls\n\n  **Files:** `src/core/Engine.ts`, `tests/core/Engine.test.ts`\n\n  **Verify:**\n  - Engine calls update with consistent delta time\n  - Physics runs at 60Hz regardless of frame rate\n  - Pause stops updates but not the loop\n  - Stop cleanly halts and can restart\n\n- [ ] Build Component base class\n  - Abstract class with lifecycle hooks\n  - onAdd/onRemove called during component attach/detach\n  - onUpdate called each frame with deltaTime\n  - onRender called each frame with Renderer\n  - Reference to owning Entity\n\n  **Files:** `src/core/Component.ts`\n\n  **Verify:**\n  - Abstract class cannot be instantiated directly\n  - Lifecycle methods can be overridden\n\n- [ ] Build Entity class\n  - Position, rotation, scale properties\n  - Tag for identification, layer for render order\n  - Active flag to skip updates\n  - Type-safe component add/remove/get\n  - Destroy method with cleanup\n\n  **Files:** `src/core/Entity.ts`, `tests/core/Entity.test.ts`\n\n  **Verify:**\n  - Components are added and lifecycle fires\n  - getComponent returns correct type\n  - Destroy removes entity from scene and cleans up components\n\n- [ ] Implement Scene management\n  - Entity container with add/remove\n  - Camera instance per scene\n  - findByTag and findById queries\n  - onEnter/onExit lifecycle hooks\n  - Inherits from EventEmitter\n\n  **Files:** `src/core/Scene.ts`, `tests/core/Scene.test.ts`\n\n  **Verify:**\n  - Entities update when scene is active\n  - Scene switching fires enter/exit hooks\n  - findByTag returns matching entities\n\n### Phase 2: Rendering System\n\n- [ ] Create Renderer wrapper for Canvas2D\n  - Initialize canvas with devicePixelRatio scaling\n  - Clear screen with background color\n  - Draw primitives: rect, circle, line (stroke and fill variants)\n  - Draw text with configurable font, color, alignment\n  - Transform stack: save, restore, translate, rotate, scale\n\n  **Files:** `src/rendering/Renderer.ts`\n\n  **Verify:**\n  - Demo draws shapes at correct positions\n  - Text renders with specified options\n  - Transform stack correctly applies/reverts\n\n- [ ] Implement Camera system\n  - Position, zoom, rotation properties\n  - worldToScreen and screenToWorld conversion\n  - getBounds returns visible area\n  - isInView for culling checks\n  - apply() method sets renderer transform\n  - follow() with lerp smoothing and deadzone\n\n  **Files:** `src/rendering/Camera.ts`, `tests/rendering/Camera.test.ts`\n\n  **Verify:**\n  - Coordinate conversion is accurate (round trip)\n  - Zoom scales around camera center\n  - Follow smoothly tracks entity with deadzone\n\n- [ ] Add texture loading utilities\n  - loadTexture returns Promise<Texture>\n  - Internal cache prevents duplicate loads\n  - loadSpriteSheet parses grid-based sheets\n  - SpriteSheet provides getFrame/getFrameByRowCol\n\n  **Files:** `src/rendering/Texture.ts`, `tests/rendering/Texture.test.ts`\n\n  **Verify:**\n  - loadTexture resolves with valid Texture\n  - Same URL returns cached texture instance\n  - SpriteSheet frames are extracted correctly\n\n- [ ] Build Sprite component\n  - Texture reference with width/height\n  - Anchor point (0-1 range) for rotation center\n  - Alpha transparency, visible toggle\n  - flipX/flipY for mirroring\n  - Renders in onRender using entity transform\n\n  **Files:** `src/rendering/Sprite.ts`, `tests/rendering/Sprite.test.ts`\n\n  **Verify:**\n  - Sprite renders at entity position\n  - Anchor affects rotation pivot\n  - Alpha 0 = invisible, flip mirrors correctly\n\n- [ ] Implement Animation system\n  - Frame sequence with per-frame textures\n  - Configurable frame rate\n  - Play/pause/stop/restart controls\n  - Loop and ping-pong modes\n  - onComplete and onFrameChange callbacks\n\n  **Files:** `src/rendering/Animation.ts`, `tests/rendering/Animation.test.ts`\n\n  **Verify:**\n  - Frames advance at correct rate\n  - Ping-pong reverses direction\n  - onComplete fires when non-looping animation ends\n\n### Phase 3: Physics System\n\n- [ ] Create PhysicsWorld simulation\n  - Fixed timestep update (called from Engine)\n  - Gravity property affecting dynamic bodies\n  - Body add/remove management\n  - Collision detection broad phase (simple N^2 for now)\n  - Collision response with separation and velocity reflection\n\n  **Files:** `src/physics/PhysicsWorld.ts`, `tests/physics/PhysicsWorld.test.ts`\n\n  **Verify:**\n  - Bodies fall with gravity\n  - Add/remove doesn't cause errors\n  - Performance: 100 bodies at 60fps\n\n- [ ] Implement collision detection algorithms\n  - AABB vs AABB overlap test\n  - Circle vs Circle overlap test\n  - AABB vs Circle overlap test\n  - Generate Contact with point, normal, penetration\n  - Collision layer/mask filtering\n\n  **Files:** `src/physics/Collision.ts`, `tests/physics/Collision.test.ts`\n\n  **Verify:**\n  - All shape combinations detect correctly\n  - Non-overlapping returns null\n  - Contact normal points A to B\n\n- [ ] Implement RigidBody component\n  - Velocity, acceleration, angular velocity\n  - Mass, restitution (bounce), friction, drag\n  - isKinematic (code-controlled), isStatic (immovable), isTrigger (no response)\n  - Collider shape (AABB or Circle)\n  - applyForce, applyImpulse methods\n  - Collision callbacks (enter/stay/exit, trigger variants)\n\n  **Files:** `src/physics/RigidBody.ts`, `tests/physics/RigidBody.test.ts`\n\n  **Verify:**\n  - Dynamic body affected by gravity and forces\n  - Kinematic body moves but ignores physics\n  - Static body never moves\n  - Trigger detects but doesn't push\n\n- [ ] Add collision response and events\n  - Separate overlapping bodies along contact normal\n  - Apply impulse based on restitution and mass\n  - Track collision state for enter/stay/exit events\n  - Fire callbacks at correct times\n\n  **Files:** Update `src/physics/PhysicsWorld.ts`\n\n  **Verify:**\n  - Bodies don't tunnel through each other\n  - Callbacks fire: enter on first contact, stay while touching, exit when separated\n  - Trigger callbacks work independently\n\n- [ ] Implement physics queries\n  - raycast: find first body along ray\n  - queryPoint: find bodies containing point\n  - queryRect: find bodies overlapping rectangle\n  - All queries respect collision mask\n\n  **Files:** Update `src/physics/PhysicsWorld.ts`\n\n  **Verify:**\n  - Raycast returns nearest hit\n  - Point query finds overlapping bodies\n  - Mask filtering works for all queries\n\n### Phase 4: Input System\n\n- [ ] Implement Keyboard input handler\n  - Track key states: pressed (just down), held (down), released (just up)\n  - Handle keydown/keyup DOM events\n  - Per-frame state reset in update()\n  - dispose() to remove listeners\n\n  **Files:** `src/input/Keyboard.ts`, `tests/input/Keyboard.test.ts`\n\n  **Verify:**\n  - isPressed true only first frame\n  - isHeld true while down\n  - isReleased true only frame of release\n\n- [ ] Add action binding system\n  - bindAction maps action name to multiple keys\n  - isActionPressed/Held/Released check any bound key\n  - unbindAction removes mapping\n\n  **Files:** Update `src/input/Keyboard.ts`\n\n  **Verify:**\n  - Action works with any of its bound keys\n  - Unbind removes action entirely\n\n- [ ] Implement Mouse input handler\n  - Track position in screen coordinates\n  - Track position in world coordinates (using camera)\n  - Button states (down/pressed/released) for left/middle/right\n  - Wheel delta for scroll\n  - dispose() to remove listeners\n\n  **Files:** `src/input/Mouse.ts`, `tests/input/Mouse.test.ts`\n\n  **Verify:**\n  - Position updates on move\n  - worldPosition accounts for camera\n  - Button states work like keyboard\n  - Wheel delta captured\n\n### Phase 5: Integration & Polish\n\n- [ ] Wire systems together in Engine\n  - Engine creates Renderer, PhysicsWorld, Keyboard, Mouse\n  - Scene update calls entity updates, which call component updates\n  - Render loop applies camera transform, renders entities by layer\n  - Input update called at end of frame\n\n  **Files:** Update `src/core/Engine.ts`\n\n  **Verify:**\n  - All systems accessible from Engine\n  - Entity components update and render\n  - Layer ordering works (higher layer renders on top)\n\n- [ ] Create AssetLoader utility\n  - Queue textures, sprite sheets, audio\n  - load() returns Promise, fires progress callback\n  - get methods retrieve loaded assets by key\n  - Error handling with descriptive messages\n\n  **Files:** `src/core/AssetLoader.ts`, `tests/core/AssetLoader.test.ts`\n\n  **Verify:**\n  - Multiple assets load in parallel\n  - Progress 0-1 during load\n  - Missing key throws helpful error\n\n- [ ] Add math utility functions\n  - clamp, lerp, inverseLerp, remap\n  - randomRange, randomInt\n  - degToRad, radToDeg\n\n  **Files:** `src/core/MathUtils.ts`, `tests/core/MathUtils.test.ts`\n\n  **Verify:**\n  - All functions work with edge cases\n  - Random functions stay in range\n\n- [ ] Add debug overlay\n  - FPS counter (rolling average)\n  - Entity count, body count\n  - Toggle with configurable key (default: F3)\n  - Minimal performance impact when disabled\n\n  **Files:** `src/debug/DebugOverlay.ts`\n\n  **Verify:**\n  - Shows accurate FPS\n  - Counts match actual entities/bodies\n  - Toggle works\n\n- [ ] Build public API exports\n  - index.ts exports all public classes, interfaces, functions\n  - Configure Vite for library build with .d.ts generation\n  - Ensure tree-shaking works\n\n  **Files:** `src/index.ts`, update `vite.config.ts`\n\n  **Verify:**\n  - Import { Engine, Sprite, RigidBody, Vector2 } works\n  - Types available for TypeScript consumers\n  - Unused imports don't increase bundle\n\n### Phase 6: Demo & Documentation\n\n- [ ] Create demo platformer game\n  - Player entity with Sprite and RigidBody\n  - Arrow key movement, space to jump\n  - Platform tiles with static RigidBody\n  - Collectible coins (trigger collision)\n  - Score display using drawText\n  - Camera follows player\n\n  **Files:** `demo/demo.ts`, `demo/index.html`, demo assets\n\n  **Verify:**\n  - Player moves left/right, jumps\n  - Player lands on platforms\n  - Coins disappear on contact, score increases\n  - Camera follows player smoothly\n\n- [ ] Write unit tests for edge cases\n  - Physics tunneling prevention\n  - Input handling across focus changes\n  - Animation completion states\n  - Camera bounds at extreme zoom\n\n  **Verify:**\n  - `npm test` passes all tests\n  - Coverage > 80%\n\n- [ ] Add JSDoc documentation\n  - Document all public classes and methods\n  - Include @param, @returns, @example\n  - Document interfaces and types\n\n  **Files:** JSDoc in all src/ files\n\n  **Verify:**\n  - IDE shows documentation on hover\n  - All public APIs documented\n\n## Acceptance Criteria\n\nThe engine is complete when:\n\n1. **Demo runs**: Platformer demo loads and plays in Chrome, Firefox, Safari, Edge\n2. **Tests pass**: `npm test` passes with >80% coverage\n3. **Builds clean**: `npm run build` produces <50KB minified bundle\n4. **Types work**: Consumers get full TypeScript support with autocomplete\n5. **Performance**: Demo maintains 60fps with 100+ sprites and physics bodies\n6. **No runtime dependencies**: Bundle contains only engine code, no external libraries\n",
      "score": {
        "structure": 45,
        "content": 30,
        "quality": 0,
        "total": 75,
        "violations": [
          "Found 7 code blocks outside Verify sections",
          "Task count 28 outside expected range 3-8",
          "Contains forbidden term: npm install",
          "Contains forbidden term: ```typescript"
        ]
      },
      "violations": [
        "Found 7 code blocks outside Verify sections",
        "Task count 28 outside expected range 3-8",
        "Contains forbidden term: npm install",
        "Contains forbidden term: ```typescript"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/game-engine",
        "Error: spawnSync /bin/sh ETIMEDOUT",
        "SPEC.md exists despite error: 29411 bytes"
      ]
    },
    {
      "id": "greenfield-frontend",
      "name": "Greenfield: React Dashboard",
      "timestamp": "2026-01-16T18:01:31.993Z",
      "duration_ms": 300310,
      "success": false,
      "spec_created": true,
      "task_count": 19,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# React Dashboard\n\nA real-time dashboard application featuring interactive charts, data tables, and WebSocket-powered live updates.\n\n## Goal\n\nBuild a production-ready React dashboard that displays business metrics through charts and tables, with real-time data synchronization via WebSocket connections.\n\n## Technology Stack\n\n| Category | Choice | Version | Rationale |\n|----------|--------|---------|-----------|\n| Framework | React + TypeScript | ^18.2.0 | Type safety, modern React features |\n| Build Tool | Vite | ^5.0.0 | Fast HMR, optimized production builds |\n| Styling | Tailwind CSS | ^3.4.0 | Rapid UI development, consistent design |\n| Charts | Recharts | ^2.10.0 | React-native, composable, good TypeScript support |\n| State | React Context + useReducer | (built-in) | Sufficient for dashboard scope, no external deps |\n| Testing | Vitest + React Testing Library | ^1.0.0 / ^14.0.0 | Vite-native, fast execution |\n| WebSocket | Native WebSocket API | (built-in) | No library needed for basic pub/sub |\n\n## Architecture\n\n```\nsrc/\n├── components/\n│   ├── charts/\n│   │   ├── LineChart.tsx\n│   │   ├── BarChart.tsx\n│   │   ├── PieChart.tsx\n│   │   └── ChartWrapper.tsx\n│   ├── tables/\n│   │   ├── DataTable.tsx\n│   │   ├── TablePagination.tsx\n│   │   └── TableSearch.tsx\n│   ├── layout/\n│   │   ├── DashboardLayout.tsx\n│   │   ├── Sidebar.tsx\n│   │   └── Header.tsx\n│   └── common/\n│       ├── Card.tsx\n│       ├── MetricCard.tsx\n│       ├── StatusIndicator.tsx\n│       ├── LoadingSkeleton.tsx\n│       └── ErrorBoundary.tsx\n├── hooks/\n│   ├── useWebSocket.ts\n│   ├── useMetrics.ts\n│   └── useDataTable.ts\n├── services/\n│   ├── websocket.ts\n│   └── mockData.ts\n├── types/\n│   └── index.ts\n├── context/\n│   └── DashboardContext.tsx\n├── App.tsx\n└── main.tsx\n```\n\n## Data Models\n\n```typescript\n// src/types/index.ts\n\nexport interface Metric {\n  id: string;\n  name: string;\n  value: number;\n  previousValue: number;\n  unit: string;\n  trend: 'up' | 'down' | 'stable';\n  updatedAt: string;\n}\n\nexport interface TimeSeriesPoint {\n  timestamp: string;\n  value: number;\n  label?: string;\n}\n\nexport interface TimeSeries {\n  id: string;\n  name: string;\n  color: string;\n  data: TimeSeriesPoint[];\n}\n\nexport interface ActivityEvent {\n  id: string;\n  type: 'sale' | 'signup' | 'error' | 'alert';\n  description: string;\n  amount?: number;\n  timestamp: string;\n  status: 'success' | 'warning' | 'error';\n}\n\nexport interface WebSocketMessage {\n  type: 'metric_update' | 'activity' | 'heartbeat';\n  payload: Metric | ActivityEvent | null;\n  timestamp: string;\n}\n\nexport type ConnectionStatus = 'connecting' | 'connected' | 'disconnected' | 'reconnecting';\n\nexport interface Column<T> {\n  key: keyof T;\n  header: string;\n  sortable?: boolean;\n  render?: (value: T[keyof T], row: T) => React.ReactNode;\n  width?: string;\n}\n\nexport interface TableState {\n  page: number;\n  pageSize: number;\n  sortKey: string | null;\n  sortDirection: 'asc' | 'desc';\n  searchQuery: string;\n}\n\nexport interface DashboardState {\n  metrics: Metric[];\n  activities: ActivityEvent[];\n  timeSeries: TimeSeries[];\n  timeRange: '7d' | '30d' | '90d';\n  connectionStatus: ConnectionStatus;\n  lastUpdated: string | null;\n}\n\nexport type DashboardAction =\n  | { type: 'UPDATE_METRIC'; payload: Metric }\n  | { type: 'ADD_ACTIVITY'; payload: ActivityEvent }\n  | { type: 'SET_TIME_RANGE'; payload: '7d' | '30d' | '90d' }\n  | { type: 'SET_CONNECTION_STATUS'; payload: ConnectionStatus }\n  | { type: 'SET_METRICS'; payload: Metric[] }\n  | { type: 'SET_TIME_SERIES'; payload: TimeSeries[] }\n  | { type: 'SET_ACTIVITIES'; payload: ActivityEvent[] };\n```\n\n## Tasks\n\n### Phase 1: Project Setup\n\n- [ ] **Task 1.1: Initialize Vite project**\n\n  Commands:\n  ```bash\n  npm create vite@latest . -- --template react-ts\n  npm install\n  ```\n\n  Files created: `package.json`, `vite.config.ts`, `tsconfig.json`, `index.html`, `src/main.tsx`, `src/App.tsx`\n\n  **Acceptance Criteria:**\n  - `npm run dev` starts server at http://localhost:5173 without errors\n  - `npm run build` completes with exit code 0\n\n- [ ] **Task 1.2: Install and configure dependencies**\n\n  Commands:\n  ```bash\n  npm install recharts\n  npm install -D tailwindcss postcss autoprefixer\n  npm install -D vitest @testing-library/react @testing-library/jest-dom jsdom\n  npx tailwindcss init -p\n  ```\n\n  Files to create/modify:\n\n  `tailwind.config.js`:\n  ```javascript\n  /** @type {import('tailwindcss').Config} */\n  export default {\n    content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'],\n    theme: { extend: {} },\n    plugins: [],\n  }\n  ```\n\n  `src/index.css`:\n  ```css\n  @tailwind base;\n  @tailwind components;\n  @tailwind utilities;\n  ```\n\n  `vite.config.ts` (add path alias):\n  ```typescript\n  import { defineConfig } from 'vite'\n  import react from '@vitejs/plugin-react'\n  import path from 'path'\n\n  export default defineConfig({\n    plugins: [react()],\n    resolve: {\n      alias: {\n        '@': path.resolve(__dirname, './src'),\n      },\n    },\n    test: {\n      globals: true,\n      environment: 'jsdom',\n      setupFiles: './src/test/setup.ts',\n    },\n  })\n  ```\n\n  `tsconfig.json` (add paths):\n  ```json\n  {\n    \"compilerOptions\": {\n      \"baseUrl\": \".\",\n      \"paths\": { \"@/*\": [\"src/*\"] }\n    }\n  }\n  ```\n\n  `src/test/setup.ts`:\n  ```typescript\n  import '@testing-library/jest-dom'\n  ```\n\n  **Acceptance Criteria:**\n  - `npm run dev` shows Tailwind styles applied\n  - `npm test` runs without configuration errors\n  - Import `@/types` resolves correctly\n\n- [ ] **Task 1.3: Create directory structure and base files**\n\n  Create empty directories and placeholder files:\n  ```\n  src/components/charts/\n  src/components/tables/\n  src/components/layout/\n  src/components/common/\n  src/hooks/\n  src/services/\n  src/types/index.ts\n  src/context/\n  ```\n\n  Create `src/types/index.ts` with all interfaces from Data Models section.\n\n  **Acceptance Criteria:**\n  - All directories exist\n  - `src/types/index.ts` exports all types\n  - No TypeScript errors\n\n### Phase 2: Core Components\n\n- [ ] **Task 2.1: Create layout components**\n\n  Files to create:\n\n  `src/components/layout/DashboardLayout.tsx`:\n  - Props: `{ children: React.ReactNode }`\n  - CSS Grid: `grid-template-columns: 240px 1fr` on desktop\n  - Responsive: Single column on mobile (< 768px)\n\n  `src/components/layout/Sidebar.tsx`:\n  - Props: `{ isOpen: boolean; onToggle: () => void }`\n  - Fixed position on desktop, slide-out drawer on mobile\n  - Contains navigation items (Dashboard, Metrics, Activity)\n\n  `src/components/layout/Header.tsx`:\n  - Props: `{ title: string; connectionStatus: ConnectionStatus }`\n  - Displays title, connection status indicator, current time\n  - Mobile: hamburger menu button\n\n  **Acceptance Criteria:**\n  - Render `<DashboardLayout><div>Content</div></DashboardLayout>` shows two-column grid\n  - Resize to mobile width: sidebar hidden, hamburger visible\n  - Click hamburger: sidebar slides in from left\n\n- [ ] **Task 2.2: Create common UI components**\n\n  `src/components/common/Card.tsx`:\n  - Props: `{ title?: string; children: React.ReactNode; className?: string }`\n  - Renders: white background, rounded corners, shadow, padding\n\n  `src/components/common/MetricCard.tsx`:\n  - Props: `{ metric: Metric; isUpdating?: boolean }`\n  - Displays: name, value + unit, trend arrow (up/down), percent change\n  - Animation: pulse effect when `isUpdating` is true\n\n  `src/components/common/StatusIndicator.tsx`:\n  - Props: `{ status: ConnectionStatus }`\n  - Renders: colored dot (green=connected, yellow=reconnecting, red=disconnected)\n  - Includes status text label\n\n  `src/components/common/LoadingSkeleton.tsx`:\n  - Props: `{ variant: 'card' | 'table-row' | 'chart'; count?: number }`\n  - Renders: animated gray placeholder matching component dimensions\n\n  `src/components/common/ErrorBoundary.tsx`:\n  - Catches errors in children, displays error message with \"Retry\" button\n  - Props: `{ children: React.ReactNode; fallback?: React.ReactNode }`\n\n  **Acceptance Criteria:**\n  - `<MetricCard metric={sampleMetric} />` displays value with trend indicator\n  - `<StatusIndicator status=\"connected\" />` shows green dot\n  - `<LoadingSkeleton variant=\"card\" count={3} />` shows 3 skeleton cards\n\n- [ ] **Task 2.3: Implement Chart components**\n\n  `src/components/charts/ChartWrapper.tsx`:\n  - Props: `{ loading?: boolean; error?: Error; empty?: boolean; children: React.ReactNode; height?: number }`\n  - Shows LoadingSkeleton when loading\n  - Shows error message with retry when error\n  - Shows \"No data\" message when empty\n  - Wraps children in ResponsiveContainer when data present\n\n  `src/components/charts/LineChart.tsx`:\n  - Props: `{ data: TimeSeries[]; height?: number; showLegend?: boolean }`\n  - Uses Recharts: `<LineChart>`, `<Line>`, `<XAxis>`, `<YAxis>`, `<Tooltip>`, `<Legend>`\n  - Supports multiple series with different colors\n  - X-axis: formatted dates, Y-axis: auto-scaled values\n\n  `src/components/charts/BarChart.tsx`:\n  - Props: `{ data: { category: string; value: number; color?: string }[]; height?: number }`\n  - Uses Recharts: `<BarChart>`, `<Bar>`, `<XAxis>`, `<YAxis>`, `<Tooltip>`\n  - Vertical bars with category labels\n\n  `src/components/charts/PieChart.tsx`:\n  - Props: `{ data: { name: string; value: number; color?: string }[]; height?: number }`\n  - Uses Recharts: `<PieChart>`, `<Pie>`, `<Cell>`, `<Tooltip>`, `<Legend>`\n  - Shows percentage labels on segments\n\n  **Acceptance Criteria:**\n  ```tsx\n  // These should render without errors:\n  <LineChart data={[{ id: '1', name: 'Sales', color: '#3b82f6', data: [{timestamp: '2024-01-01', value: 100}] }]} />\n  <ChartWrapper loading={true}><div /></ChartWrapper> // Shows skeleton\n  <ChartWrapper empty={true}><div /></ChartWrapper>   // Shows \"No data\"\n  ```\n\n- [ ] **Task 2.4: Implement DataTable component**\n\n  `src/hooks/useDataTable.ts`:\n  - Generic hook: `useDataTable<T>(data: T[], initialPageSize?: number)`\n  - Returns: `{ displayData, page, pageSize, totalPages, sortKey, sortDirection, searchQuery, setPage, setSort, setSearch }`\n  - Handles: sorting, pagination, debounced search (300ms)\n\n  `src/components/tables/TableSearch.tsx`:\n  - Props: `{ value: string; onChange: (value: string) => void; placeholder?: string }`\n  - Input with search icon, clear button when has value\n\n  `src/components/tables/TablePagination.tsx`:\n  - Props: `{ page: number; totalPages: number; totalItems: number; pageSize: number; onPageChange: (page: number) => void }`\n  - Shows: \"Showing X-Y of Z\", prev/next buttons, page numbers\n\n  `src/components/tables/DataTable.tsx`:\n  - Props: `{ columns: Column<T>[]; data: T[]; pageSize?: number; loading?: boolean; emptyMessage?: string }`\n  - Integrates useDataTable hook internally\n  - Clickable headers with sort indicators (↑↓)\n  - Loading state: shows skeleton rows\n  - Empty state: shows message centered in table\n\n  **Acceptance Criteria:**\n  ```tsx\n  const columns = [\n    { key: 'name', header: 'Name', sortable: true },\n    { key: 'amount', header: 'Amount', sortable: true },\n  ];\n  <DataTable columns={columns} data={sampleData} pageSize={10} />\n  // Click \"Amount\" header: rows sorted by amount ascending\n  // Click again: sorted descending, shows ↓ indicator\n  // Type in search: filtered results after 300ms debounce\n  // 25 items with pageSize=10: shows 3 page buttons\n  ```\n\n### Phase 3: Data Layer\n\n- [ ] **Task 3.1: Create mock data generators**\n\n  `src/services/mockData.ts`:\n  ```typescript\n  export function generateMetrics(): Metric[]\n  // Returns 4 metrics: Revenue, Users, Orders, Conversion Rate\n  // Values: realistic ranges (revenue: 10k-100k, users: 1k-10k, etc.)\n  // Trend: calculated from value vs previousValue\n\n  export function generateTimeSeries(days: number): TimeSeries[]\n  // Returns 2-3 series (Revenue, Expenses, Profit)\n  // Each series has `days` data points\n  // Values: gradually trending with random variation\n\n  export function generateActivities(count: number): ActivityEvent[]\n  // Returns recent activity events\n  // Types distributed: 40% sale, 30% signup, 20% alert, 10% error\n  // Timestamps: spread over last 24 hours\n\n  export function generateRandomUpdate(): WebSocketMessage\n  // Returns a random metric_update or activity message\n  // Used by mock WebSocket\n  ```\n\n  **Acceptance Criteria:**\n  ```typescript\n  const metrics = generateMetrics();\n  expect(metrics).toHaveLength(4);\n  expect(metrics[0]).toMatchObject({ id: expect.any(String), value: expect.any(Number) });\n\n  const series = generateTimeSeries(30);\n  expect(series[0].data).toHaveLength(30);\n  ```\n\n- [ ] **Task 3.2: Implement WebSocket service**\n\n  `src/services/websocket.ts`:\n  ```typescript\n  export type MessageHandler = (message: WebSocketMessage) => void;\n\n  export class WebSocketManager {\n    private ws: WebSocket | null = null;\n    private url: string = '';\n    private handlers: Map<string, Set<MessageHandler>> = new Map();\n    private reconnectAttempts: number = 0;\n    private maxReconnectDelay: number = 30000;\n    private status: ConnectionStatus = 'disconnected';\n    private statusListeners: Set<(status: ConnectionStatus) => void> = new Set();\n\n    connect(url: string): void\n    // Creates WebSocket connection\n    // Sets up onopen, onclose, onerror, onmessage handlers\n    // Updates status to 'connecting', then 'connected' on success\n\n    disconnect(): void\n    // Closes with code 1000 (normal closure)\n    // Clears reconnect timeout\n    // Sets status to 'disconnected'\n\n    subscribe(type: string, handler: MessageHandler): () => void\n    // Adds handler to type's handler set\n    // Returns unsubscribe function\n\n    send(message: object): void\n    // JSON.stringify and send if connected\n    // Throws if not connected\n\n    onStatusChange(listener: (status: ConnectionStatus) => void): () => void\n    // Register status change listener, returns unsubscribe\n\n    private handleMessage(event: MessageEvent): void\n    // Parse JSON, route to handlers by message.type\n\n    private handleClose(): void\n    // Set status to 'reconnecting'\n    // Schedule reconnect with exponential backoff: min(1000 * 2^attempts, 30000)\n\n    private reconnect(): void\n    // Increment attempts, call connect()\n    // Reset attempts on successful connection\n  }\n\n  // Singleton for app-wide use\n  export const wsManager = new WebSocketManager();\n  ```\n\n  **Acceptance Criteria:**\n  - Unit test: subscribe/unsubscribe adds/removes handlers correctly\n  - Unit test: handleMessage routes to correct handlers\n  - Unit test: reconnect delay follows exponential backoff (1s, 2s, 4s, 8s, 16s, 30s, 30s...)\n\n- [ ] **Task 3.3: Create mock WebSocket for development**\n\n  Add to `src/services/websocket.ts`:\n  ```typescript\n  export class MockWebSocketManager extends WebSocketManager {\n    private intervalId: number | null = null;\n\n    connect(url: string): void {\n      // Simulate connection delay\n      setTimeout(() => {\n        this.setStatus('connected');\n        this.startMockUpdates();\n      }, 500);\n    }\n\n    private startMockUpdates(): void {\n      this.intervalId = window.setInterval(() => {\n        const message = generateRandomUpdate();\n        this.dispatchMessage(message);\n      }, 3000);\n    }\n\n    disconnect(): void {\n      if (this.intervalId) clearInterval(this.intervalId);\n      this.setStatus('disconnected');\n    }\n  }\n\n  // Export based on environment\n  export const wsManager = import.meta.env.VITE_USE_MOCK_WS === 'true'\n    ? new MockWebSocketManager()\n    : new WebSocketManager();\n  ```\n\n  Add to `.env.development`:\n  ```\n  VITE_USE_MOCK_WS=true\n  VITE_WS_URL=ws://localhost:8080\n  ```\n\n  **Acceptance Criteria:**\n  - With `VITE_USE_MOCK_WS=true`: dashboard receives mock updates every 3 seconds\n  - With `VITE_USE_MOCK_WS=false`: attempts real WebSocket connection to `VITE_WS_URL`\n\n- [ ] **Task 3.4: Create useWebSocket hook**\n\n  `src/hooks/useWebSocket.ts`:\n  ```typescript\n  export function useWebSocket(url?: string) {\n    const [status, setStatus] = useState<ConnectionStatus>('disconnected');\n    const [lastMessage, setLastMessage] = useState<WebSocketMessage | null>(null);\n\n    useEffect(() => {\n      const unsubStatus = wsManager.onStatusChange(setStatus);\n      wsManager.connect(url || import.meta.env.VITE_WS_URL);\n\n      return () => {\n        unsubStatus();\n        wsManager.disconnect();\n      };\n    }, [url]);\n\n    const subscribe = useCallback((type: string, handler: MessageHandler) => {\n      return wsManager.subscribe(type, handler);\n    }, []);\n\n    return { status, lastMessage, subscribe };\n  }\n  ```\n\n  **Acceptance Criteria:**\n  ```tsx\n  function TestComponent() {\n    const { status, subscribe } = useWebSocket();\n    useEffect(() => subscribe('metric_update', console.log), [subscribe]);\n    return <div>{status}</div>;\n  }\n  // Mounts: status shows 'connecting' then 'connected'\n  // Unmounts: WebSocket disconnects (no memory leak)\n  ```\n\n### Phase 4: Dashboard Integration\n\n- [ ] **Task 4.1: Create DashboardContext**\n\n  `src/context/DashboardContext.tsx`:\n  ```typescript\n  const initialState: DashboardState = {\n    metrics: [],\n    activities: [],\n    timeSeries: [],\n    timeRange: '30d',\n    connectionStatus: 'disconnected',\n    lastUpdated: null,\n  };\n\n  function dashboardReducer(state: DashboardState, action: DashboardAction): DashboardState {\n    switch (action.type) {\n      case 'UPDATE_METRIC':\n        return {\n          ...state,\n          metrics: state.metrics.map(m =>\n            m.id === action.payload.id ? action.payload : m\n          ),\n          lastUpdated: new Date().toISOString(),\n        };\n      case 'ADD_ACTIVITY':\n        return {\n          ...state,\n          activities: [action.payload, ...state.activities].slice(0, 100),\n          lastUpdated: new Date().toISOString(),\n        };\n      // ... other cases\n    }\n  }\n\n  export const DashboardContext = createContext<{\n    state: DashboardState;\n    dispatch: React.Dispatch<DashboardAction>;\n  } | null>(null);\n\n  export function DashboardProvider({ children }: { children: React.ReactNode }) {\n    const [state, dispatch] = useReducer(dashboardReducer, initialState);\n\n    // Initialize with mock data\n    useEffect(() => {\n      dispatch({ type: 'SET_METRICS', payload: generateMetrics() });\n      dispatch({ type: 'SET_TIME_SERIES', payload: generateTimeSeries(30) });\n      dispatch({ type: 'SET_ACTIVITIES', payload: generateActivities(20) });\n    }, []);\n\n    return (\n      <DashboardContext.Provider value={{ state, dispatch }}>\n        {children}\n      </DashboardContext.Provider>\n    );\n  }\n\n  export function useDashboard() {\n    const context = useContext(DashboardContext);\n    if (!context) throw new Error('useDashboard must be used within DashboardProvider');\n    return context;\n  }\n  ```\n\n  **Acceptance Criteria:**\n  ```tsx\n  <DashboardProvider>\n    <TestConsumer />\n  </DashboardProvider>\n  // TestConsumer can access state.metrics with 4 items\n  // dispatch({ type: 'UPDATE_METRIC', payload: updated }) updates state\n  ```\n\n- [ ] **Task 4.2: Build main Dashboard page**\n\n  `src/App.tsx`:\n  ```tsx\n  function Dashboard() {\n    const { state, dispatch } = useDashboard();\n    const { status, subscribe } = useWebSocket();\n\n    // Subscribe to WebSocket updates\n    useEffect(() => {\n      dispatch({ type: 'SET_CONNECTION_STATUS', payload: status });\n    }, [status, dispatch]);\n\n    useEffect(() => {\n      const unsub1 = subscribe('metric_update', (msg) => {\n        dispatch({ type: 'UPDATE_METRIC', payload: msg.payload as Metric });\n      });\n      const unsub2 = subscribe('activity', (msg) => {\n        dispatch({ type: 'ADD_ACTIVITY', payload: msg.payload as ActivityEvent });\n      });\n      return () => { unsub1(); unsub2(); };\n    }, [subscribe, dispatch]);\n\n    // Time range change handler\n    const handleTimeRangeChange = (range: '7d' | '30d' | '90d') => {\n      dispatch({ type: 'SET_TIME_RANGE', payload: range });\n      dispatch({ type: 'SET_TIME_SERIES', payload: generateTimeSeries(parseInt(range)) });\n    };\n\n    return (\n      <DashboardLayout>\n        <Header title=\"Dashboard\" connectionStatus={state.connectionStatus} />\n\n        {/* KPI Cards Row */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6\">\n          {state.metrics.map(metric => (\n            <MetricCard key={metric.id} metric={metric} />\n          ))}\n        </div>\n\n        {/* Time Range Selector */}\n        <div className=\"flex gap-2 mb-4\">\n          {(['7d', '30d', '90d'] as const).map(range => (\n            <button\n              key={range}\n              onClick={() => handleTimeRangeChange(range)}\n              className={state.timeRange === range ? 'bg-blue-500 text-white' : 'bg-gray-200'}\n            >\n              {range}\n            </button>\n          ))}\n        </div>\n\n        {/* Charts Row */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6\">\n          <Card className=\"lg:col-span-2\">\n            <ChartWrapper loading={!state.timeSeries.length}>\n              <LineChart data={state.timeSeries} height={300} />\n            </ChartWrapper>\n          </Card>\n          <Card>\n            <ChartWrapper loading={!state.metrics.length}>\n              <PieChart\n                data={state.metrics.map(m => ({ name: m.name, value: m.value }))}\n                height={300}\n              />\n            </ChartWrapper>\n          </Card>\n        </div>\n\n        {/* Activity Table */}\n        <Card>\n          <DataTable\n            columns={activityColumns}\n            data={state.activities}\n            pageSize={10}\n          />\n        </Card>\n      </DashboardLayout>\n    );\n  }\n\n  export default function App() {\n    return (\n      <DashboardProvider>\n        <Dashboard />\n      </DashboardProvider>\n    );\n  }\n  ```\n\n  **Acceptance Criteria:**\n  - Page loads showing 4 metric cards, line chart, pie chart, activity table\n  - Click \"7d\" button: line chart updates to show 7 days of data\n  - Mock WebSocket sends update: relevant metric card shows new value\n  - Connection status indicator reflects WebSocket state\n\n- [ ] **Task 4.3: Add real-time update animations**\n\n  Update `src/components/common/MetricCard.tsx`:\n  - Track `isUpdating` state internally when `metric.updatedAt` changes\n  - Apply CSS animation: `animate-pulse` for 1 second on update\n\n  Add `src/components/common/LastUpdated.tsx`:\n  - Props: `{ timestamp: string | null }`\n  - Displays: \"Updated X seconds ago\" with live countdown\n  - Uses `setInterval` to update every second\n\n  Update `src/components/layout/Header.tsx`:\n  - Include `<LastUpdated timestamp={lastUpdated} />`\n  - Include `<StatusIndicator status={connectionStatus} />`\n\n  **Acceptance Criteria:**\n  - Metric card pulses green briefly when its value changes\n  - Header shows \"Updated 5s ago\" that counts up in real-time\n  - Status indicator changes color when connection status changes\n\n### Phase 5: Error Handling and Testing\n\n- [ ] **Task 5.1: Implement error handling**\n\n  Wrap charts and table in ErrorBoundary:\n  ```tsx\n  <ErrorBoundary fallback={<ErrorCard onRetry={handleRetry} />}>\n    <LineChart data={data} />\n  </ErrorBoundary>\n  ```\n\n  Add disconnection banner in Dashboard:\n  ```tsx\n  {state.connectionStatus === 'disconnected' && (\n    <div className=\"bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4\">\n      Using cached data. Attempting to reconnect...\n    </div>\n  )}\n  ```\n\n  Handle empty states in all data displays:\n  - Charts: \"No data available for this time range\"\n  - Table: \"No recent activity\"\n  - Metrics: Show skeleton if loading, zeros if truly empty\n\n  **Acceptance Criteria:**\n  - Throw error in LineChart: ErrorBoundary catches, shows retry button\n  - Click retry: component re-renders\n  - Disconnect WebSocket: yellow banner appears\n  - Reconnect: banner disappears\n\n- [ ] **Task 5.2: Add unit tests for hooks**\n\n  `src/hooks/__tests__/useWebSocket.test.ts`:\n  - Test: returns 'connecting' initially, then 'connected'\n  - Test: subscribe returns unsubscribe function\n  - Test: cleanup on unmount disconnects\n\n  `src/hooks/__tests__/useDataTable.test.ts`:\n  - Test: sorts data ascending/descending\n  - Test: paginates correctly (page 1 of 3 with pageSize 10, 25 items)\n  - Test: search filters data after debounce\n  - Test: changing data resets to page 1\n\n  **Acceptance Criteria:**\n  ```bash\n  npm test src/hooks\n  # All tests pass\n  ```\n\n- [ ] **Task 5.3: Add component tests**\n\n  `src/components/tables/__tests__/DataTable.test.tsx`:\n  - Test: renders columns and rows correctly\n  - Test: clicking sortable header triggers sort\n  - Test: search input filters displayed rows\n  - Test: pagination shows correct page count\n  - Test: loading state shows skeletons\n  - Test: empty state shows message\n\n  `src/components/charts/__tests__/LineChart.test.tsx`:\n  - Test: renders SVG with data\n  - Test: renders legend when showLegend=true\n  - Test: handles empty data array\n\n  **Acceptance Criteria:**\n  ```bash\n  npm test src/components\n  # All tests pass\n  ```\n\n- [ ] **Task 5.4: Add integration test**\n\n  `src/__tests__/Dashboard.integration.test.tsx`:\n  ```typescript\n  test('dashboard loads and displays data', async () => {\n    render(<App />);\n\n    // Wait for initial data load\n    await waitFor(() => {\n      expect(screen.getByText(/revenue/i)).toBeInTheDocument();\n    });\n\n    // Verify all sections present\n    expect(screen.getAllByTestId('metric-card')).toHaveLength(4);\n    expect(screen.getByTestId('line-chart')).toBeInTheDocument();\n    expect(screen.getByTestId('activity-table')).toBeInTheDocument();\n  });\n\n  test('time range selector updates chart', async () => {\n    render(<App />);\n\n    const button7d = screen.getByRole('button', { name: '7d' });\n    fireEvent.click(button7d);\n\n    await waitFor(() => {\n      // Verify chart data updated (implementation-specific assertion)\n    });\n  });\n  ```\n\n  **Acceptance Criteria:**\n  ```bash\n  npm test src/__tests__/Dashboard\n  # Integration tests pass\n  ```\n\n- [ ] **Task 5.5: Performance optimization**\n\n  Apply React.memo to:\n  - `MetricCard` - only re-render when metric prop changes\n  - `DataTable` row component - only re-render when row data changes\n  - `ChartWrapper` - prevent re-render on parent state changes\n\n  Add to `vite.config.ts` for code splitting:\n  ```typescript\n  build: {\n    rollupOptions: {\n      output: {\n        manualChunks: {\n          recharts: ['recharts'],\n        },\n      },\n    },\n  },\n  ```\n\n  Verify debounce is working on search input (300ms delay).\n\n  **Acceptance Criteria:**\n  ```bash\n  npm run build\n  # Check dist/assets - recharts in separate chunk\n  # Main bundle < 150KB gzipped\n\n  # In React DevTools Profiler:\n  # - Parent state change does not re-render memoized children\n  # - Search typing shows updates batched (not on every keystroke)\n  ```\n\n## Verification Checklist\n\nAfter all tasks complete, verify:\n\n```bash\n# Build succeeds\nnpm run build\n\n# Tests pass with coverage\nnpm test -- --coverage\n# Expected: > 70% coverage\n\n# Dev server runs\nnpm run dev\n# Visit http://localhost:5173\n# - 4 metric cards visible\n# - Line chart and pie chart render\n# - Activity table with pagination\n# - Time range buttons work\n# - Status indicator shows \"Connected\" (green)\n# - Wait 3s: metric card updates and pulses\n```\n\n## Non-Functional Requirements\n\n| Requirement | Target | How to Verify |\n|-------------|--------|---------------|\n| Initial load | < 2s on 3G | Chrome DevTools Network throttle to \"Slow 3G\" |\n| Bundle size | < 200KB gzipped | `npm run build && ls -la dist/assets/*.js` |\n| Test coverage | > 70% | `npm test -- --coverage` |\n| Accessibility | WCAG 2.1 AA | All interactive elements have focus states, ARIA labels on charts |\n| Browser support | Modern browsers | Test in Chrome, Firefox, Safari |\n\n## Environment Variables\n\n| Variable | Development | Production | Description |\n|----------|-------------|------------|-------------|\n| `VITE_USE_MOCK_WS` | `true` | `false` | Use mock WebSocket instead of real connection |\n| `VITE_WS_URL` | `ws://localhost:8080` | `wss://api.example.com/ws` | WebSocket server URL |\n\n## Out of Scope\n\n- User authentication/authorization\n- Backend API implementation (use mocks)\n- Data persistence (all data is ephemeral)\n- Multiple dashboard pages/routing\n- Dark mode (single theme only)\n- Real WebSocket server implementation\n",
      "score": {
        "structure": 30,
        "content": 30,
        "quality": 0,
        "total": 60,
        "violations": [
          "Tasks missing Verify sections",
          "Found 31 code blocks outside Verify sections",
          "Task count 19 outside expected range 3-10",
          "Contains forbidden term: npm install",
          "Contains forbidden term: ```tsx"
        ]
      },
      "violations": [
        "Tasks missing Verify sections",
        "Found 31 code blocks outside Verify sections",
        "Task count 19 outside expected range 3-10",
        "Contains forbidden term: npm install",
        "Contains forbidden term: ```tsx"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/dashboard",
        "Error: spawnSync /bin/sh ETIMEDOUT",
        "SPEC.md exists despite error: 28236 bytes"
      ]
    },
    {
      "id": "greenfield-trading",
      "name": "Greenfield: Trading Simulator",
      "timestamp": "2026-01-16T18:06:32.310Z",
      "duration_ms": 300316,
      "success": false,
      "spec_created": true,
      "task_count": 19,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# Stock Trading Simulator\n\nA paper trading platform that simulates stock market transactions with portfolio tracking, order execution, and P&L reporting.\n\n## Goal\n\nBuild a command-line stock trading simulator that allows users to:\n- Execute buy/sell orders with realistic market mechanics\n- Track portfolio positions and cash balance\n- Calculate and report profit/loss metrics\n- Persist state across sessions\n\n## Non-Goals\n\n- Real market data integration (use mock data only)\n- Options, futures, or other derivatives\n- Multiple user accounts\n- Web or GUI interface\n- Real-time external API connections\n- Short selling or margin trading\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                        CLI Interface                         │\n│  (buy, sell, portfolio, orders, pnl, history, quote)        │\n└─────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌─────────────────────────────────────────────────────────────┐\n│                      Trading Engine                          │\n│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │\n│  │    Order     │  │  Execution   │  │  Portfolio   │       │\n│  │   Manager    │──│    Engine    │──│   Service    │       │\n│  └──────────────┘  └──────────────┘  └──────────────┘       │\n└─────────────────────────────────────────────────────────────┘\n                              │\n          ┌───────────────────┼───────────────────┐\n          ▼                   ▼                   ▼\n┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐\n│   Market Data    │ │    P&L Engine    │ │   Persistence    │\n│    Service       │ │                  │ │    (JSON files)  │\n└──────────────────┘ └──────────────────┘ └──────────────────┘\n```\n\n## Data Models\n\n```typescript\n// Stock quote information\ninterface Stock {\n  symbol: string;        // e.g., \"AAPL\"\n  name: string;          // e.g., \"Apple Inc.\"\n  price: number;         // Current price in dollars\n  lastUpdated: Date;\n}\n\n// A position in the portfolio\ninterface Position {\n  symbol: string;\n  quantity: number;      // Shares held (always positive)\n  avgCostBasis: number;  // Average price paid per share\n}\n\n// Portfolio state\ninterface Portfolio {\n  cashBalance: number;   // Available cash in dollars\n  positions: Map<string, Position>;\n  createdAt: Date;\n}\n\n// Order types\ntype OrderType = 'market' | 'limit';\ntype OrderSide = 'buy' | 'sell';\ntype OrderStatus = 'pending' | 'filled' | 'partial' | 'cancelled' | 'rejected';\n\n// An order to buy or sell\ninterface Order {\n  id: string;            // UUID\n  symbol: string;\n  side: OrderSide;\n  type: OrderType;\n  quantity: number;      // Requested quantity\n  filledQuantity: number; // Amount filled so far\n  limitPrice?: number;   // For limit orders only\n  status: OrderStatus;\n  createdAt: Date;\n  updatedAt: Date;\n  rejectionReason?: string;\n}\n\n// A completed transaction\ninterface Transaction {\n  id: string;            // UUID\n  orderId: string;       // Reference to the order\n  symbol: string;\n  side: OrderSide;\n  quantity: number;      // Quantity in this fill\n  price: number;         // Execution price\n  fees: number;          // Commission paid\n  timestamp: Date;\n}\n\n// P&L report data\ninterface PnLReport {\n  totalValue: number;          // Cash + positions market value\n  cashBalance: number;\n  positionsValue: number;      // Sum of all position market values\n  unrealizedPnL: number;       // Current value - cost basis\n  realizedPnL: number;         // From closed positions\n  totalPnL: number;            // Realized + unrealized\n  totalReturn: number;         // Percentage return\n  positions: PositionPnL[];\n}\n\ninterface PositionPnL {\n  symbol: string;\n  quantity: number;\n  avgCostBasis: number;\n  currentPrice: number;\n  marketValue: number;\n  unrealizedPnL: number;\n  unrealizedPnLPercent: number;\n}\n```\n\n## Configuration\n\n```typescript\ninterface Config {\n  initialCash: number;         // Default: 100000\n  commissionPerTrade: number;  // Default: 0 (can set to e.g., 9.99)\n  dataDir: string;             // Default: ./data\n}\n```\n\n## Tasks\n\n### Phase 1: Project Setup\n\n- [ ] Initialize TypeScript project\n  - `npm init` with package.json\n  - TypeScript 5.x with strict mode enabled\n  - ts-node for development\n  - Jest with ts-jest for testing\n  - Source maps enabled for debugging\n\n  **Files to create:**\n  - `package.json`\n  - `tsconfig.json`\n  - `jest.config.js`\n  - `src/index.ts` (entry point)\n\n  **Verify:**\n  ```bash\n  npm run build   # Compiles to dist/\n  npm test        # Jest runs (0 tests initially)\n  npm start       # Runs without error\n  ```\n\n- [ ] Create project structure and core types\n  - `src/types/` - All TypeScript interfaces from Data Models section\n  - `src/models/` - Class implementations\n  - `src/services/` - Business logic\n  - `src/utils/` - Helpers (uuid generation, formatting)\n  - `src/cli/` - Command handlers\n\n  **Verify:**\n  - All interfaces compile without errors\n  - `import { Order, Portfolio } from './types'` works\n\n### Phase 2: Market Data Service\n\n- [ ] Implement mock market data provider\n  - Hardcoded seed data for 10+ common symbols (AAPL, GOOGL, MSFT, AMZN, etc.)\n  - `getQuote(symbol: string): Stock | null`\n  - `getAllSymbols(): string[]`\n  - Case-insensitive symbol lookup\n  - Returns null for unknown symbols (not an error)\n\n  **Seed data example:**\n  ```typescript\n  { symbol: 'AAPL', name: 'Apple Inc.', price: 178.50 }\n  { symbol: 'GOOGL', name: 'Alphabet Inc.', price: 141.25 }\n  // ... etc\n  ```\n\n  **Verify:**\n  ```typescript\n  marketData.getQuote('AAPL')  // Returns Stock\n  marketData.getQuote('aapl')  // Returns same Stock (case-insensitive)\n  marketData.getQuote('INVALID')  // Returns null\n  ```\n\n- [ ] Add price simulation (optional enhancement)\n  - Prices vary slightly on each call (±0-2% random walk)\n  - Configurable volatility per symbol\n  - Deterministic mode for testing (seeded random)\n\n  **Verify:**\n  - Prices change between calls in simulation mode\n  - Prices are stable in deterministic/test mode\n\n### Phase 3: Portfolio Management\n\n- [ ] Implement Portfolio class\n  - Constructor accepts initial cash balance\n  - `getCashBalance(): number`\n  - `getPosition(symbol: string): Position | undefined`\n  - `getAllPositions(): Position[]`\n  - `getTotalValue(marketData): number` - cash + sum of (position qty × current price)\n\n  **Edge cases:**\n  - Empty portfolio returns just cash value\n  - Unknown symbols in positions should fail getTotalValue\n\n  **Verify:**\n  ```typescript\n  const portfolio = new Portfolio(100000);\n  portfolio.getCashBalance()  // 100000\n  portfolio.getAllPositions() // []\n  portfolio.getTotalValue(marketData) // 100000\n  ```\n\n- [ ] Add position modification methods\n  - `addPosition(symbol, quantity, price)` - Creates or averages into position\n  - `reducePosition(symbol, quantity)` - Reduces position, returns cost basis of sold shares\n  - `deductCash(amount)` / `addCash(amount)`\n\n  **Cost basis calculation for sells (FIFO simplified to average):**\n  - Use average cost basis for all sells\n  - Return the cost basis amount for P&L calculation\n\n  **Verify:**\n  ```typescript\n  portfolio.addPosition('AAPL', 10, 150);  // Buy 10 @ $150\n  portfolio.addPosition('AAPL', 10, 160);  // Buy 10 more @ $160\n  portfolio.getPosition('AAPL').avgCostBasis  // 155 (average)\n  portfolio.getPosition('AAPL').quantity      // 20\n\n  portfolio.reducePosition('AAPL', 5);  // Sell 5, returns cost basis $775\n  portfolio.getPosition('AAPL').quantity  // 15\n  ```\n\n### Phase 4: Order Management\n\n- [ ] Implement Order creation and validation\n  - `createOrder(side, symbol, quantity, type, limitPrice?)`: Order\n  - Generate UUID for order ID\n  - Validate: quantity > 0, symbol exists, sufficient funds (for buys)\n  - For sells: validate sufficient shares owned\n  - Set initial status to 'pending' or 'rejected'\n\n  **Rejection reasons:**\n  - \"Insufficient funds\" - cash < quantity × price\n  - \"Insufficient shares\" - position quantity < sell quantity\n  - \"Invalid symbol\" - symbol not in market data\n  - \"Invalid quantity\" - quantity <= 0\n\n  **Verify:**\n  ```typescript\n  orderManager.createOrder('buy', 'AAPL', 10, 'market')\n  // Returns Order with status 'pending'\n\n  orderManager.createOrder('buy', 'INVALID', 10, 'market')\n  // Returns Order with status 'rejected', rejectionReason set\n  ```\n\n- [ ] Implement order queue and status tracking\n  - `getPendingOrders(): Order[]`\n  - `getOrderHistory(): Order[]`\n  - `cancelOrder(orderId): boolean`\n  - Orders stored in memory (persisted separately)\n\n  **Verify:**\n  - Pending orders appear in getPendingOrders\n  - Cancelled orders have status 'cancelled'\n  - Order history includes all orders\n\n### Phase 5: Execution Engine\n\n- [ ] Implement market order execution\n  - Execute immediately at current market price\n  - Deduct cash (buys) or add cash (sells)\n  - Update portfolio positions\n  - Create Transaction record\n  - Apply commission fee\n  - Update order status to 'filled'\n\n  **Execution flow:**\n  1. Get current price from market data\n  2. Calculate total cost (price × quantity + commission)\n  3. Update portfolio (cash and positions)\n  4. Create transaction record\n  5. Update order status\n\n  **Verify:**\n  ```typescript\n  // Starting: $100,000 cash, 0 positions\n  execute(buyOrder)  // Buy 10 AAPL @ $178.50\n  // Result: $98,215 cash, 10 AAPL position\n  portfolio.getPosition('AAPL').quantity  // 10\n  portfolio.getPosition('AAPL').avgCostBasis  // 178.50\n  ```\n\n- [ ] Implement limit order execution\n  - For buy limits: execute only if market price ≤ limit price\n  - For sell limits: execute only if market price ≥ limit price\n  - If condition not met, order stays pending\n  - `checkAndExecutePendingOrders()` - called to process limit orders\n\n  **Verify:**\n  ```typescript\n  // AAPL current price: $178.50\n  createOrder('buy', 'AAPL', 10, 'limit', 175)  // Won't fill yet\n\n  // Later, price drops to $174\n  checkAndExecutePendingOrders()  // Now fills\n  ```\n\n### Phase 6: P&L Calculations\n\n- [ ] Implement unrealized P&L\n  - Per position: (current price - avg cost basis) × quantity\n  - Total unrealized: sum of all position unrealized P&L\n  - Percentage: unrealized / cost basis × 100\n\n  **Verify:**\n  ```typescript\n  // Position: 10 AAPL, cost basis $150, current price $180\n  positionPnL.unrealizedPnL  // $300 (10 × $30)\n  positionPnL.unrealizedPnLPercent  // 20%\n  ```\n\n- [ ] Implement realized P&L tracking\n  - Track realized P&L from each sell transaction\n  - Realized = (sell price - cost basis) × quantity - fees\n  - Accumulate total realized P&L\n\n  **Verify:**\n  ```typescript\n  // Buy 10 @ $150, sell 5 @ $180, $0 commission\n  realizedPnL  // $150 (5 × $30)\n  ```\n\n- [ ] Create P&L report generator\n  - Assemble full PnLReport object\n  - Calculate total return percentage vs initial investment\n  - Include per-position breakdown\n\n  **Verify:**\n  - Report matches manual calculation\n  - All fields populated correctly\n\n### Phase 7: Persistence\n\n- [ ] Implement JSON file persistence\n  - Save portfolio state to `data/portfolio.json`\n  - Save order history to `data/orders.json`\n  - Save transactions to `data/transactions.json`\n  - Save realized P&L accumulator\n\n  **File format:**\n  ```json\n  // portfolio.json\n  {\n    \"cashBalance\": 95000,\n    \"positions\": [\n      { \"symbol\": \"AAPL\", \"quantity\": 10, \"avgCostBasis\": 178.50 }\n    ],\n    \"realizedPnL\": 150,\n    \"createdAt\": \"2024-01-15T10:00:00Z\"\n  }\n  ```\n\n  **Verify:**\n  - Files created in data/ directory\n  - JSON is valid and readable\n\n- [ ] Implement state loading on startup\n  - Load portfolio if exists, else create new with initial cash\n  - Load order history\n  - Load transaction history\n  - Handle missing/corrupt files gracefully (start fresh)\n\n  **Verify:**\n  ```bash\n  npm start -- buy AAPL 10\n  # Restart application\n  npm start -- portfolio\n  # Shows the 10 AAPL position from before\n  ```\n\n### Phase 8: CLI Interface\n\n- [ ] Implement CLI command parser\n  - Parse command line arguments\n  - Route to appropriate handler\n  - Display help for invalid commands\n\n  **Commands:**\n  ```\n  buy <symbol> <quantity> [--limit <price>]\n  sell <symbol> <quantity> [--limit <price>]\n  portfolio\n  orders [--status pending|filled|all]\n  pnl\n  history [--symbol <symbol>] [--limit <n>]\n  quote <symbol>\n  help\n  ```\n\n  **Verify:**\n  - `npm start -- help` shows all commands\n  - Invalid command shows error + help\n\n- [ ] Implement each command handler\n  - `buy` - Create and execute buy order, show result\n  - `sell` - Create and execute sell order, show result\n  - `portfolio` - Show positions table and total value\n  - `orders` - Show orders in table format\n  - `pnl` - Show P&L report\n  - `history` - Show transaction history\n  - `quote` - Show current price for symbol\n\n  **Output format (portfolio example):**\n  ```\n  Portfolio Summary\n  ─────────────────────────────────────────────────\n  Cash Balance:     $95,215.00\n\n  Positions:\n  Symbol  Qty     Avg Cost    Current    Value       P&L\n  AAPL    10      $178.50     $182.00    $1,820.00   +$35.00 (+1.96%)\n  GOOGL   5       $141.25     $145.00    $725.00     +$18.75 (+2.65%)\n\n  Total Value:      $97,760.00\n  Total P&L:        +$53.75 (+0.05%)\n  ```\n\n  **Verify:**\n  - Each command produces expected output\n  - Numbers are formatted with $ and commas\n  - Errors show helpful messages\n\n### Phase 9: Integration Testing\n\n- [ ] Write end-to-end test scenarios\n  - Complete trading workflow: buy → hold → sell → check P&L\n  - Multiple positions scenario\n  - Order rejection scenarios\n  - Persistence round-trip test\n\n  **Test scenario example:**\n  ```typescript\n  // Start fresh with $100,000\n  buy('AAPL', 10)      // Buy 10 shares\n  buy('GOOGL', 20)     // Buy 20 shares\n  // Simulate price increase\n  sell('AAPL', 5)      // Sell half AAPL position\n  // Verify P&L calculations\n  // Verify portfolio state\n  // Restart and verify persistence\n  ```\n\n  **Verify:**\n  - `npm test` passes all tests\n  - Test coverage > 80% for services\n\n- [ ] Add input validation and error handling\n  - Validate all CLI inputs\n  - Catch and display errors gracefully\n  - No stack traces shown to user\n\n  **Verify:**\n  - `npm start -- buy AAPL -5` → \"Error: Quantity must be positive\"\n  - `npm start -- buy INVALID 10` → \"Error: Unknown symbol 'INVALID'\"\n  - No unhandled promise rejections\n\n## Success Criteria\n\nThe project is complete when:\n\n1. **Core functionality works:**\n   - Can buy and sell stocks via CLI\n   - Portfolio tracks positions correctly\n   - P&L calculations are accurate\n\n2. **State persists:**\n   - Closing and reopening preserves all data\n   - Transaction history is complete\n\n3. **Tests pass:**\n   - `npm test` runs successfully\n   - Key scenarios have test coverage\n\n4. **CLI is usable:**\n   - Commands work as documented\n   - Output is formatted and readable\n   - Errors are helpful\n\n## File Structure\n\n```\ntrading/\n├── package.json\n├── tsconfig.json\n├── jest.config.js\n├── README.md\n├── src/\n│   ├── index.ts              # Entry point\n│   ├── types/\n│   │   └── index.ts          # All TypeScript interfaces\n│   ├── models/\n│   │   ├── Portfolio.ts\n│   │   ├── Order.ts\n│   │   └── Transaction.ts\n│   ├── services/\n│   │   ├── MarketDataService.ts\n│   │   ├── OrderManager.ts\n│   │   ├── ExecutionEngine.ts\n│   │   ├── PnLEngine.ts\n│   │   └── PersistenceService.ts\n│   ├── cli/\n│   │   ├── commands.ts       # Command definitions\n│   │   └── formatters.ts     # Output formatting\n│   └── utils/\n│       ├── uuid.ts\n│       └── format.ts         # Number/currency formatting\n├── data/                     # Created at runtime\n│   ├── portfolio.json\n│   ├── orders.json\n│   └── transactions.json\n└── tests/\n    ├── models/\n    ├── services/\n    └── integration/\n```\n",
      "score": {
        "structure": 45,
        "content": 30,
        "quality": 1,
        "total": 76,
        "violations": [
          "Found 8 code blocks outside Verify sections",
          "Task count 19 outside expected range 4-10",
          "Contains forbidden term: ```"
        ]
      },
      "violations": [
        "Found 8 code blocks outside Verify sections",
        "Task count 19 outside expected range 4-10",
        "Contains forbidden term: ```"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/trading",
        "Error: spawnSync /bin/sh ETIMEDOUT",
        "SPEC.md exists despite error: 15750 bytes"
      ]
    },
    {
      "id": "brownfield-feature",
      "name": "Brownfield: Add Auth to Existing API",
      "timestamp": "2026-01-16T18:10:00.507Z",
      "duration_ms": 208196,
      "success": false,
      "spec_created": true,
      "task_count": 0,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# JWT Authentication for REST API\n\nAdd JWT-based authentication to the existing REST API with user registration, login, logout, and route protection.\n\n## Current State\n\n**Existing files:**\n- `src/routes/users.ts` - Empty placeholder (`export const userRoutes = {}`)\n\n**Missing infrastructure:**\n- No `package.json` (project needs initialization)\n- No TypeScript configuration\n- No Express server\n\n## Goals\n\n1. Initialize a working Node.js/TypeScript project\n2. Implement JWT authentication (register, login, logout)\n3. Create auth middleware to protect routes\n4. Add sample protected user endpoints\n\n## Technical Decisions\n\n| Decision | Choice | Rationale |\n|----------|--------|-----------|\n| Runtime | Node.js 18+ | LTS version with native fetch support |\n| Framework | Express 4.x | Lightweight, widely adopted |\n| Token Algorithm | HS256 | Symmetric signing, sufficient for single-service |\n| Token Expiry | 1 hour (3600s) | Balance security/UX |\n| Password Hashing | bcrypt (10 rounds) | Industry standard |\n| Token Storage | Stateless (client-side) | No server-side session store needed |\n| User Storage | In-memory Map | Simple for MVP; swappable for DB |\n| ID Generation | crypto.randomUUID() | Built-in, no external dependency |\n\n## API Specification\n\n### Authentication Endpoints\n\n#### POST /auth/register\n\nCreate a new user account.\n\n**Request Body:**\n```json\n{\n  \"email\": \"user@example.com\",\n  \"password\": \"securepass123\"\n}\n```\n\n**Validation:**\n- `email`: Required, valid email format\n- `password`: Required, minimum 8 characters\n\n**Responses:**\n\n| Status | Body | Condition |\n|--------|------|-----------|\n| 201 | `{ \"id\": \"uuid\", \"email\": \"user@example.com\" }` | Success |\n| 400 | `{ \"error\": \"Email is required\" }` | Missing email |\n| 400 | `{ \"error\": \"Password is required\" }` | Missing password |\n| 400 | `{ \"error\": \"Invalid email format\" }` | Malformed email |\n| 400 | `{ \"error\": \"Password must be at least 8 characters\" }` | Short password |\n| 409 | `{ \"error\": \"Email already registered\" }` | Duplicate email |\n\n#### POST /auth/login\n\nAuthenticate and receive a JWT token.\n\n**Request Body:**\n```json\n{\n  \"email\": \"user@example.com\",\n  \"password\": \"securepass123\"\n}\n```\n\n**Responses:**\n\n| Status | Body | Condition |\n|--------|------|-----------|\n| 200 | `{ \"token\": \"eyJ...\", \"expiresIn\": 3600 }` | Success |\n| 400 | `{ \"error\": \"Email is required\" }` | Missing email |\n| 400 | `{ \"error\": \"Password is required\" }` | Missing password |\n| 401 | `{ \"error\": \"Invalid credentials\" }` | Wrong email/password |\n\n#### POST /auth/logout\n\nAcknowledge logout (stateless - no server action needed).\n\n**Responses:**\n\n| Status | Body | Condition |\n|--------|------|-----------|\n| 200 | `{ \"message\": \"Logged out successfully\" }` | Always |\n\n### Protected Endpoints\n\nAll `/users/*` routes require authentication.\n\n**Required Header:** `Authorization: Bearer <token>`\n\n**Auth Error Responses:**\n\n| Status | Body | Condition |\n|--------|------|-----------|\n| 401 | `{ \"error\": \"No token provided\" }` | Missing header |\n| 401 | `{ \"error\": \"Invalid token format\" }` | Not \"Bearer xxx\" |\n| 401 | `{ \"error\": \"Invalid token\" }` | Malformed/tampered |\n| 401 | `{ \"error\": \"Token expired\" }` | Past expiration |\n\n#### GET /users/me\n\nGet the authenticated user's profile.\n\n**Response:**\n```json\n{\n  \"id\": \"uuid\",\n  \"email\": \"user@example.com\"\n}\n```\n\n#### GET /users\n\nList all users (for demo purposes).\n\n**Response:**\n```json\n{\n  \"users\": [\n    { \"id\": \"uuid\", \"email\": \"user@example.com\" }\n  ]\n}\n```\n\n## File Structure\n\n```\nexisting-api/\n├── package.json\n├── tsconfig.json\n├── .env.example\n├── .env                    # Local only, gitignored\n└── src/\n    ├── index.ts            # Express app entry point\n    ├── config.ts           # Environment configuration\n    ├── middleware/\n    │   └── auth.ts         # JWT verification middleware\n    ├── routes/\n    │   ├── auth.ts         # /auth/* endpoints\n    │   └── users.ts        # /users/* protected endpoints\n    ├── models/\n    │   └── user.ts         # User type and in-memory store\n    ├── utils/\n    │   ├── password.ts     # bcrypt helpers\n    │   └── jwt.ts          # JWT helpers\n    └── __tests__/\n        ├── password.test.ts\n        ├── jwt.test.ts\n        └── auth.test.ts\n```\n\n## Implementation Tasks\n\n### Task 1: Project Setup\n\nInitialize the Node.js/TypeScript project with dependencies.\n\n**Files to create:**\n\n`package.json`:\n```json\n{\n  \"name\": \"existing-api\",\n  \"version\": \"1.0.0\",\n  \"type\": \"module\",\n  \"scripts\": {\n    \"build\": \"tsc\",\n    \"start\": \"node dist/index.js\",\n    \"dev\": \"tsx src/index.ts\",\n    \"test\": \"vitest run\"\n  }\n}\n```\n\nDependencies:\n- `express` (^4.18.0)\n- `jsonwebtoken` (^9.0.0)\n- `bcrypt` (^5.1.0)\n\nDev dependencies:\n- `typescript` (^5.0.0)\n- `tsx` (^4.0.0)\n- `vitest` (^1.0.0)\n- `supertest` (^6.0.0)\n- `@types/express`, `@types/jsonwebtoken`, `@types/bcrypt`, `@types/supertest`\n\n`tsconfig.json`:\n```json\n{\n  \"compilerOptions\": {\n    \"target\": \"ES2022\",\n    \"module\": \"NodeNext\",\n    \"moduleResolution\": \"NodeNext\",\n    \"outDir\": \"dist\",\n    \"rootDir\": \"src\",\n    \"strict\": true,\n    \"esModuleInterop\": true,\n    \"skipLibCheck\": true\n  },\n  \"include\": [\"src/**/*\"]\n}\n```\n\n`.env.example`:\n```\nPORT=3000\nJWT_SECRET=your-secret-key-min-32-chars-here\n```\n\n`src/config.ts`:\n```typescript\nexport const config = {\n  port: parseInt(process.env.PORT || '3000', 10),\n  jwtSecret: process.env.JWT_SECRET || 'development-secret-do-not-use-in-prod',\n  tokenExpiry: 3600, // 1 hour in seconds\n};\n```\n\n**Acceptance criteria:**\n```bash\nnpm install  # Exits 0\nnpm run build  # Exits 0, creates dist/\n```\n\n### Task 2: User Model and Password Utilities\n\nCreate the user data layer and password hashing.\n\n**src/models/user.ts:**\n```typescript\nexport interface User {\n  id: string;\n  email: string;\n  passwordHash: string;\n}\n\n// In-memory store\nconst users = new Map<string, User>();\n\nexport function createUser(id: string, email: string, passwordHash: string): User;\nexport function findUserByEmail(email: string): User | undefined;\nexport function findUserById(id: string): User | undefined;\nexport function getAllUsers(): User[];\n```\n\n**src/utils/password.ts:**\n```typescript\nexport async function hashPassword(password: string): Promise<string>;\nexport async function comparePassword(password: string, hash: string): Promise<boolean>;\n```\n\n**Acceptance criteria:**\n```typescript\n// hashPassword returns bcrypt hash starting with $2b$\nconst hash = await hashPassword('test123');\nassert(hash.startsWith('$2b$'));\n\n// comparePassword validates correctly\nassert(await comparePassword('test123', hash) === true);\nassert(await comparePassword('wrong', hash) === false);\n```\n\n### Task 3: JWT Utilities\n\nCreate token generation and verification.\n\n**src/utils/jwt.ts:**\n```typescript\nexport interface TokenPayload {\n  sub: string;  // user ID\n  iat: number;  // issued at\n  exp: number;  // expires at\n}\n\nexport function generateToken(userId: string): string;\nexport function verifyToken(token: string): TokenPayload;  // throws on invalid\n```\n\n**Acceptance criteria:**\n```typescript\n// generateToken creates valid JWT\nconst token = generateToken('user-123');\nassert(token.split('.').length === 3);\n\n// verifyToken decodes valid token\nconst payload = verifyToken(token);\nassert(payload.sub === 'user-123');\n\n// verifyToken throws on invalid\nassert.throws(() => verifyToken('invalid.token.here'));\n```\n\n### Task 4: Auth Middleware\n\nCreate JWT verification middleware for protected routes.\n\n**src/middleware/auth.ts:**\n```typescript\nimport { Request, Response, NextFunction } from 'express';\n\n// Extends Express Request to include authenticated user\nexport interface AuthRequest extends Request {\n  user?: { id: string };\n}\n\nexport function authMiddleware(req: AuthRequest, res: Response, next: NextFunction): void;\n```\n\n**Behavior:**\n1. Extract token from `Authorization: Bearer <token>`\n2. If no header: 401 \"No token provided\"\n3. If not \"Bearer xxx\" format: 401 \"Invalid token format\"\n4. Verify token with `verifyToken()`\n5. If invalid/expired: 401 with appropriate message\n6. Set `req.user = { id: payload.sub }`\n7. Call `next()`\n\n### Task 5: Auth Routes\n\nImplement registration, login, and logout endpoints.\n\n**src/routes/auth.ts:**\n```typescript\nimport { Router } from 'express';\nexport const authRouter: Router;\n```\n\n**Endpoints:** POST /register, POST /login, POST /logout\n\n**Implementation notes:**\n- Validate email format with regex: `/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/`\n- Check password length >= 8\n- Use `crypto.randomUUID()` for user IDs\n- Return appropriate error messages per API spec\n\n### Task 6: User Routes (Protected)\n\nUpdate the existing users.ts with protected endpoints.\n\n**src/routes/users.ts:**\n```typescript\nimport { Router } from 'express';\nimport { authMiddleware } from '../middleware/auth.js';\n\nexport const userRouter: Router;\n// Apply authMiddleware to all routes\n// GET / - list all users\n// GET /me - get authenticated user\n```\n\n### Task 7: Express App Entry Point\n\nWire everything together.\n\n**src/index.ts:**\n```typescript\nimport express from 'express';\nimport { config } from './config.js';\nimport { authRouter } from './routes/auth.js';\nimport { userRouter } from './routes/users.js';\n\nconst app = express();\n\napp.use(express.json());\napp.use('/auth', authRouter);\napp.use('/users', userRouter);\n\n// Global error handler\napp.use((err, req, res, next) => {\n  console.error(err);\n  res.status(500).json({ error: 'Internal server error' });\n});\n\napp.listen(config.port, () => {\n  console.log(`Server running on port ${config.port}`);\n});\n\nexport { app };  // For testing\n```\n\n**Acceptance criteria:**\n```bash\n# Terminal 1: Start server\nnpm run dev\n\n# Terminal 2: Test endpoints\n# Register\ncurl -X POST http://localhost:3000/auth/register \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"test@test.com\",\"password\":\"password123\"}'\n# Expected: 201 { \"id\": \"...\", \"email\": \"test@test.com\" }\n\n# Login\ncurl -X POST http://localhost:3000/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\":\"test@test.com\",\"password\":\"password123\"}'\n# Expected: 200 { \"token\": \"...\", \"expiresIn\": 3600 }\n\n# Access protected route without token\ncurl http://localhost:3000/users/me\n# Expected: 401 { \"error\": \"No token provided\" }\n\n# Access protected route with token\nTOKEN=\"<token from login>\"\ncurl http://localhost:3000/users/me -H \"Authorization: Bearer $TOKEN\"\n# Expected: 200 { \"id\": \"...\", \"email\": \"test@test.com\" }\n```\n\n### Task 8: Tests\n\nAdd automated tests using Vitest and Supertest.\n\n**src/__tests__/password.test.ts:**\n- hashPassword returns bcrypt hash\n- comparePassword returns true for correct password\n- comparePassword returns false for wrong password\n\n**src/__tests__/jwt.test.ts:**\n- generateToken creates valid JWT\n- verifyToken decodes valid token\n- verifyToken throws on invalid token\n- verifyToken throws on expired token\n\n**src/__tests__/auth.test.ts:**\n- POST /auth/register creates user (201)\n- POST /auth/register rejects duplicate email (409)\n- POST /auth/register validates email format (400)\n- POST /auth/register validates password length (400)\n- POST /auth/login returns token for valid credentials (200)\n- POST /auth/login rejects invalid credentials (401)\n- GET /users/me returns user with valid token (200)\n- GET /users/me rejects missing token (401)\n- GET /users/me rejects invalid token (401)\n\n**Acceptance criteria:**\n```bash\nnpm test  # All tests pass\n```\n\n## Security Notes\n\n- `JWT_SECRET` should be at least 32 random characters in production\n- Never log tokens or passwords\n- Use HTTPS in production\n- Consider rate limiting `/auth/login` to prevent brute force\n- The in-memory user store resets on restart (not for production)\n\n## Out of Scope\n\n- Refresh tokens\n- Password reset\n- Email verification\n- Database persistence\n- Role-based access control\n",
      "score": {
        "structure": 10,
        "content": 30,
        "quality": 0,
        "total": 40,
        "violations": [
          "Missing phase organization",
          "Tasks missing checkboxes",
          "Tasks missing Verify sections",
          "Found 21 code blocks outside Verify sections",
          "Task count 0 outside expected range 2-6",
          "Contains forbidden term: npm install",
          "Contains forbidden term: ```typescript"
        ]
      },
      "violations": [
        "Missing phase organization",
        "Tasks missing checkboxes",
        "Tasks missing Verify sections",
        "Found 21 code blocks outside Verify sections",
        "Task count 0 outside expected range 2-6",
        "Contains forbidden term: npm install",
        "Contains forbidden term: ```typescript"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/existing-api",
        "Error: Command failed: ralphie spec --headless --auto --cwd \"/tmp/ralphie-test/existing-api\" \"Add JWT authentication to the existing REST API with login, logout, and protected routes\"",
        "SPEC.md exists despite error: 11793 bytes"
      ]
    },
    {
      "id": "brownfield-refactor",
      "name": "Brownfield: Refactor to TypeScript",
      "timestamp": "2026-01-16T18:13:21.982Z",
      "duration_ms": 201475,
      "success": false,
      "spec_created": true,
      "task_count": 0,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# TypeScript Refactor with Separation of Concerns\n\nRefactor the existing JavaScript codebase to TypeScript with proper types and clean architecture separating data layer, business logic, and API handlers.\n\n## Current State Analysis\n\n**Files:**\n- `src/db.js` - CommonJS module exporting `{ getUser: (id) => ({id, name: \"test\"}) }`\n- `src/api.js` - CommonJS module exporting `{ handler: (req, res) => res.json(db.getUser(req.params.id)) }`\n\n**Key observations:**\n- Uses CommonJS (`require`/`module.exports`)\n- `getUser` always returns a user (never null/undefined)\n- Handler expects `req.params.id` and `res.json()`\n\n## Target Architecture\n\n```\nsrc/\n├── types/\n│   └── index.ts          # Shared type definitions\n├── repositories/\n│   └── userRepository.ts # Data layer (pure data access)\n├── services/\n│   └── userService.ts    # Business logic layer\n├── handlers/\n│   └── userHandler.ts    # API layer (HTTP concerns)\n└── index.ts              # Public API exports\n```\n\n**Layer responsibilities:**\n- **Repository**: Data access only, no business rules\n- **Service**: Business logic, validation, orchestration\n- **Handler**: HTTP request/response handling, calls services\n\n## Implementation Tasks\n\n### Task 1: Initialize TypeScript Project\n\nCreate `package.json`:\n```json\n{\n  \"name\": \"js-project\",\n  \"version\": \"1.0.0\",\n  \"type\": \"module\",\n  \"main\": \"./dist/index.js\",\n  \"types\": \"./dist/index.d.ts\",\n  \"exports\": {\n    \".\": {\n      \"types\": \"./dist/index.d.ts\",\n      \"default\": \"./dist/index.js\"\n    }\n  },\n  \"scripts\": {\n    \"build\": \"tsc\",\n    \"typecheck\": \"tsc --noEmit\"\n  },\n  \"devDependencies\": {\n    \"typescript\": \"^5.0.0\",\n    \"@types/node\": \"^20.0.0\"\n  }\n}\n```\n\nCreate `tsconfig.json`:\n```json\n{\n  \"compilerOptions\": {\n    \"target\": \"ES2022\",\n    \"module\": \"NodeNext\",\n    \"moduleResolution\": \"NodeNext\",\n    \"strict\": true,\n    \"outDir\": \"./dist\",\n    \"rootDir\": \"./src\",\n    \"declaration\": true,\n    \"declarationMap\": true,\n    \"sourceMap\": true,\n    \"esModuleInterop\": true,\n    \"skipLibCheck\": true,\n    \"forceConsistentCasingInFileNames\": true\n  },\n  \"include\": [\"src/**/*\"],\n  \"exclude\": [\"node_modules\", \"dist\"]\n}\n```\n\n### Task 2: Define Types\n\nCreate `src/types/index.ts`:\n```typescript\n/** Core user entity */\nexport interface User {\n  id: string | number;\n  name: string;\n}\n\n/** Repository interface for data access */\nexport interface IUserRepository {\n  getUser(id: string | number): User;\n}\n\n/** Minimal request interface matching Express-like API */\nexport interface ApiRequest {\n  params: {\n    id: string;\n  };\n}\n\n/** Minimal response interface matching Express-like API */\nexport interface ApiResponse {\n  json(data: unknown): void;\n}\n```\n\n### Task 3: Implement Repository Layer\n\nCreate `src/repositories/userRepository.ts`:\n```typescript\nimport type { User, IUserRepository } from '../types/index.js';\n\n/**\n * User repository - handles data access.\n * Currently returns mock data; replace with actual DB calls.\n */\nexport class UserRepository implements IUserRepository {\n  getUser(id: string | number): User {\n    // Mock implementation matching original db.js behavior\n    return { id, name: \"test\" };\n  }\n}\n```\n\n### Task 4: Implement Service Layer\n\nCreate `src/services/userService.ts`:\n```typescript\nimport type { User, IUserRepository } from '../types/index.js';\n\n/**\n * User service - contains business logic.\n * Depends on repository interface, not concrete implementation.\n */\nexport class UserService {\n  constructor(private readonly repository: IUserRepository) {}\n\n  getUserById(id: string | number): User {\n    return this.repository.getUser(id);\n  }\n}\n```\n\n### Task 5: Implement Handler Layer\n\nCreate `src/handlers/userHandler.ts`:\n```typescript\nimport type { ApiRequest, ApiResponse } from '../types/index.js';\nimport type { UserService } from '../services/userService.js';\n\n/**\n * User handler - manages HTTP request/response.\n * Depends on service, not repository.\n */\nexport class UserHandler {\n  constructor(private readonly userService: UserService) {}\n\n  handle(req: ApiRequest, res: ApiResponse): void {\n    const user = this.userService.getUserById(req.params.id);\n    res.json(user);\n  }\n}\n```\n\n### Task 6: Create Entry Point\n\nCreate `src/index.ts`:\n```typescript\n// Re-export types\nexport type { User, IUserRepository, ApiRequest, ApiResponse } from './types/index.js';\n\n// Re-export implementations\nexport { UserRepository } from './repositories/userRepository.js';\nexport { UserService } from './services/userService.js';\nexport { UserHandler } from './handlers/userHandler.js';\n```\n\n### Task 7: Build and Verify\n\n1. Install dependencies: `npm install`\n2. Build: `npm run build`\n3. Remove legacy JS files: `rm src/db.js src/api.js`\n\n## Verification Commands\n\nRun these commands to verify successful implementation:\n\n```bash\n# 1. TypeScript compiles without errors\nnpm run typecheck\necho \"Exit code: $?\"  # Must be 0\n\n# 2. Build produces output\nnpm run build\nls dist/*.js dist/*.d.ts  # Should list compiled files\n\n# 3. No JS files remain in src/\nls src/**/*.js 2>/dev/null && echo \"FAIL: JS files remain\" || echo \"PASS: No JS files\"\n\n# 4. Verify the compiled code works (functional test)\nnode --eval \"\nimport('./dist/index.js').then(m => {\n  const repo = new m.UserRepository();\n  const service = new m.UserService(repo);\n  const handler = new m.UserHandler(service);\n\n  let result;\n  const mockRes = { json: (data) => { result = data; } };\n  handler.handle({ params: { id: '123' } }, mockRes);\n\n  if (result.id === '123' && result.name === 'test') {\n    console.log('PASS: Functional test - output matches expected');\n  } else {\n    console.log('FAIL: Unexpected output', result);\n    process.exit(1);\n  }\n});\n\"\n```\n\n## Success Criteria\n\n| Criteria | Verification |\n|----------|--------------|\n| TypeScript compiles | `npm run typecheck` exits 0 |\n| Three-layer architecture | Files exist in `repositories/`, `services/`, `handlers/` |\n| Types defined | `src/types/index.ts` exports User, IUserRepository, ApiRequest, ApiResponse |\n| No source JS files | `ls src/**/*.js` finds nothing |\n| Compiled output exists | `dist/` contains `.js` and `.d.ts` files |\n| Functional equivalence | Node.js eval test passes |\n",
      "score": {
        "structure": 0,
        "content": 30,
        "quality": 0,
        "total": 30,
        "violations": [
          "Missing ## Goal section",
          "Missing phase organization",
          "Tasks missing checkboxes",
          "Tasks missing Verify sections",
          "Found 9 code blocks outside Verify sections",
          "Task count 0 outside expected range 2-6",
          "Missing expected term: separate",
          "Contains forbidden term: ```typescript"
        ]
      },
      "violations": [
        "Missing ## Goal section",
        "Missing phase organization",
        "Tasks missing checkboxes",
        "Tasks missing Verify sections",
        "Found 9 code blocks outside Verify sections",
        "Task count 0 outside expected range 2-6",
        "Missing expected term: separate",
        "Contains forbidden term: ```typescript"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/js-project",
        "Error: Command failed: ralphie spec --headless --auto --cwd \"/tmp/ralphie-test/js-project\" \"Refactor the existing JavaScript codebase to TypeScript with proper types and separation of concerns between data layer, business logic, and API handlers\"",
        "SPEC.md exists despite error: 6166 bytes"
      ]
    },
    {
      "id": "cli-tool",
      "name": "Greenfield: CLI File Organizer",
      "timestamp": "2026-01-16T18:18:22.306Z",
      "duration_ms": 300322,
      "success": false,
      "spec_created": true,
      "task_count": 16,
      "validation_passed": false,
      "review_passed": false,
      "has_completion_marker": false,
      "spec_content": "# File Organizer CLI\n\nA command-line tool that organizes files into directories based on type, date, or custom rules with full undo support.\n\n## Goal\n\nProvide a simple, safe way to organize messy directories with the confidence that any operation can be reversed.\n\n## Non-Goals\n\n- Recursive directory organization (only top-level files in target directory)\n- File content analysis (organization based on metadata/extension only)\n- Cloud storage integration\n- GUI interface\n- Cross-directory undo (each directory has its own history)\n\n## Technical Decisions\n\n- **Language**: TypeScript with Node.js (>=18.0.0)\n- **CLI Framework**: Commander.js ^12.0.0 (mature, well-documented)\n- **File Operations**: Node.js `fs/promises` API\n- **Pattern Matching**: `minimatch` ^9.0.0 for glob patterns\n- **UUID Generation**: `uuid` ^9.0.0\n- **Testing**: Vitest ^1.0.0 (fast, TypeScript-native)\n\n## Project Structure\n\n```\nfile-organizer/\n├── package.json\n├── tsconfig.json\n├── vitest.config.ts\n├── src/\n│   ├── index.ts              # CLI entry point\n│   ├── types.ts              # Shared TypeScript interfaces\n│   ├── history.ts            # History management\n│   ├── mover.ts              # File moving with logging\n│   ├── commands/\n│   │   ├── organize.ts       # Main organize command\n│   │   ├── undo.ts           # Undo command\n│   │   └── init.ts           # Init command\n│   └── strategies/\n│       ├── by-type.ts        # Type-based organization\n│       ├── by-date.ts        # Date-based organization\n│       └── by-rules.ts       # Rule-based organization\n└── tests/\n    ├── unit/\n    │   ├── history.test.ts\n    │   ├── mover.test.ts\n    │   └── strategies/\n    │       ├── by-type.test.ts\n    │       ├── by-date.test.ts\n    │       └── by-rules.test.ts\n    └── integration/\n        └── cli.test.ts\n```\n\n## Data Structures\n\n### Operation Log Entry\n\n```typescript\ninterface OperationEntry {\n  id: string;           // UUID v4 for this operation\n  timestamp: string;    // ISO 8601 (e.g., \"2024-01-15T10:30:00.000Z\")\n  type: 'move';\n  source: string;       // Absolute path before move\n  destination: string;  // Absolute path after move\n  sessionId: string;    // UUID v4 grouping operations from single command\n}\n```\n\n### Session ID\n\nA `sessionId` groups all file moves from a single `organize` command invocation. This allows:\n- Undoing an entire batch: `organize undo --session <id>`\n- Viewing what happened in a single run\n- Generated once at command start, shared across all moves in that run\n\n### History File (`.file-organizer/history.json`)\n\n```typescript\ninterface HistoryFile {\n  version: 1;\n  operations: OperationEntry[];\n}\n```\n\n**Location**: History is stored per-directory. Running `organize /path/to/dir --by-type` creates `/path/to/dir/.file-organizer/history.json`. Undo only affects that directory.\n\n### Rules File (`.file-organizer/rules.json`)\n\n```typescript\ninterface Rule {\n  name?: string;        // Human-readable rule name (for display only)\n  pattern?: string;     // Glob pattern for filename (e.g., \"report-*.pdf\")\n  ext?: string;         // Extension match (e.g., \".log\") - must include dot\n  dest: string;         // Destination directory (relative to organized dir)\n}\n\ninterface RulesFile {\n  version: 1;\n  rules: Rule[];\n}\n```\n\n**Rule Matching Logic**:\n1. If both `pattern` and `ext` are specified, both must match\n2. If only `pattern`, the glob must match the filename\n3. If only `ext`, the file extension must match exactly (case-insensitive)\n4. First matching rule wins; subsequent rules are not evaluated\n\n## CLI Interface\n\n```\norganize <directory> [options]\n\nCommands:\n  organize <dir>          Organize files in directory\n  organize undo [dir]     Undo previous operations (default: current directory)\n  organize init [dir]     Create .file-organizer/ with default config\n\nOptions:\n  --by-type               Organize by file type/extension\n  --by-date               Organize by modification date\n  --rules                 Organize using custom rules from .file-organizer/rules.json\n  --format <fmt>          Date format: year|month|day (default: month)\n  --dry-run               Show planned moves without executing\n  --interactive, -i       Prompt before each move\n  --verbose, -v           Show detailed progress\n  --include-hidden        Include hidden files (dotfiles)\n  --follow-links          Process symbolic links\n  --on-conflict <action>  Handle duplicates: rename|skip|overwrite (default: rename)\n  --count <n>             For undo: number of operations to reverse (default: all)\n  --session <id>          For undo: reverse all operations from a specific session\n  --help, -h              Show help\n  --version               Show version\n```\n\n### Mutually Exclusive Options\n\n- `--by-type`, `--by-date`, and `--rules` are mutually exclusive. Specifying more than one is an error.\n- `--count` and `--session` for undo are mutually exclusive.\n\n## File Type Categories\n\n| Category    | Extensions                                        |\n|-------------|---------------------------------------------------|\n| documents   | .pdf, .doc, .docx, .txt, .rtf, .odt, .xls, .xlsx, .ppt, .pptx, .csv, .md |\n| images      | .jpg, .jpeg, .png, .gif, .bmp, .svg, .webp, .ico, .tiff, .raw |\n| videos      | .mp4, .avi, .mkv, .mov, .wmv, .flv, .webm, .m4v   |\n| audio       | .mp3, .wav, .flac, .aac, .ogg, .wma, .m4a, .aiff  |\n| archives    | .zip, .tar, .gz, .rar, .7z, .bz2, .xz, .tar.gz, .tgz |\n| code        | .js, .ts, .py, .java, .c, .cpp, .h, .go, .rs, .rb, .php, .swift, .kt |\n| other       | Everything else                                    |\n\n**Extension Matching**: Case-insensitive. `.JPG` and `.jpg` both map to `images`.\n\n## Usage Examples\n\n### Organize by Type\n\n```bash\n# Organize current directory by file type\norganize . --by-type\n\n# Result:\n# report.pdf → documents/report.pdf\n# photo.jpg → images/photo.jpg\n# song.mp3 → audio/song.mp3\n```\n\n### Organize by Date\n\n```bash\n# Organize by month (default)\norganize ~/Downloads --by-date\n\n# Result (for files from March 2024):\n# file.txt → 2024-03/file.txt\n\n# Organize by year\norganize ~/Downloads --by-date --format year\n\n# Result:\n# file.txt → 2024/file.txt\n```\n\n### Organize by Custom Rules\n\n```bash\n# First, initialize and edit rules\norganize init ~/Downloads\n# Edit ~/Downloads/.file-organizer/rules.json\n\n# Then organize\norganize ~/Downloads --rules\n```\n\nExample `rules.json`:\n```json\n{\n  \"version\": 1,\n  \"rules\": [\n    { \"name\": \"Reports\", \"pattern\": \"report-*.pdf\", \"dest\": \"reports\" },\n    { \"name\": \"Logs\", \"ext\": \".log\", \"dest\": \"logs\" },\n    { \"name\": \"Screenshots\", \"pattern\": \"Screenshot*\", \"dest\": \"screenshots\" }\n  ]\n}\n```\n\n### Dry Run\n\n```bash\norganize . --by-type --dry-run\n\n# Output:\n# Would move: report.pdf → documents/report.pdf\n# Would move: photo.jpg → images/photo.jpg\n# Summary: 2 files would be moved\n```\n\n### Undo Operations\n\n```bash\n# Undo all operations in current directory\norganize undo\n\n# Undo last 5 operations\norganize undo --count 5\n\n# Undo specific session\norganize undo --session abc123-def456\n```\n\n## Tasks\n\n### Phase 1: Project Setup & Core Infrastructure\n\n- [ ] Initialize TypeScript CLI project\n  - Create package.json:\n    ```json\n    {\n      \"name\": \"file-organizer\",\n      \"version\": \"1.0.0\",\n      \"type\": \"module\",\n      \"bin\": { \"organize\": \"./dist/index.js\" },\n      \"scripts\": {\n        \"build\": \"tsc\",\n        \"test\": \"vitest run\",\n        \"test:watch\": \"vitest\",\n        \"start\": \"node dist/index.js\"\n      }\n    }\n    ```\n  - TypeScript config: strict mode, ES2022 target, NodeNext module resolution\n  - Install dependencies: `commander@^12.0.0`, `minimatch@^9.0.0`, `uuid@^9.0.0`\n  - Install dev dependencies: `typescript@^5.0.0`, `vitest@^1.0.0`, `@types/node@^20.0.0`, `@types/uuid@^9.0.0`\n  - Create src/index.ts with shebang `#!/usr/bin/env node` and Commander setup\n  - Create src/types.ts with all shared interfaces\n\n  **Acceptance Criteria:**\n  - `npm install` completes without errors\n  - `npm run build` produces dist/index.js\n  - `./dist/index.js --help` displays help text with all commands\n  - `./dist/index.js --version` displays \"1.0.0\"\n\n- [ ] Implement history management module\n  - Create `src/history.ts` with functions:\n    - `getHistoryPath(dir: string): string` - returns path to .file-organizer/history.json\n    - `initHistory(dir: string): Promise<void>` - creates .file-organizer/history.json if missing\n    - `logOperation(dir: string, entry: OperationEntry): Promise<void>` - appends to history\n    - `getHistory(dir: string): Promise<OperationEntry[]>` - returns all operations\n    - `getSessionOperations(dir: string, sessionId: string): Promise<OperationEntry[]>`\n    - `removeOperations(dir: string, ids: string[]): Promise<void>` - removes by ID\n  - Create .file-organizer directory if it doesn't exist\n  - Use atomic writes (write to temp file, then rename) to prevent corruption\n  - Handle concurrent access: read-modify-write with retry on conflict\n\n  **Acceptance Criteria:**\n  - `initHistory()` creates `.file-organizer/history.json` with `{\"version\": 1, \"operations\": []}`\n  - `logOperation()` appends entry, preserving existing operations\n  - `getHistory()` returns operations in insertion order (oldest first)\n  - `getSessionOperations()` filters by sessionId\n  - Calling `getHistory()` on non-existent file returns empty array (no error)\n  - Invalid JSON in history file triggers backup and fresh start\n\n- [ ] Implement file mover with logging\n  - Create `src/mover.ts` with:\n    - `MoveOptions`: `{ conflictStrategy: 'rename' | 'skip' | 'overwrite', sessionId: string, dryRun: boolean }`\n    - `MoveResult`: `{ success: boolean, source: string, destination: string, skipped: boolean, error?: string }`\n    - `moveFile(source: string, dest: string, options: MoveOptions): Promise<MoveResult>`\n  - Conflict resolution for 'rename':\n    - `file.txt` → `file-1.txt` → `file-2.txt` (increment until unique)\n    - Preserve extension: `file.tar.gz` → `file-1.tar.gz`\n  - Create directories as needed with `fs.mkdir(dir, { recursive: true })`\n  - Log each successful move to history (not dry runs)\n  - Use `fs.rename()` for moves within same filesystem, `fs.copyFile()` + `fs.unlink()` for cross-filesystem\n\n  **Acceptance Criteria:**\n  - Moving file creates destination directory if needed\n  - Moving file logs operation to history with correct paths\n  - Conflict with `rename` strategy: `file.txt` → `file-1.txt`\n  - Conflict with `skip` strategy: returns `{ skipped: true }`\n  - Conflict with `overwrite` strategy: replaces existing file\n  - Dry run returns result but doesn't move or log\n  - Cross-filesystem moves work correctly\n\n- [ ] Implement undo command\n  - Create `src/commands/undo.ts`\n  - Read history, process operations in LIFO order (newest first)\n  - Support `--count N` to limit operations reversed\n  - Support `--session <id>` to reverse all operations from a session\n  - Handle missing files gracefully (file may have been deleted or moved again):\n    - Log warning: \"Cannot undo: [dest] no longer exists\"\n    - Continue with next operation\n  - Handle destination already exists (original location occupied):\n    - Apply same conflict resolution as forward moves\n  - Remove successfully undone operations from history\n  - Leave failed undos in history (for retry)\n\n  **Acceptance Criteria:**\n  - `organize undo` moves all files back to original locations (LIFO order)\n  - `organize undo --count 3` reverses exactly 3 most recent operations\n  - `organize undo --session abc123` reverses all operations with that sessionId\n  - Undo of missing file shows warning but continues processing\n  - Undo recreates source directory if it was deleted\n  - Undone operations removed from history.json\n  - Failed undos remain in history\n\n### Phase 2: Organization Strategies\n\n- [ ] Implement type-based organization\n  - Create `src/strategies/by-type.ts`\n  - Export `CATEGORY_MAP: Record<string, string>` mapping extensions to categories\n  - Export `getCategory(filename: string): string` - returns category name\n  - Export `planByType(dir: string, options: PlanOptions): Promise<PlannedMove[]>`\n  - `PlannedMove`: `{ source: string, destination: string }`\n  - Strategy is pure function: reads directory, returns planned moves, doesn't execute\n  - Skip files already in a category directory (e.g., `documents/file.pdf` stays put)\n  - Skip directories (only process files)\n\n  **Acceptance Criteria:**\n  - `report.pdf` → `documents/report.pdf`\n  - `photo.JPG` → `images/photo.JPG` (case-insensitive matching)\n  - `song.mp3` → `audio/song.mp3`\n  - `mystery.xyz` → `other/mystery.xyz`\n  - `documents/existing.pdf` → not moved (already in category)\n  - Empty directory returns empty array\n\n- [ ] Implement date-based organization\n  - Create `src/strategies/by-date.ts`\n  - Read file mtime using `fs.stat()`\n  - Export `planByDate(dir: string, format: 'year' | 'month' | 'day', options: PlanOptions): Promise<PlannedMove[]>`\n  - Format output:\n    - `year`: `2024`\n    - `month`: `2024-03`\n    - `day`: `2024-03-15`\n  - Use local timezone for date formatting\n  - Skip files already in a date directory matching the format\n\n  **Acceptance Criteria:**\n  - File from 2024-03-15 with format `year` → `2024/filename`\n  - File from 2024-03-15 with format `month` → `2024-03/filename`\n  - File from 2024-03-15 with format `day` → `2024-03-15/filename`\n  - File already in `2024-03/` with format `month` → not moved\n  - Uses file's mtime, not ctime or atime\n\n- [ ] Implement rule-based organization\n  - Create `src/strategies/by-rules.ts`\n  - Export `loadRules(dir: string): Promise<Rule[]>` - loads and validates rules.json\n  - Export `matchRule(filename: string, rules: Rule[]): Rule | null` - first match wins\n  - Export `planByRules(dir: string, options: PlanOptions): Promise<PlannedMove[]>`\n  - Glob matching via minimatch with options: `{ nocase: true, dot: false }`\n  - Validation:\n    - Each rule must have `dest` (required)\n    - Each rule must have `pattern` or `ext` or both\n    - `ext` must start with `.`\n\n  **Acceptance Criteria:**\n  - Rule `{\"pattern\": \"report-*.pdf\", \"dest\": \"reports\"}` matches `report-2024.pdf`\n  - Rule `{\"ext\": \".log\", \"dest\": \"logs\"}` matches `app.log` and `APP.LOG`\n  - Rule `{\"pattern\": \"*.pdf\", \"ext\": \".pdf\", \"dest\": \"pdfs\"}` requires both conditions\n  - First matching rule wins when multiple could match\n  - Files with no matching rules are not included in plan\n  - Missing rules.json: error with message \"Rules file not found. Run 'organize init' first.\"\n  - Invalid rules.json: error with specific validation message\n\n- [ ] Implement init command\n  - Create `src/commands/init.ts`\n  - Creates `.file-organizer/` directory\n  - Creates `history.json`: `{\"version\": 1, \"operations\": []}`\n  - Creates `rules.json` with example rules:\n    ```json\n    {\n      \"version\": 1,\n      \"rules\": [\n        { \"name\": \"Example: PDF reports\", \"pattern\": \"report-*.pdf\", \"dest\": \"reports\" },\n        { \"name\": \"Example: Log files\", \"ext\": \".log\", \"dest\": \"logs\" }\n      ]\n    }\n    ```\n  - Print success message with path to created config\n\n  **Acceptance Criteria:**\n  - `organize init` creates `.file-organizer/` in current directory\n  - `organize init /path/to/dir` creates in specified directory\n  - Running init twice: preserves existing files, prints \"Already initialized\"\n  - Created rules.json is valid JSON and can be used immediately\n\n### Phase 3: Safety & UX Features\n\n- [ ] Implement main organize command\n  - Create `src/commands/organize.ts`\n  - Wire up all strategies and options\n  - Generate sessionId at start of command\n  - Validate mutually exclusive options\n  - Execute planned moves through mover\n\n  **Acceptance Criteria:**\n  - `organize . --by-type` organizes by type\n  - `organize . --by-date --format year` organizes by year\n  - `organize . --rules` organizes by rules\n  - `organize . --by-type --by-date` shows error about mutual exclusivity\n  - `organize .` (no strategy) shows error: \"Specify --by-type, --by-date, or --rules\"\n\n- [ ] Implement dry-run mode\n  - Add `--dry-run` flag to organize command\n  - Print planned operations without executing\n  - Format: `Would move: source → destination`\n  - Show summary: \"N files would be moved\"\n  - Color output if terminal supports it (use `process.stdout.isTTY`)\n\n  **Acceptance Criteria:**\n  - `organize . --by-type --dry-run` lists all planned moves\n  - No files are actually moved\n  - No history entries created\n  - Exit code 0 on success\n  - Empty directory: \"No files to organize\"\n\n- [ ] Implement interactive mode\n  - Add `--interactive` / `-i` flag\n  - Prompt for each file using Node.js `readline`\n  - Prompt format: `Move source → dest? [y/n/a/q] `\n  - Keys:\n    - `y` or `Y` or Enter = yes (move this file)\n    - `n` or `N` = no (skip this file)\n    - `a` or `A` = yes to all remaining (stop prompting)\n    - `q` or `Q` = quit (stop processing, keep files already moved)\n  - Show progress: `[3/10] Move ...`\n\n  **Acceptance Criteria:**\n  - Each file prompts for confirmation\n  - Answering `n` skips that file (no history entry)\n  - Answering `a` processes remaining without prompts\n  - Answering `q` stops immediately with summary of what was moved\n  - Invalid input re-prompts\n\n- [ ] Implement verbose mode\n  - Add `--verbose` / `-v` flag\n  - Without verbose: only errors and final summary\n  - With verbose: print each operation as it happens\n  - Format: `Moving: source → dest`\n  - Summary format: `Done: N moved, N skipped, N errors`\n\n  **Acceptance Criteria:**\n  - Default (no verbose): shows only \"Organized N files\" at end\n  - With verbose: each move printed as it happens\n  - Errors always shown regardless of verbose setting\n  - Summary counts match actual results\n\n- [ ] Handle edge cases and special files\n  - Hidden files (starting with `.`):\n    - Skipped by default\n    - `--include-hidden` flag to process them\n  - Symbolic links:\n    - Skipped by default\n    - `--follow-links` to process them\n    - When processing: move the symlink itself, not the target\n  - Permission errors:\n    - Catch EACCES/EPERM errors\n    - Log warning: \"Permission denied: [path]\"\n    - Continue with next file\n    - Increment error count for summary\n  - File in use (EBUSY):\n    - Log warning: \"File in use: [path]\"\n    - Continue with next file\n  - Special files (devices, sockets, FIFOs):\n    - Always skip (check with `stat.isFile()`)\n\n  **Acceptance Criteria:**\n  - `.gitignore` not moved unless `--include-hidden`\n  - `.hidden-photo.jpg` not moved unless `--include-hidden`\n  - Symlinks not moved unless `--follow-links`\n  - Permission denied on one file doesn't stop processing others\n  - Summary shows accurate count of errors\n  - Device files, sockets, etc. are never moved\n\n### Phase 4: Testing & Polish\n\n- [ ] Add unit tests\n  - Create `tests/unit/strategies/by-type.test.ts`:\n    - Test all category mappings\n    - Test case-insensitive matching\n    - Test unknown extensions → other\n  - Create `tests/unit/strategies/by-date.test.ts`:\n    - Test all format options\n    - Test edge cases (year boundaries, leap years)\n  - Create `tests/unit/strategies/by-rules.test.ts`:\n    - Test glob patterns\n    - Test extension matching\n    - Test combined pattern + ext\n    - Test rule priority (first wins)\n  - Create `tests/unit/mover.test.ts`:\n    - Test conflict resolution naming\n    - Test all conflict strategies\n  - Create `tests/unit/history.test.ts`:\n    - Test CRUD operations\n    - Test handling of corrupted files\n\n  **Acceptance Criteria:**\n  - `npm test` runs all tests\n  - Tests cover all file type categories\n  - Tests cover all date formats\n  - Tests cover glob pattern edge cases\n  - Tests use mocked filesystem where appropriate\n\n- [ ] Add integration tests\n  - Create `tests/integration/cli.test.ts`\n  - Use `os.tmpdir()` for test directories\n  - Create real files, run actual CLI commands via child_process\n  - Test scenarios:\n    - By-type organization\n    - By-date organization\n    - By-rules organization\n    - Dry-run (verify no changes)\n    - Undo (verify restoration)\n    - Conflict resolution\n    - Error handling (permission denied)\n  - Clean up temp directories after each test\n\n  **Acceptance Criteria:**\n  - Integration tests use real filesystem\n  - Tests clean up after themselves (no temp file leaks)\n  - Tests cover all major features\n  - Tests run in isolation (no shared state)\n\n- [ ] Final polish\n  - Ensure all error messages are user-friendly\n  - Verify `--help` output is complete and accurate\n  - Add colors to output (use ANSI codes, respect NO_COLOR env var)\n  - Handle Ctrl+C gracefully (complete current operation, then exit)\n  - Verify exit codes are correct for all scenarios\n\n  **Acceptance Criteria:**\n  - All error messages explain what went wrong and how to fix it\n  - `organize --help` documents all commands and options\n  - `organize undo --help` documents undo-specific options\n  - Ctrl+C during operation doesn't corrupt history\n  - Colors disabled when NO_COLOR is set or output is not a TTY\n\n## Error Handling\n\n| Error | Behavior |\n|-------|----------|\n| Directory doesn't exist | Exit code 1: \"Error: Directory '[path]' does not exist\" |\n| Directory is a file | Exit code 1: \"Error: '[path]' is not a directory\" |\n| No organization strategy specified | Exit code 1: \"Error: Specify --by-type, --by-date, or --rules\" |\n| Multiple strategies specified | Exit code 1: \"Error: Options --by-type, --by-date, and --rules are mutually exclusive\" |\n| Permission denied on file | Warning (continue): \"Warning: Permission denied: [path]\" |\n| Destination exists (conflict) | Apply `--on-conflict` strategy (default: rename) |\n| Rules file not found | Exit code 1: \"Error: Rules file not found. Run 'organize init [dir]' first.\" |\n| Rules file invalid JSON | Exit code 1: \"Error: Invalid rules.json: [parse error message]\" |\n| Rules file invalid schema | Exit code 1: \"Error: Invalid rule at index N: [validation message]\" |\n| History file corrupted | Backup to `history.json.bak`, create fresh history, warn user |\n| No files to organize | Exit code 0: \"No files to organize\" |\n| Undo with no history | Exit code 0: \"Nothing to undo\" |\n| Undo file missing | Warning (continue): \"Warning: Cannot undo '[path]': file no longer exists\" |\n\n## Exit Codes\n\n| Code | Meaning |\n|------|---------|\n| 0    | Success (including \"nothing to do\" scenarios) |\n| 1    | Error (invalid args, missing directory, invalid config) |\n| 2    | Partial success (some files failed, some succeeded) |\n\n## Security Considerations\n\n- Never follow symlinks outside the target directory (prevent traversal attacks)\n- Validate all paths are within the target directory before operations\n- Don't execute or read file contents (only metadata operations)\n- Sanitize rule destinations to prevent path traversal (`../` sequences)\n",
      "score": {
        "structure": 30,
        "content": 30,
        "quality": 0,
        "total": 60,
        "violations": [
          "Tasks missing Verify sections",
          "Found 13 code blocks outside Verify sections",
          "Task count 16 outside expected range 3-7",
          "Contains forbidden term: npm install",
          "Contains forbidden term: ```"
        ]
      },
      "violations": [
        "Tasks missing Verify sections",
        "Found 13 code blocks outside Verify sections",
        "Task count 16 outside expected range 3-7",
        "Contains forbidden term: npm install",
        "Contains forbidden term: ```"
      ],
      "notes": [
        "Setup: /tmp/ralphie-test/file-organizer",
        "Error: spawnSync /bin/sh ETIMEDOUT",
        "SPEC.md exists despite error: 22724 bytes"
      ]
    }
  ],
  "summary": {
    "total": 6,
    "passed": 0,
    "failed": 6,
    "avg_score": 56.8,
    "avg_duration_ms": 268466
  }
}